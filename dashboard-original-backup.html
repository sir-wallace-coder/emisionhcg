<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Dashboard - Sistema Completo CFDI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8f9fa; 
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.8rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { transform: translateY(-1px); }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
        }
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: white;
            color: #007bff;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            min-height: 400px;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close:hover {
            color: #000;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .quick-action {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
            text-decoration: none;
            color: inherit;
        }
        .quick-action:hover {
            transform: translateY(-2px);
            text-decoration: none;
            color: inherit;
        }
        .quick-action-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .quick-action-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Estilos para folio editable */
        .folio-editable {
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
            transition: all 0.3s ease;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .folio-editable:hover {
            background-color: #e3f2fd;
            color: #0056b3;
            transform: scale(1.05);
        }
        
        /* Mejoras en la tabla */
        .table th:first-child {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .table td:first-child {
            background-color: #fafbfc;
        }
        
        /* Tooltips mejorados para botones */
        .btn[title] {
            position: relative;
        }
        
        .btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            animation: fadeInTooltip 0.3s ease forwards;
            max-width: 250px;
            text-align: center;
            line-height: 1.3;
        }
        
        .btn[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(2px);
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
            opacity: 0;
            animation: fadeInTooltip 0.3s ease forwards;
        }
        
        @keyframes fadeInTooltip {
            from { opacity: 0; transform: translateX(-50%) translateY(5px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Estilos para estados de XML */
        .badge-generado { background-color: #28a745; }
        .badge-importado { background-color: #17a2b8; }
        .badge-sellado { background-color: #6f42c1; }
        .badge-timbrado { background-color: #fd7e14; }
        .badge-cancelado { background-color: #dc3545; }
        
        /* Mejoras visuales para la tabla */
        .table tbody tr:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        /* Modal mejorado para ver XML */
        .modal-content pre {
            font-family: 'Courier New', monospace;
            background-color: #2d3748;
            color: #e2e8f0;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
        }
        
        /* Estilos para el editor de XML */
        .xml-editor-form {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .form-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-section h3 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
            font-size: 1.2em;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .concepto-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .totales-display {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        
        .total-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .total-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .total-item label {
            font-weight: 600;
            color: #495057;
        }
        
        .total-item span {
            color: #28a745;
            font-weight: bold;
        }
        
        /* Responsive design para el editor */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .modal-content {
                max-width: 95% !important;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üìä Dashboard - Sistema Completo CFDI</h1>
            <div class="user-info">
                <span id="userName">Cargando...</span>
                <a href="/generator" class="btn btn-success">üöÄ Generar CFDI</a>
                <button onclick="logout()" class="btn btn-danger">üö™ Salir</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Acciones R√°pidas -->
        <div class="quick-actions">
            <a href="/generator" class="quick-action">
                <div class="quick-action-icon">üöÄ</div>
                <div class="quick-action-title">Generar CFDI</div>
            </a>
            <a href="#" onclick="openImportXMLModal()" class="quick-action">
                <div class="quick-action-icon">üìÅ</div>
                <div class="quick-action-title">Importar XML</div>
            </a>
            <a href="#" onclick="openEmisorModal()" class="quick-action">
                <div class="quick-action-icon">üè¢</div>
                <div class="quick-action-title">Nuevo Emisor</div>
            </a>
            <a href="#" onclick="showTab('xmls')" class="quick-action">
                <div class="quick-action-icon">üìÑ</div>
                <div class="quick-action-title">Ver XMLs</div>
            </a>
            <a href="#" onclick="showTab('emisores')" class="quick-action">
                <div class="quick-action-icon">‚öôÔ∏è</div>
                <div class="quick-action-title">Gestionar Emisores</div>
            </a>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalXmls">0</div>
                <div class="stat-label">XMLs Generados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEmisores">0</div>
                <div class="stat-label">Emisores Registrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="xmlsEsteMes">0</div>
                <div class="stat-label">XMLs Este Mes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="emisoresActivos">0</div>
                <div class="stat-label">Emisores Activos</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab" onclick="showTab('xmls')">üìÑ XMLs Generados</div>
            <div class="tab" onclick="showTab('emisores')">üë§ Emisores</div>
            <div class="tab" onclick="showTab('estadisticas')">üìä Estad√≠sticas</div>
            <div class="tab" onclick="showTab('logs')">üìã Logs del Sistema</div>
        </div>

        <div class="tab-content">
            <!-- Tab XMLs -->
            <div id="xmlsTab" class="tab-pane active">
                <div class="actions">
                    <a href="/generator" class="btn btn-primary">‚ûï Generar Nuevo XML</a>
                </div>
                
                <!-- Filtros y B√∫squeda -->
                <div class="filters-section" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">üîç Filtros y B√∫squeda</h4>
                    
                    <!-- Filtros por Fecha -->
                    <div class="form-row" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Per√≠odo</label>
                            <select id="filtroFecha" onchange="aplicarFiltros()">
                                <option value="todos" selected>üìÑ Todos los comprobantes</option>
                                <option value="hoy">üìÖ Hoy</option>
                                <option value="esta_semana">üìÜ Esta semana</option>
                                <option value="este_mes">üìä Este mes</option>
                                <option value="mes_anterior">üìã Mes anterior</option>
                                <option value="ultimos_3_meses">üìà √öltimos 3 meses</option>
                                <option value="este_ano">üóìÔ∏è Este a√±o</option>
                                <option value="personalizado">üéØ Rango personalizado</option>
                            </select>
                        </div>
                        <div class="form-group" id="rangoPersonalizado" style="display: none;">
                            <label>Desde</label>
                            <input type="date" id="fechaDesde" onchange="aplicarFiltros()">
                        </div>
                        <div class="form-group" id="rangoPersonalizadoHasta" style="display: none;">
                            <label>Hasta</label>
                            <input type="date" id="fechaHasta" onchange="aplicarFiltros()">
                        </div>
                    </div>
                    
                    <!-- B√∫squeda por Campos -->
                    <div class="form-row" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Buscar por</label>
                            <select id="tipoBusqueda">
                                <option value="folio">Folio</option>
                                <option value="serie">Serie</option>
                                <option value="uuid">UUID</option>
                                <option value="emisor_rfc">RFC Emisor</option>
                                <option value="receptor_rfc">RFC Receptor</option>
                                <option value="emisor_nombre">Nombre Emisor</option>
                                <option value="receptor_nombre">Nombre Receptor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>T√©rmino de b√∫squeda</label>
                            <input type="text" id="terminoBusqueda" placeholder="Ingrese t√©rmino..." onkeyup="buscarEnTiempoReal()">
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select id="filtroEstado" onchange="aplicarFiltros()">
                                <option value="todos">Todos los estados</option>
                                <option value="generado">Generado</option>
                                <option value="sellado">Sellado</option>
                                <option value="timbrado">Timbrado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Filtros Adicionales -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Versi√≥n CFDI</label>
                            <select id="filtroVersion" onchange="aplicarFiltros()">
                                <option value="todas">Todas las versiones</option>
                                <option value="4.0">CFDI 4.0</option>
                                <option value="3.3">CFDI 3.3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Emisor</label>
                            <select id="filtroEmisor" onchange="aplicarFiltros()">
                                <option value="todos">Todos los emisores</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rango de Total</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="totalMinimo" placeholder="M√≠n" step="0.01" onchange="aplicarFiltros()" style="width: 50%;">
                                <input type="number" id="totalMaximo" placeholder="M√°x" step="0.01" onchange="aplicarFiltros()" style="width: 50%;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="actions" style="margin-top: 15px;">
                        <button onclick="limpiarFiltros()" class="btn btn-secondary">üßπ Limpiar Filtros</button>
                        <button onclick="exportarXMLs()" class="btn btn-success">üìä Exportar Resultados</button>
                        <span id="contadorResultados" style="margin-left: 15px; color: #6c757d;"></span>
                    </div>
                </div>
                
                <div id="xmlsContent" class="loading">
                    Cargando XMLs...
                </div>
            </div>

            <!-- Tab Emisores -->
            <div id="emisoresTab" class="tab-pane">
                <div class="actions">
                    <button onclick="showEmisorModal()" class="btn btn-primary">‚ûï Agregar Emisor</button>
                </div>
                <div id="emisoresContent" class="loading">
                    Cargando emisores...
                </div>
            </div>

            <!-- Tab Estad√≠sticas -->
            <div id="estadisticasTab" class="tab-pane">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üìä Resumen General</h3>
                        <p>Total XMLs: <span id="totalXMLsCount">0</span></p>
                        <p>Emisores: <span id="totalEmisoresCount">0</span></p>
                        <p>Este mes: <span id="xmlsThisMonthCount">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Tab Logs del Sistema -->
            <div id="logsTab" class="tab-pane">
                <div class="logs-header">
                    <h3>üìã Logs del Sistema</h3>
                    <div class="logs-controls">
                        <div class="logs-filters">
                            <select id="logLevelFilter" onchange="filterLogs()">
                                <option value="all">üîç Todos los niveles</option>
                                <option value="info">‚ÑπÔ∏è Info</option>
                                <option value="success">‚úÖ Success</option>
                                <option value="warning">‚ö†Ô∏è Warning</option>
                                <option value="error">‚ùå Error</option>
                            </select>
                            <input type="text" id="logSearchInput" placeholder="üîç Buscar en logs..." oninput="filterLogs()">
                        </div>
                        <div class="logs-actions">
                            <button onclick="clearLogs()" class="btn btn-secondary">üóëÔ∏è Limpiar</button>
                            <button onclick="exportLogs()" class="btn btn-primary">üì• Exportar</button>
                            <button onclick="refreshLogs()" class="btn btn-success">üîÑ Actualizar</button>
                        </div>
                    </div>
                </div>
                
                <div class="logs-container">
                    <div id="logsContent" class="logs-list">
                        <!-- Los logs se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
                
                <div class="logs-footer">
                    <div class="logs-stats">
                        <span id="logsCount">0 logs</span> | 
                        <span id="logsFiltered">0 filtrados</span> | 
                        <label>
                            <input type="checkbox" id="autoScrollLogs" checked> 
                            üìú Auto-scroll
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Emisor -->
    <div id="emisorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="emisorModalTitle">Agregar Emisor</h2>
                <span class="close" onclick="closeEmisorModal()">&times;</span>
            </div>
            <form id="emisorForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorRfc">RFC *</label>
                        <input type="text" id="emisorRfc" required maxlength="13">
                    </div>
                    <div class="form-group">
                        <label for="emisorNombre">Nombre/Raz√≥n Social *</label>
                        <input type="text" id="emisorNombre" required maxlength="300">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorCodigoPostal">C√≥digo Postal *</label>
                        <input type="text" id="emisorCodigoPostal" required maxlength="5" pattern="[0-9]{5}">
                    </div>
                    <div class="form-group">
                        <label for="emisorRegimenFiscal">R√©gimen Fiscal *</label>
                        <select id="emisorRegimenFiscal" required>
                            <option value="">Seleccionar r√©gimen</option>
                            <option value="601">601 - General de Ley Personas Morales</option>
                            <option value="612">612 - Personas F√≠sicas con Actividades Empresariales</option>
                            <option value="621">621 - Incorporaci√≥n Fiscal</option>
                            <option value="626">626 - R√©gimen Simplificado de Confianza</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="certificadoCer">Certificado (.cer)</label>
                    <input type="file" id="certificadoCer" accept=".cer">
                </div>
                <div class="form-group">
                    <label for="certificadoKey">Llave Privada (.key)</label>
                    <input type="file" id="certificadoKey" accept=".key">
                </div>
                <div class="form-group">
                    <label for="passwordKey">Contrase√±a del Certificado</label>
                    <input type="password" id="passwordKey">
                </div>
                <div class="actions">
                    <button type="button" onclick="closeEmisorModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Ver XML -->
    <div id="xmlModal" class="modal">
        <div class="modal-content" style="max-width: 80%; max-height: 80%;">
            <div class="modal-header">
                <h2>üìÑ Ver XML CFDI</h2>
                <span class="close" onclick="cerrarModalXML()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="xmlInfo" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                <pre id="xmlContent" style="background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;"></pre>
            </div>
            <div class="modal-footer">
                <button onclick="cerrarModalXML()" class="btn btn-secondary">Cerrar</button>
                <button onclick="copiarXMLActual()" class="btn btn-info">üìã Copiar</button>
                <button onclick="descargarXMLActual()" class="btn btn-primary">üì• Descargar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Importar XML -->
    <div id="importXMLModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÅ Importar XML CFDI</h2>
                <span class="close" onclick="closeImportXMLModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="importXMLFile">Seleccionar archivo XML:</label>
                    <input type="file" id="importXMLFile" accept=".xml" class="form-control">
                    <small class="form-text">Solo archivos XML de CFDI 3.3 o 4.0 (m√°ximo 5MB)</small>
                </div>
                
                <div id="importXMLResult"></div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-success" onclick="importarXML()">üìÅ Importar y Validar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeImportXMLModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== SISTEMA CFDI PROFESIONAL - GESTI√ìN DE EMISORES =====
        
        // Variables globales del sistema
        let currentUser = null;
        let xmls = [];
        let emisores = [];
        let editingEmisorId = null;
        let isAuthenticated = false;
        
        // Funci√≥n principal para abrir modal de emisor (CFDI Expert Implementation)
        function openEmisorModal(emisorId = null) {
            console.log('üîê CFDI SYSTEM: Iniciando apertura de modal emisor');
            console.log('üìã Emisor ID:', emisorId || 'NUEVO');
            
            try {
                // 1. Verificar autenticaci√≥n
                const token = localStorage.getItem('cfdi_token');
                if (!token) {
                    console.warn('‚ö†Ô∏è Usuario no autenticado, redirigiendo...');
                    showAuthAlert();
                    return false;
                }
                
                // 2. Verificar elementos DOM
                const modal = document.getElementById('emisorModal');
                const form = document.getElementById('emisorForm');
                const title = document.getElementById('emisorModalTitle');
                
                if (!modal || !form || !title) {
                    console.error('‚ùå Elementos DOM faltantes:', { modal: !!modal, form: !!form, title: !!title });
                    showSystemError('Elementos del modal no encontrados');
                    return false;
                }
                
                // 3. Configurar modal seg√∫n modo (nuevo/editar)
                editingEmisorId = emisorId;
                
                if (emisorId) {
                    // Modo edici√≥n
                    title.textContent = 'Editar Emisor';
                    loadEmisorData(emisorId);
                } else {
                    // Modo nuevo
                    title.textContent = 'Registrar Nuevo Emisor';
                    resetEmisorForm();
                }
                
                // 4. Mostrar modal con animaci√≥n
                modal.style.display = 'block';
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.style.transition = 'opacity 0.3s ease';
                }, 10);
                
                // 5. Focus en primer campo
                const firstInput = form.querySelector('input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
                
                console.log('‚úÖ Modal de emisor abierto exitosamente');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en openEmisorModal:', error);
                showSystemError('Error al abrir modal: ' + error.message);
                return false;
            }
        }
        
        // Funci√≥n para mostrar alerta de autenticaci√≥n
        function showAuthAlert() {
            const alertMsg = `üîê ACCESO REQUERIDO\n\n` +
                           `Para gestionar emisores necesitas estar autenticado.\n\n` +
                           `Credenciales de acceso:\n` +
                           `‚Ä¢ Usuario: admin@sistema.com\n` +
                           `‚Ä¢ Contrase√±a: password\n\n` +
                           `¬øDeseas ir al login ahora?`;
                           
            if (confirm(alertMsg)) {
                window.location.href = '/login';
            }
        }
        
        // Funci√≥n para mostrar errores del sistema
        function showSystemError(message) {
            const errorMsg = `‚ùå ERROR DEL SISTEMA CFDI\n\n${message}\n\nPor favor, refresca la p√°gina e intenta nuevamente.`;
            alert(errorMsg);
        }
        
        // Funci√≥n para resetear formulario de emisor
        function resetEmisorForm() {
            const form = document.getElementById('emisorForm');
            if (form) {
                form.reset();
                // Limpiar archivos subidos
                const fileInputs = form.querySelectorAll('input[type="file"]');
                fileInputs.forEach(input => input.value = '');
            }
        }
        
        // Funci√≥n para cargar datos de emisor (modo edici√≥n)
        function loadEmisorData(emisorId) {
            const emisor = emisores.find(e => e.id === emisorId);
            if (emisor) {
                document.getElementById('emisorRfc').value = emisor.rfc || '';
                document.getElementById('emisorNombre').value = emisor.nombre || '';
                document.getElementById('emisorCodigoPostal').value = emisor.codigo_postal || '';
                document.getElementById('emisorRegimenFiscal').value = emisor.regimen_fiscal || '';
            }
        }
        
        // Funci√≥n para cerrar modal de emisor
        function closeEmisorModal() {
            const modal = document.getElementById('emisorModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    editingEmisorId = null;
                }, 300);
            }
        }
        
        // ===== VALIDACIONES CFDI PROFESIONALES =====
        
        // Funci√≥n para validar RFC seg√∫n reglas SAT
        function validateRFC(rfc) {
            if (!rfc) return { valid: false, message: 'RFC es requerido' };
            
            // Limpiar RFC
            rfc = rfc.toUpperCase().trim();
            
            // Validar formato b√°sico
            const rfcPattern = /^[A-Z√ë&]{3,4}[0-9]{6}[A-Z0-9]{3}$/;
            if (!rfcPattern.test(rfc)) {
                return { valid: false, message: 'Formato de RFC inv√°lido' };
            }
            
            return { valid: true, rfc: rfc };
        }
        
        // Funci√≥n para validar c√≥digo postal mexicano
        function validateCodigoPostal(cp) {
            if (!cp) return { valid: false, message: 'C√≥digo postal es requerido' };
            
            const cpPattern = /^[0-9]{5}$/;
            if (!cpPattern.test(cp)) {
                return { valid: false, message: 'C√≥digo postal debe tener 5 d√≠gitos' };
            }
            
            return { valid: true, cp: cp };
        }
        
        // ===== MANEJO DE FORMULARIO EMISOR =====
        
        // Event listener para env√≠o de formulario
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('emisorForm');
            if (form) {
                form.addEventListener('submit', handleEmisorSubmit);
            }
        });
        
        // Funci√≥n principal para manejar env√≠o de formulario emisor
        async function handleEmisorSubmit(event) {
            event.preventDefault();
            console.log('üìù CFDI SYSTEM: Procesando formulario de emisor');
            
            try {
                // 1. Obtener datos del formulario
                const formData = getEmisorFormData();
                
                // 2. Validar datos con errores detallados
                const validation = validateEmisorData(formData);
                if (!validation.valid) {
                    showValidationError(
                        validation.message,
                        validation.errorType,
                        validation.details
                    );
                    return;
                }
                
                // 3. Mostrar indicador de carga
                showLoadingState(true);
                
                // 4. Enviar datos al servidor
                const result = await submitEmisorData(formData);
                
                if (result.success) {
                    showSuccessMessage(result.message || 'Emisor guardado exitosamente');
                    closeEmisorModal();
                    await refreshEmisorList();
                } else {
                    // Mostrar error detallado con tipo y detalles
                    showValidationError(
                        result.message || 'Error al guardar emisor',
                        result.errorType,
                        result.details
                    );
                }
                
            } catch (error) {
                console.error('‚ùå Error en handleEmisorSubmit:', error);
                showSystemError('Error al procesar formulario: ' + error.message);
            } finally {
                showLoadingState(false);
            }
        }
        
        // Funci√≥n para obtener datos del formulario
        function getEmisorFormData() {
            return {
                rfc: document.getElementById('emisorRfc').value.trim(),
                nombre: document.getElementById('emisorNombre').value.trim(),
                codigoPostal: document.getElementById('emisorCodigoPostal').value.trim(),
                regimenFiscal: document.getElementById('emisorRegimenFiscal').value,
                certificadoCer: document.getElementById('certificadoCer').files[0],
                certificadoKey: document.getElementById('certificadoKey').files[0],
                passwordKey: document.getElementById('passwordKey').value
            };
        }
        
        // Funci√≥n para validar datos del emisor con errores detallados
        function validateEmisorData(data) {
            console.log('üîç CFDI SYSTEM: Validando datos del emisor...');
            
            // Validar RFC
            const rfcValidation = validateRFC(data.rfc);
            if (!rfcValidation.valid) {
                return { 
                    valid: false, 
                    message: rfcValidation.message,
                    errorType: 'VALIDATION_ERROR',
                    details: 'Verifique que el RFC tenga el formato correcto (3-4 letras + 6 d√≠gitos + 3 caracteres)'
                };
            }
            
            // Validar nombre
            if (!data.nombre || data.nombre.length < 3) {
                return { 
                    valid: false, 
                    message: 'Nombre/Raz√≥n Social debe tener al menos 3 caracteres',
                    errorType: 'VALIDATION_ERROR',
                    details: 'El nombre o raz√≥n social es obligatorio y debe ser descriptivo'
                };
            }
            
            // Validar c√≥digo postal
            const cpValidation = validateCodigoPostal(data.codigoPostal);
            if (!cpValidation.valid) {
                return { 
                    valid: false, 
                    message: cpValidation.message,
                    errorType: 'VALIDATION_ERROR',
                    details: 'El c√≥digo postal debe ser un n√∫mero de 5 d√≠gitos v√°lido en M√©xico'
                };
            }
            
            // Validar r√©gimen fiscal
            if (!data.regimenFiscal) {
                return { 
                    valid: false, 
                    message: 'R√©gimen fiscal es requerido',
                    errorType: 'VALIDATION_ERROR',
                    details: 'Debe seleccionar un r√©gimen fiscal del cat√°logo SAT'
                };
            }
            
            // Validaci√≥n detallada de certificados CSD
            if (data.certificadoCer || data.certificadoKey || data.passwordKey) {
                console.log('üîê Validando certificados CSD...');
                
                // Validar que se proporcionen todos los archivos CSD
                if (!data.certificadoCer) {
                    return {
                        valid: false,
                        message: 'Archivo de certificado (.cer) faltante',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: 'Debe seleccionar el archivo .cer del certificado de sello digital'
                    };
                }
                
                if (!data.certificadoKey) {
                    return {
                        valid: false,
                        message: 'Archivo de llave privada (.key) faltante',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: 'Debe seleccionar el archivo .key de la llave privada del certificado'
                    };
                }
                
                if (!data.passwordKey) {
                    return {
                        valid: false,
                        message: 'Contrase√±a del certificado requerida',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: 'Debe ingresar la contrase√±a para desencriptar la llave privada'
                    };
                }
                
                // Validar extensiones de archivos
                if (!data.certificadoCer.name.toLowerCase().endsWith('.cer')) {
                    return {
                        valid: false,
                        message: 'Archivo de certificado inv√°lido',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: `El archivo seleccionado "${data.certificadoCer.name}" no tiene extensi√≥n .cer`
                    };
                }
                
                if (!data.certificadoKey.name.toLowerCase().endsWith('.key')) {
                    return {
                        valid: false,
                        message: 'Archivo de llave privada inv√°lido',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: `El archivo seleccionado "${data.certificadoKey.name}" no tiene extensi√≥n .key`
                    };
                }
                
                // Validar tama√±os de archivos
                if (data.certificadoCer.size > 10 * 1024 * 1024) {
                    return {
                        valid: false,
                        message: 'Archivo de certificado demasiado grande',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: `El archivo .cer (${(data.certificadoCer.size / 1024 / 1024).toFixed(2)}MB) excede el l√≠mite de 10MB`
                    };
                }
                
                if (data.certificadoKey.size > 10 * 1024 * 1024) {
                    return {
                        valid: false,
                        message: 'Archivo de llave privada demasiado grande',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: `El archivo .key (${(data.certificadoKey.size / 1024 / 1024).toFixed(2)}MB) excede el l√≠mite de 10MB`
                    };
                }
                
                // Validar contrase√±a
                if (data.passwordKey.length < 4) {
                    return {
                        valid: false,
                        message: 'Contrase√±a del certificado muy corta',
                        errorType: 'CSD_PROCESSING_ERROR',
                        details: 'La contrase√±a debe tener al menos 4 caracteres'
                    };
                }
                
                console.log('‚úÖ Validaci√≥n inicial de CSD exitosa');
            }
            
            console.log('‚úÖ Validaci√≥n de datos completada');
            return { valid: true };
        }
        
        // Funci√≥n para enviar datos al servidor con manejo de errores detallado
        async function submitEmisorData(formData) {
            console.log('üìù CFDI SYSTEM: Enviando datos del emisor...');
            
            try {
                // Para modo desarrollo, guardar en localStorage
                const emisorData = {
                    id: editingEmisorId || 'emisor-' + Date.now(),
                    rfc: formData.rfc.toUpperCase(),
                    nombre: formData.nombre,
                    codigo_postal: formData.codigoPostal,
                    regimen_fiscal: formData.regimenFiscal,
                    fecha_creacion: new Date().toISOString(),
                    tiene_csd: !!(formData.certificadoCer && formData.certificadoKey && formData.passwordKey)
                };
                
                // Procesar certificados CSD si se proporcionan
                if (formData.certificadoCer && formData.certificadoKey && formData.passwordKey) {
                    console.log('üîê Procesando certificados CSD...');
                    
                    try {
                        const csdResult = await processCSDCertificates(
                            formData.certificadoCer,
                            formData.certificadoKey,
                            formData.passwordKey
                        );
                        
                        if (csdResult.success) {
                            emisorData.certificado_numero = csdResult.certificateNumber;
                            emisorData.certificado_vigencia_inicio = csdResult.validFrom;
                            emisorData.certificado_vigencia_fin = csdResult.validTo;
                            emisorData.certificado_cer = csdResult.certificatePem;
                            emisorData.certificado_key = csdResult.privateKeyPem;
                            console.log('‚úÖ Certificados CSD procesados exitosamente');
                        } else {
                            return {
                                success: false,
                                message: `Error procesando certificados CSD: ${csdResult.error}`,
                                errorType: 'CSD_PROCESSING_ERROR',
                                details: csdResult.details || 'Verifique que los archivos .cer y .key sean v√°lidos y la contrase√±a sea correcta'
                            };
                        }
                    } catch (csdError) {
                        console.error('‚ùå Error procesando CSD:', csdError);
                        return {
                            success: false,
                            message: 'Error cr√≠tico procesando certificados CSD',
                            errorType: 'CSD_CRITICAL_ERROR',
                            details: csdError.message || 'Error interno procesando certificados'
                        };
                    }
                }
                
                // Guardar en localStorage
                const emisoresGuardados = JSON.parse(localStorage.getItem('cfdi_emisores') || '[]');
                
                if (editingEmisorId) {
                    // Editar emisor existente
                    const index = emisoresGuardados.findIndex(e => e.id === editingEmisorId);
                    if (index !== -1) {
                        emisoresGuardados[index] = { ...emisoresGuardados[index], ...emisorData };
                    }
                } else {
                    // Verificar RFC √∫nico
                    const rfcExistente = emisoresGuardados.find(e => e.rfc === emisorData.rfc);
                    if (rfcExistente) {
                        return {
                            success: false,
                            message: 'RFC ya registrado',
                            errorType: 'RFC_DUPLICATE_ERROR',
                            details: `El RFC ${emisorData.rfc} ya est√° registrado en el sistema`
                        };
                    }
                    
                    // Agregar nuevo emisor
                    emisoresGuardados.push(emisorData);
                }
                
                localStorage.setItem('cfdi_emisores', JSON.stringify(emisoresGuardados));
                
                console.log('‚úÖ Emisor guardado exitosamente:', emisorData.rfc);
                
                return {
                    success: true,
                    data: emisorData,
                    message: `Emisor ${emisorData.rfc} guardado exitosamente`
                };
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico guardando emisor:', error);
                return {
                    success: false,
                    message: 'Error cr√≠tico del sistema',
                    errorType: 'SYSTEM_CRITICAL_ERROR',
                    details: error.message || 'Error interno del sistema'
                };
            }
        }
        
        // Funci√≥n para procesar certificados CSD con validaci√≥n detallada
        async function processCSDCertificates(cerFile, keyFile, password) {
            console.log('üîç Validando certificados CSD...');
            
            try {
                // Validar archivos
                if (!cerFile || !keyFile) {
                    return {
                        success: false,
                        error: 'Archivos de certificado faltantes',
                        details: 'Debe proporcionar tanto el archivo .cer como el .key'
                    };
                }
                
                // Validar extensiones
                if (!cerFile.name.toLowerCase().endsWith('.cer')) {
                    return {
                        success: false,
                        error: 'Archivo de certificado inv√°lido',
                        details: 'El archivo de certificado debe tener extensi√≥n .cer'
                    };
                }
                
                if (!keyFile.name.toLowerCase().endsWith('.key')) {
                    return {
                        success: false,
                        error: 'Archivo de llave privada inv√°lido',
                        details: 'El archivo de llave privada debe tener extensi√≥n .key'
                    };
                }
                
                // Validar tama√±os
                if (cerFile.size > 10 * 1024 * 1024) { // 10MB
                    return {
                        success: false,
                        error: 'Archivo de certificado demasiado grande',
                        details: 'El archivo .cer no debe exceder 10MB'
                    };
                }
                
                if (keyFile.size > 10 * 1024 * 1024) { // 10MB
                    return {
                        success: false,
                        error: 'Archivo de llave privada demasiado grande',
                        details: 'El archivo .key no debe exceder 10MB'
                    };
                }
                
                // Validar contrase√±a
                if (!password || password.length < 4) {
                    return {
                        success: false,
                        error: 'Contrase√±a inv√°lida',
                        details: 'La contrase√±a debe tener al menos 4 caracteres'
                    };
                }
                
                // Leer archivos como base64
                const cerBase64 = await fileToBase64(cerFile);
                const keyBase64 = await fileToBase64(keyFile);
                
                // Simular procesamiento de certificados (en modo desarrollo)
                // En producci√≥n, aqu√≠ se har√≠a la validaci√≥n real con node-forge
                const mockCertificateNumber = 'CSD' + Date.now().toString().slice(-8);
                const now = new Date();
                const validFrom = now.toISOString();
                const validTo = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000)).toISOString(); // 1 a√±o
                
                console.log('‚úÖ Certificados CSD validados exitosamente');
                
                return {
                    success: true,
                    certificateNumber: mockCertificateNumber,
                    validFrom: validFrom,
                    validTo: validTo,
                    certificatePem: cerBase64,
                    privateKeyPem: keyBase64
                };
                
            } catch (error) {
                console.error('‚ùå Error procesando certificados:', error);
                return {
                    success: false,
                    error: 'Error procesando certificados',
                    details: error.message || 'Error interno procesando archivos CSD'
                };
            }
        }
        
        // Funciones de UI
        function showLoadingState(show) {
            const submitBtn = document.querySelector('#emisorForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = show;
                submitBtn.textContent = show ? 'Guardando...' : 'Guardar';
            }
        }
        
        // Funci√≥n mejorada para mostrar errores detallados
        function showValidationError(message, errorType = null, details = null) {
            let errorMessage = `‚ùå ERROR DE VALIDACI√ìN\n\n${message}`;
            
            if (errorType) {
                const errorTypeNames = {
                    'CSD_PROCESSING_ERROR': 'üîê Error de Certificados CSD',
                    'CSD_CRITICAL_ERROR': '‚ùå Error Cr√≠tico de CSD',
                    'RFC_DUPLICATE_ERROR': 'üîÑ RFC Duplicado',
                    'SYSTEM_CRITICAL_ERROR': '‚ö†Ô∏è Error del Sistema',
                    'VALIDATION_ERROR': 'üìù Error de Validaci√≥n'
                };
                
                errorMessage = `${errorTypeNames[errorType] || '‚ùå Error'}\n\n${message}`;
            }
            
            if (details) {
                errorMessage += `\n\nüìù Detalles:\n${details}`;
            }
            
            // Agregar sugerencias seg√∫n el tipo de error
            if (errorType === 'CSD_PROCESSING_ERROR') {
                errorMessage += `\n\nüí° Sugerencias:\n` +
                              `‚Ä¢ Verifique que los archivos .cer y .key sean v√°lidos\n` +
                              `‚Ä¢ Confirme que la contrase√±a sea correcta\n` +

                              `‚Ä¢ Verifique que el certificado y la llave coincidan`;
            } else if (errorType === 'RFC_DUPLICATE_ERROR') {
                errorMessage += `\n\nüí° Sugerencias:\n` +
                              `‚Ä¢ Use un RFC diferente\n` +
                              `‚Ä¢ Verifique si ya existe un emisor con este RFC\n` +
                              `‚Ä¢ Edite el emisor existente en lugar de crear uno nuevo`;
            }
            
            alert(errorMessage);
            
            // Log detallado para debugging
            console.error('üö® Error detallado:', {
                message,
                errorType,
                details,
                timestamp: new Date().toISOString()
            });
        }
        
        function showSuccessMessage(message) {
            alert(`‚úÖ √âXITO\n\n${message}`);
        }
        
        // Funci√≥n para refrescar lista de emisores
        async function refreshEmisorList() {
            console.log('üîÑ CFDI SYSTEM: Refrescando lista de emisores...');
            try {
                // Cargar emisores desde localStorage
                await loadLocalEmisores();
                
                // Actualizar UI
                renderEmisores();
                updateStats();
                cargarEmisoresEnFiltro();
                
                console.log('‚úÖ Lista de emisores refrescada exitosamente');
            } catch (error) {
                console.error('‚ùå Error refrescando emisores:', error);
                showValidationError(
                    'Error cargando lista de emisores',
                    'SYSTEM_ERROR',
                    error.message
                );
            }
        }
        
        // Funci√≥n para cargar emisores desde localStorage
        async function loadLocalEmisores() {
            console.log('üíæ Cargando emisores desde localStorage...');
            try {
                const emisoresGuardados = localStorage.getItem('cfdi_emisores');
                if (emisoresGuardados) {
                    emisores = JSON.parse(emisoresGuardados);
                    console.log(`‚úÖ ${emisores.length} emisores cargados desde localStorage`);
                } else {
                    emisores = [];
                    console.log('üìÑ No hay emisores guardados, inicializando array vac√≠o');
                }
            } catch (error) {
                console.error('‚ùå Error parseando emisores desde localStorage:', error);
                emisores = [];
                throw error;
            }
        }

        // Variables ya definidas arriba

        // Funci√≥n de diagn√≥stico completo para el bot√≥n Nuevo Emisor
        function testEmisorButton() {
            console.log('üö® DIAGN√ìSTICO COMPLETO: Bot√≥n Nuevo Emisor presionado');
            
            // 1. Verificar autenticaci√≥n
            const token = localStorage.getItem('cfdi_token');
            console.log('üîë Token encontrado:', token ? 'S√ç' : 'NO');
            console.log('üîë Token value:', token ? token.substring(0, 20) + '...' : 'null');
            
            // 2. Verificar estado del usuario
            console.log('üë§ currentUser:', currentUser);
            
            // 3. Verificar elementos del DOM
            const modal = document.getElementById('emisorModal');
            console.log('üèóÔ∏è Modal element:', modal);
            
            if (!token) {
                alert('‚ö†Ô∏è ERROR: No est√°s autenticado.\n\nPor favor:\n1. Ve a /login\n2. Ingresa: admin@sistema.com\n3. Contrase√±a: password');
                window.location.href = '/login';
                return;
            }
            
            if (!modal) {
                alert('‚ùå ERROR: Modal no encontrado en el DOM');
                return;
            }
            
            // 4. Forzar mostrar modal directamente
            console.log('üîß FORZANDO mostrar modal...');
            modal.style.display = 'block';
            modal.style.zIndex = '9999';
            
            // 5. Tambi√©n llamar a la funci√≥n original
            console.log('üìù Llamando showEmisorModal...');
            try {
                showEmisorModal();
            } catch (error) {
                console.error('‚ùå Error en showEmisorModal:', error);
                alert('Error: ' + error.message);
            }
        }

        // ===== SISTEMA DE AUTENTICACI√ìN CFDI PROFESIONAL =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ CFDI SYSTEM: Dashboard iniciando...');
            
            // Verificar si hay usuario ya autenticado
            const token = localStorage.getItem('cfdi_token');
            const savedUser = localStorage.getItem('cfdi_user');
            
            if (token && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('userName').textContent = currentUser.nombre;
                    console.log('‚úÖ Usuario autenticado encontrado:', currentUser.email);
                    
                    // Cargar datos del sistema
                    await loadData();
                    return;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error parseando usuario guardado:', error);
                }
            }
            
            // Si no hay autenticaci√≥n v√°lida, crear usuario demo
            console.log('üîë Creando sesi√≥n demo para desarrollo...');
            
            currentUser = {
                id: 'demo-user-' + Date.now(),
                nombre: 'Usuario Demo',
                email: 'demo@cfdi.com',
                rol: 'admin'
            };
            
            const demoToken = 'demo-token-' + Date.now();
            localStorage.setItem('cfdi_token', demoToken);
            localStorage.setItem('cfdi_user', JSON.stringify(currentUser));
            
            document.getElementById('userName').textContent = currentUser.nombre;
            
            console.log('‚úÖ Sesi√≥n demo creada:', currentUser);
            
            // Cargar datos del sistema
            await loadData();
        });

        // Variables globales para filtros
        let todosLosXMLs = [];
        let xmlsFiltrados = [];
        let timeoutBusqueda = null;

        // Funci√≥n principal para cargar datos del sistema
        async function loadData() {
            console.log('üìä CFDI SYSTEM: Cargando datos del sistema...');
            
            try {
                // üîç DIAGN√ìSTICO COMPLETO DE LOCALSTORAGE
                console.log('üîç DIAGN√ìSTICO: Todas las claves en localStorage:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    console.log(`  - ${key}: ${value ? value.substring(0, 100) + '...' : 'null'}`);
                }
                
                // Inicializar arrays
                xmls = [];
                emisores = [];
                todosLosXMLs = [];
                xmlsFiltrados = [];
                
                // üîß CARGAR DATOS DIRECTAMENTE DESDE LOCALSTORAGE
                console.log('üîß Cargando datos directamente desde localStorage...');
                
                // CARGAR XMLs DESDE TODAS LAS POSIBLES CLAVES
                let xmlsData = localStorage.getItem('xmls_generados') || 
                              localStorage.getItem('cfdi_xmls') || 
                              localStorage.getItem('xmls') || '[]';
                              
                if (xmlsData !== '[]') {
                    try {
                        xmls = JSON.parse(xmlsData);
                        todosLosXMLs = [...xmls];
                        xmlsFiltrados = [...xmls];
                        console.log('‚úÖ XMLs cargados:', xmls.length, 'encontrados');
                        xmls.forEach((xml, i) => {
                            console.log(`  üìÑ XML ${i+1}: ${xml.serie}-${xml.folio} (${xml.emisor_nombre || xml.emisor_rfc || 'Sin emisor'})`);
                        });
                    } catch (e) {
                        console.error('‚ùå Error parseando XMLs:', e);
                        xmls = [];
                    }
                } else {
                    console.warn('‚ö†Ô∏è No se encontraron XMLs en localStorage');
                }
                
                // CARGAR EMISORES DESDE TODAS LAS POSIBLES CLAVES
                let emisoresData = localStorage.getItem('emisores') || 
                                  localStorage.getItem('cfdi_emisores') || 
                                  localStorage.getItem('emisores_cfdi') || '[]';
                                  
                if (emisoresData !== '[]') {
                    try {
                        emisores = JSON.parse(emisoresData);
                        console.log('‚úÖ Emisores cargados:', emisores.length, 'encontrados');
                        emisores.forEach((emisor, i) => {
                            console.log(`  üè¢ Emisor ${i+1}: ${emisor.rfc} - ${emisor.razon_social || emisor.nombre || 'Sin nombre'}`);
                        });
                    } catch (e) {
                        console.error('‚ùå Error parseando emisores:', e);
                        emisores = [];
                    }
                } else {
                    console.warn('‚ö†Ô∏è No se encontraron emisores en localStorage');
                }
                
                // Renderizar inmediatamente
                console.log('üé® Renderizando datos en la UI...');
                renderXMLs();
                renderEmisores();
                updateStats();
                
                console.log('‚úÖ Dashboard cargado exitosamente:', { xmls: xmls.length, emisores: emisores.length });
                addLog('success', 'Datos del dashboard cargados exitosamente', `XMLs: ${xmls.length}, Emisores: ${emisores.length}`);
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                addLog('error', 'Error cargando datos del dashboard', error.message || 'Error desconocido');
                
                // En caso de error, asegurar que las variables est√©n inicializadas
                xmls = [];
                emisores = [];
                todosLosXMLs = [];
                xmlsFiltrados = [];
                renderXMLs();
                renderEmisores();
                updateStats();
            }
        }
        
        // üîß FUNCI√ìN PARA CARGAR DATOS LOCALES - CLAVES CORREGIDAS
        async function loadLocalData() {
            console.log('üîç DIAGN√ìSTICO: Iniciando carga de datos locales...');
            
            // ‚úÖ CARGAR XMLs DESDE CLAVE CORRECTA
            const localXmls = localStorage.getItem('xmls_generados'); // ‚úÖ CLAVE CORRECTA
            console.log('üîç DIAGN√ìSTICO: Buscando XMLs en xmls_generados:', !!localXmls);
            
            if (localXmls) {
                try {
                    xmls = JSON.parse(localXmls);
                    todosLosXMLs = [...xmls];
                    xmlsFiltrados = [...xmls];
                    console.log('‚úÖ XMLs cargados exitosamente:', xmls.length);
                    console.log('üìÑ XMLs encontrados:', xmls.map(x => `${x.serie}-${x.folio}`));
                } catch (e) {
                    console.error('‚ùå Error parseando XMLs:', e);
                }
            } else {
                console.warn('‚ö†Ô∏è No se encontraron XMLs en localStorage');
            }
            
            // ‚úÖ CARGAR EMISORES DESDE CLAVE CORRECTA
            const localEmisores = localStorage.getItem('emisores'); // ‚úÖ CLAVE CORRECTA
            console.log('üîç DIAGN√ìSTICO: Buscando emisores en emisores:', !!localEmisores);
            
            if (localEmisores) {
                try {
                    emisores = JSON.parse(localEmisores);
                    console.log('‚úÖ Emisores cargados exitosamente:', emisores.length);
                    console.log('üè¢ Emisores encontrados:', emisores.map(e => `${e.rfc} - ${e.razon_social}`));
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error cargando emisores:', e);
                }
            }
        }

        async function cargarXMLs() {
            console.log('üîç Cargando XMLs desde todas las fuentes...');
            let xmlsBaseDatos = [];
            let xmlsLocales = [];
            
            try {
                // 1. Intentar cargar XMLs desde la base de datos (si hay token)
                const token = localStorage.getItem('cfdi_token');
                if (token) {
                    console.log('üíæ Cargando XMLs desde base de datos...');
                    const response = await fetch('/.netlify/functions/xmls', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        xmlsBaseDatos = await response.json();
                        console.log('‚úÖ XMLs cargados desde BD:', xmlsBaseDatos.length);
                    } else {
                        console.log('‚ö†Ô∏è No se pudieron cargar XMLs desde BD');
                    }
                }
                
                // 2. Cargar XMLs desde localStorage
                console.log('üì± Cargando XMLs desde localStorage...');
                const xmlsGuardados = JSON.parse(localStorage.getItem('xmlsGuardados') || '[]');
                xmlsLocales = xmlsGuardados.map(xml => ({
                    ...xml,
                    origen: 'localStorage',
                    id: xml.id || Date.now().toString()
                }));
                console.log('‚úÖ XMLs cargados desde localStorage:', xmlsLocales.length);
                
                // 3. Combinar XMLs de ambas fuentes (evitar duplicados por ID)
                const xmlsCombinados = [...xmlsBaseDatos];
                xmlsLocales.forEach(xmlLocal => {
                    const existeEnBD = xmlsBaseDatos.find(xmlBD => 
                        xmlBD.serie === xmlLocal.serie && 
                        xmlBD.folio === xmlLocal.folio &&
                        xmlBD.emisor_rfc === xmlLocal.emisor_rfc
                    );
                    if (!existeEnBD) {
                        xmlsCombinados.push(xmlLocal);
                    }
                });
                
                // 4. Ordenar por fecha (m√°s recientes primero)
                // Ordenar por fecha con compatibilidad completa
                xmlsCombinados.sort((a, b) => {
                    const fechaA = a.fecha || a.fecha_creacion || a.created_at || new Date().toISOString();
                    const fechaB = b.fecha || b.fecha_creacion || b.created_at || new Date().toISOString();
                    return new Date(fechaB) - new Date(fechaA);
                });
                
                console.log('üéØ Total XMLs combinados:', xmlsCombinados.length);
                
                // 5. Asignar a variables globales
                todosLosXMLs = xmlsCombinados;
                xmls = [...todosLosXMLs];
                xmlsFiltrados = [...todosLosXMLs];
                
                // 6. Mostrar resultados
                if (todosLosXMLs.length === 0) {
                    document.getElementById('xmlsContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <h3>üìÑ No hay XMLs generados</h3>
                            <p>A√∫n no has generado ning√∫n XML CFDI.</p>
                            <a href="/generator.html" class="btn btn-primary" style="margin-top: 15px;">‚ûï Generar Primer XML</a>
                        </div>
                    `;
                } else {
                    aplicarFiltros();
                }
                cargarEmisoresEnFiltro();
                
            } catch (error) {
                console.error('‚ùå Error cargando XMLs:', error);
                
                // Fallback: solo mostrar XMLs locales si falla todo
                const xmlsGuardados = JSON.parse(localStorage.getItem('xmlsGuardados') || '[]');
                if (xmlsGuardados.length > 0) {
                    console.log('üîÑ Fallback: mostrando solo XMLs locales');
                    todosLosXMLs = xmlsGuardados.map(xml => ({ ...xml, origen: 'localStorage' }));
                    xmls = [...todosLosXMLs];
                    xmlsFiltrados = [...todosLosXMLs];
                    aplicarFiltros();
                } else {
                    document.getElementById('xmlsContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <h3>‚ö†Ô∏è Error de conexi√≥n</h3>
                            <p>No se pudo conectar con el servidor y no hay XMLs locales.</p>
                            <button onclick="cargarXMLs()" class="btn btn-secondary" style="margin-top: 15px;">üîÑ Reintentar</button>
                        </div>
                    `;
                }
            }
        }

        function cargarEmisoresEnFiltro() {
            const emisoresUnicos = [...new Set(todosLosXMLs.map(xml => xml.emisor_rfc))]
                .filter(rfc => rfc)
                .sort();
            
            const selectEmisor = document.getElementById('filtroEmisor');
            selectEmisor.innerHTML = '<option value="todos">Todos los emisores</option>';
            
            emisoresUnicos.forEach(rfc => {
                const option = document.createElement('option');
                option.value = rfc;
                const nombre = todosLosXMLs.find(xml => xml.emisor_rfc === rfc)?.emisor_nombre || '';
                option.textContent = `${rfc} - ${nombre}`;
                selectEmisor.appendChild(option);
            });
        }

        async function loadEmisores() {
            try {
                const token = localStorage.getItem('cfdi_token');
                const response = await fetch('/.netlify/functions/emisores', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                emisores = data.emisores || [];
                renderEmisores();
            } catch (error) {
                console.error('Error loading emisores:', error);
                document.getElementById('emisoresContent').innerHTML = 
                    '<div class="empty-state">Error al cargar emisores</div>';
            }
        }

        function renderXMLs() {
            const container = document.getElementById('xmlsContent');
            
            if (xmls.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay XMLs generados</h3>
                        <p>Comienza generando tu primer CFDI</p>
                        <a href="/generator" class="btn btn-primary">Generar CFDI</a>
                    </div>
                `;
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Serie-Folio</th>
                            <th>Fecha</th>
                            <th>Emisor</th>
                            <th>Receptor</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${xmls.map(xml => {
                            // Procesar fecha correctamente - COMPATIBILIDAD COMPLETA
                            let fechaMostrar = 'Sin fecha';
                            try {
                                // Buscar fecha en todos los campos posibles (compatibilidad completa)
                                const fechaValida = xml.fecha || xml.fecha_creacion || xml.created_at || xml.fecha_generacion;
                                
                                if (fechaValida) {
                                    const fechaObj = new Date(fechaValida);
                                    if (!isNaN(fechaObj.getTime())) {
                                        fechaMostrar = fechaObj.toLocaleDateString('es-MX', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                        console.log('‚úÖ Fecha procesada correctamente:', fechaValida, '‚Üí', fechaMostrar);
                                    } else {
                                        console.warn('‚ö†Ô∏è Fecha inv√°lida encontrada:', fechaValida);
                                        fechaMostrar = 'Fecha inv√°lida';
                                    }
                                } else {
                                    console.warn('‚ö†Ô∏è No se encontr√≥ campo de fecha en XML:', Object.keys(xml));
                                    fechaMostrar = 'Sin fecha';
                                }
                            } catch (e) {
                                console.error('‚ùå Error procesando fecha para mostrar:', e);
                                fechaMostrar = 'Error en fecha';
                            }
                            
                            // Determinar si se puede editar (no sellado)
                            const puedeEditar = xml.estado !== 'sellado';
                            const folioEditable = puedeEditar ? 
                                `<span class="folio-editable" onclick="abrirEditorXML('${xml.id}')" title="Clic para editar XML completo">${xml.folio}</span>` : 
                                xml.folio;
                            
                            return `
                                <tr>
                                    <td><strong>${xml.serie || ''}-${folioEditable}</strong></td>
                                    <td>${fechaMostrar}</td>
                                    <td>${xml.emisor_nombre || 'Sin emisor'}</td>
                                    <td>${xml.receptor_nombre || 'Sin receptor'}</td>
                                    <td><strong>$${parseFloat(xml.total || 0).toFixed(2)}</strong></td>
                                    <td><span class="badge badge-${getEstadoBadgeClass(xml.estado)}">${xml.estado || 'generado'}</span></td>
                                    <td>
                                        <button onclick="downloadXML('${xml.id}')" class="btn btn-primary" title="Descargar XML - Descarga el archivo XML generado a tu computadora">üì•</button>
                                        <button onclick="viewXML('${xml.id}')" class="btn btn-info" title="Ver XML - Muestra el contenido del XML en una ventana emergente">üëÅÔ∏è</button>
                                        ${puedeEditar ? `<button onclick="editXML('${xml.id}')" class="btn btn-warning" title="Editar XML - Permite modificar los datos del CFDI (solo si no est√° sellado)">‚úèÔ∏è</button>` : ''}
                                        <button onclick="deleteXML('${xml.id}')" class="btn btn-danger" title="Eliminar XML - Borra permanentemente este CFDI del sistema">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        function renderEmisores() {
            const container = document.getElementById('emisoresContent');
            
            if (emisores.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay emisores registrados</h3>
                        <p>Agrega un emisor para comenzar</p>
                        <button onclick="showEmisorModal()" class="btn btn-primary">Agregar Emisor</button>
                    </div>
                `;
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>RFC</th>
                            <th>Nombre</th>
                            <th>C√≥digo Postal</th>
                            <th>R√©gimen</th>
                            <th>CSD</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${emisores.map(emisor => `
                            <tr>
                                <td>${emisor.rfc}</td>
                                <td>${emisor.nombre}</td>
                                <td>${emisor.codigo_postal}</td>
                                <td>${emisor.regimen_fiscal}</td>
                                <td><span class="badge badge-${emisor.certificado_cer ? 'success' : 'warning'}">${emisor.certificado_cer ? 'Configurado' : 'Pendiente'}</span></td>
                                <td><span class="badge badge-${emisor.activo ? 'success' : 'warning'}">${emisor.activo ? 'Activo' : 'Inactivo'}</span></td>
                                <td>
                                    <button onclick="editEmisor('${emisor.id}')" class="btn btn-primary">‚úèÔ∏è</button>
                                    <button onclick="deleteEmisor('${emisor.id}')" class="btn btn-danger">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        function updateStats() {
            // Asegurar que las variables est√©n inicializadas
            const xmlsCount = (typeof xmls !== 'undefined' && xmls) ? xmls.length : (todosLosXMLs ? todosLosXMLs.length : 0);
            const emisoresCount = (typeof emisores !== 'undefined' && emisores) ? emisores.length : 0;
            
            // ‚úÖ CORREGIR IDs DE ELEMENTOS DOM - ESTAD√çSTICAS
            const totalXMLsElement = document.getElementById('totalXMLsCount'); // ‚úÖ ID CORRECTO
            const totalEmisoresElement = document.getElementById('totalEmisoresCount'); // ‚úÖ ID CORRECTO
            
            console.log('üìä Actualizando estad√≠sticas - XMLs:', xmlsCount, 'Emisores:', emisoresCount);
            
            if (totalXMLsElement) {
                totalXMLsElement.textContent = xmlsCount;
                console.log('‚úÖ Total XMLs actualizado:', xmlsCount);
            } else {
                console.warn('‚ö†Ô∏è Elemento totalXMLsCount no encontrado en DOM');
            }
            
            if (totalEmisoresElement) {
                totalEmisoresElement.textContent = emisoresCount;
                console.log('‚úÖ Total Emisores actualizado:', emisoresCount);
            } else {
                console.warn('‚ö†Ô∏è Elemento totalEmisoresCount no encontrado en DOM');
            }
            
            // üìÖ CALCULAR XMLs DE ESTE MES CON COMPATIBILIDAD COMPLETA
            const xmlsArray = xmls || todosLosXMLs || [];
            const thisMonth = xmlsArray.filter(xml => {
                try {
                    // ‚úÖ USAR FUNCI√ìN COMPATIBLE DE FECHA
                    const fechaValida = xml.fecha || xml.fecha_creacion || xml.created_at || xml.fecha_generacion;
                    const xmlDate = new Date(fechaValida);
                    const now = new Date();
                    return xmlDate.getMonth() === now.getMonth() && 
                           xmlDate.getFullYear() === now.getFullYear();
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error procesando fecha para estad√≠sticas:', error);
                    return false;
                }
            }).length;
            
            console.log('üìÖ XMLs de este mes calculados:', thisMonth);
            
            // ‚úÖ CORREGIR ID DE ELEMENTO DOM - XMLs ESTE MES
            const xmlsThisMonthElement = document.getElementById('xmlsThisMonthCount'); // ‚úÖ ID CORRECTO
            if (xmlsThisMonthElement) {
                xmlsThisMonthElement.textContent = thisMonth;
                console.log('‚úÖ XMLs este mes actualizado:', thisMonth);
            } else {
                console.warn('‚ö†Ô∏è Elemento xmlsThisMonth no encontrado en DOM');
            }
        }

        // Funciones de filtros y b√∫squeda
        function aplicarFiltros() {
            let xmlsFiltradosTemp = [...todosLosXMLs];

            // Filtro por fecha
            const filtroFecha = document.getElementById('filtroFecha').value;
            if (filtroFecha !== 'todos') {
                xmlsFiltradosTemp = filtrarPorFecha(xmlsFiltradosTemp, filtroFecha);
            }

            // Filtro por estado
            const filtroEstado = document.getElementById('filtroEstado').value;
            if (filtroEstado !== 'todos') {
                xmlsFiltradosTemp = xmlsFiltradosTemp.filter(xml => 
                    (xml.estado || 'generado') === filtroEstado
                );
            }

            // Filtro por versi√≥n
            const filtroVersion = document.getElementById('filtroVersion').value;
            if (filtroVersion !== 'todas') {
                xmlsFiltradosTemp = xmlsFiltradosTemp.filter(xml => 
                    xml.version_cfdi === filtroVersion
                );
            }

            // Filtro por emisor
            const filtroEmisor = document.getElementById('filtroEmisor').value;
            if (filtroEmisor !== 'todos') {
                xmlsFiltradosTemp = xmlsFiltradosTemp.filter(xml => 
                    xml.emisor_rfc === filtroEmisor
                );
            }

            // Filtro por rango de total
            const totalMinimo = parseFloat(document.getElementById('totalMinimo').value);
            const totalMaximo = parseFloat(document.getElementById('totalMaximo').value);
            
            if (!isNaN(totalMinimo)) {
                xmlsFiltradosTemp = xmlsFiltradosTemp.filter(xml => 
                    parseFloat(xml.total) >= totalMinimo
                );
            }
            
            if (!isNaN(totalMaximo)) {
                xmlsFiltradosTemp = xmlsFiltradosTemp.filter(xml => 
                    parseFloat(xml.total) <= totalMaximo
                );
            }

            // Aplicar b√∫squeda por t√©rmino
            const terminoBusqueda = document.getElementById('terminoBusqueda').value.trim();
            if (terminoBusqueda) {
                const tipoBusqueda = document.getElementById('tipoBusqueda').value;
                xmlsFiltradosTemp = filtrarPorTermino(xmlsFiltradosTemp, terminoBusqueda, tipoBusqueda);
            }

            xmlsFiltrados = xmlsFiltradosTemp;
            mostrarXMLs(xmlsFiltrados);
            actualizarContadorResultados();
        }

        // üìÖ FUNCI√ìN AUXILIAR: Obtener fecha compatible de XML
        function obtenerFechaXML(xml) {
            // Buscar fecha en todos los campos posibles (compatibilidad completa)
            const fechaValida = xml.fecha || xml.fecha_creacion || xml.created_at || xml.fecha_generacion;
            
            if (fechaValida) {
                const fechaObj = new Date(fechaValida);
                if (!isNaN(fechaObj.getTime())) {
                    return fechaObj;
                }
            }
            
            // Si no hay fecha v√°lida, retornar fecha muy antigua para que no pase filtros
            return new Date('1900-01-01');
        }

        function filtrarPorFecha(xmls, filtro) {
            const ahora = new Date();
            const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            
            console.log('üîç Aplicando filtro de fecha:', filtro, 'Total XMLs:', xmls.length);
            
            switch (filtro) {
                case 'hoy':
                    const resultadoHoy = xmls.filter(xml => {
                        const fechaXml = obtenerFechaXML(xml);
                        const cumple = fechaXml >= hoy;
                        if (cumple) console.log('‚úÖ XML cumple filtro HOY:', xml.serie, xml.folio, fechaXml);
                        return cumple;
                    });
                    console.log('üìä Filtro HOY - Encontrados:', resultadoHoy.length);
                    return resultadoHoy;
                    
                case 'esta_semana':
                    const inicioSemana = new Date(hoy);
                    inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                    const resultadoSemana = xmls.filter(xml => {
                        const fechaXml = obtenerFechaXML(xml);
                        const cumple = fechaXml >= inicioSemana;
                        if (cumple) console.log('‚úÖ XML cumple filtro SEMANA:', xml.serie, xml.folio, fechaXml);
                        return cumple;
                    });
                    console.log('üìä Filtro ESTA SEMANA - Encontrados:', resultadoSemana.length);
                    return resultadoSemana;
                    
                case 'este_mes':
                    const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
                    const resultadoMes = xmls.filter(xml => {
                        const fechaXml = obtenerFechaXML(xml);
                        const cumple = fechaXml >= inicioMes;
                        if (cumple) console.log('‚úÖ XML cumple filtro MES:', xml.serie, xml.folio, fechaXml);
                        return cumple;
                    });
                    console.log('üìä Filtro ESTE MES - Encontrados:', resultadoMes.length);
                    return resultadoMes;
                    
                case 'mes_anterior':
                    const inicioMesAnterior = new Date(ahora.getFullYear(), ahora.getMonth() - 1, 1);
                    const finMesAnterior = new Date(ahora.getFullYear(), ahora.getMonth(), 0, 23, 59, 59);
                    const resultadoMesAnterior = xmls.filter(xml => {
                        const fechaXml = obtenerFechaXML(xml);
                        const cumple = fechaXml >= inicioMesAnterior && fechaXml <= finMesAnterior;
                        if (cumple) console.log('‚úÖ XML cumple filtro MES ANTERIOR:', xml.serie, xml.folio, fechaXml);
                        return cumple;
                    });
                    console.log('üìä Filtro MES ANTERIOR - Encontrados:', resultadoMesAnterior.length);
                    return resultadoMesAnterior;
                    
                case 'ultimos_3_meses':
                    const hace3Meses = new Date(ahora.getFullYear(), ahora.getMonth() - 3, 1);
                    const resultado3Meses = xmls.filter(xml => {
                        const fechaXml = obtenerFechaXML(xml);
                        const cumple = fechaXml >= hace3Meses;
                        if (cumple) console.log('‚úÖ XML cumple filtro 3 MESES:', xml.serie, xml.folio, fechaXml);
                        return cumple;
                    });
                    console.log('üìä Filtro √öLTIMOS 3 MESES - Encontrados:', resultado3Meses.length);
                    return resultado3Meses;
                    
                case 'este_ano':
                    const inicioAno = new Date(ahora.getFullYear(), 0, 1);
                    const resultadoAno = xmls.filter(xml => {
                        const fechaXml = obtenerFechaXML(xml);
                        const cumple = fechaXml >= inicioAno;
                        if (cumple) console.log('‚úÖ XML cumple filtro A√ëO:', xml.serie, xml.folio, fechaXml);
                        return cumple;
                    });
                    console.log('üìä Filtro ESTE A√ëO - Encontrados:', resultadoAno.length);
                    return resultadoAno;
                    
                case 'personalizado':
                    const fechaDesde = document.getElementById('fechaDesde').value;
                    const fechaHasta = document.getElementById('fechaHasta').value;
                    
                    if (!fechaDesde && !fechaHasta) {
                        console.log('‚ö†Ô∏è Filtro personalizado sin fechas definidas');
                        return xmls;
                    }
                    
                    const resultadoPersonalizado = xmls.filter(xml => {
                        const fechaXml = obtenerFechaXML(xml);
                        const cumpleDesde = !fechaDesde || fechaXml >= new Date(fechaDesde);
                        const cumpleHasta = !fechaHasta || fechaXml <= new Date(fechaHasta + 'T23:59:59');
                        const cumple = cumpleDesde && cumpleHasta;
                        if (cumple) console.log('‚úÖ XML cumple filtro PERSONALIZADO:', xml.serie, xml.folio, fechaXml);
                        return cumple;
                    });
                    console.log('üìä Filtro PERSONALIZADO - Encontrados:', resultadoPersonalizado.length);
                    return resultadoPersonalizado;
                    
                default:
                    console.log('üìÑ Sin filtro de fecha - Mostrando todos');
                    return xmls;
            }
        }

        function filtrarPorTermino(xmls, termino, tipo) {
            const terminoLower = termino.toLowerCase();
            
            return xmls.filter(xml => {
                const valor = (xml[tipo] || '').toString().toLowerCase();
                return valor.includes(terminoLower);
            });
        }

        function buscarEnTiempoReal() {
            clearTimeout(timeoutBusqueda);
            timeoutBusqueda = setTimeout(() => {
                aplicarFiltros();
            }, 300);
        }

        function limpiarFiltros() {
            document.getElementById('filtroFecha').value = 'todos'; // üìÑ Todos los comprobantes por defecto
            document.getElementById('tipoBusqueda').value = 'folio';
            document.getElementById('terminoBusqueda').value = '';
            document.getElementById('filtroEstado').value = 'todos';
            document.getElementById('filtroVersion').value = 'todas';
            document.getElementById('filtroEmisor').value = 'todos';
            document.getElementById('totalMinimo').value = '';
            document.getElementById('totalMaximo').value = '';
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            
            // Ocultar campos de rango personalizado
            document.getElementById('rangoPersonalizado').style.display = 'none';
            document.getElementById('rangoPersonalizadoHasta').style.display = 'none';
            
            aplicarFiltros();
        }

        function actualizarContadorResultados() {
            const contador = document.getElementById('contadorResultados');
            const total = todosLosXMLs.length;
            const filtrados = xmlsFiltrados.length;
            
            if (filtrados === total) {
                contador.textContent = `Mostrando ${total} XMLs`;
            } else {
                contador.textContent = `Mostrando ${filtrados} de ${total} XMLs`;
            }
        }

        function mostrarXMLs(xmlsParaMostrar) {
            xmls = xmlsParaMostrar; // Actualizar la variable global para compatibilidad
            renderXMLs();
        }

        function exportarXMLs() {
            if (xmlsFiltrados.length === 0) {
                alert('No hay XMLs para exportar');
                return;
            }

            const datosExport = xmlsFiltrados.map(xml => ({
                'Fecha': new Date(xml.fecha_creacion).toLocaleDateString(),
                'Serie': xml.serie || '',
                'Folio': xml.folio,
                'UUID': xml.uuid || '',
                'Versi√≥n': xml.version_cfdi,
                'RFC Emisor': xml.emisor_rfc,
                'Nombre Emisor': xml.emisor_nombre,
                'RFC Receptor': xml.receptor_rfc,
                'Nombre Receptor': xml.receptor_nombre,
                'Total': `$${parseFloat(xml.total).toFixed(2)}`,
                'Estado': xml.estado || 'generado'
            }));

            const csv = convertirACSV(datosExport);
            descargarCSV(csv, `XMLs_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function convertirACSV(datos) {
            if (datos.length === 0) return '';
            
            const headers = Object.keys(datos[0]);
            const csvContent = [
                headers.join(','),
                ...datos.map(row => 
                    headers.map(header => 
                        `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                    ).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        function descargarCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Event listener para mostrar/ocultar campos de fecha personalizada
        document.addEventListener('DOMContentLoaded', function() {
            const filtroFecha = document.getElementById('filtroFecha');
            if (filtroFecha) {
                filtroFecha.addEventListener('change', function() {
                    const rangoPersonalizado = document.getElementById('rangoPersonalizado');
                    const rangoPersonalizadoHasta = document.getElementById('rangoPersonalizadoHasta');
                    
                    if (this.value === 'personalizado') {
                        rangoPersonalizado.style.display = 'block';
                        rangoPersonalizadoHasta.style.display = 'block';
                    } else {
                        rangoPersonalizado.style.display = 'none';
                        rangoPersonalizadoHasta.style.display = 'none';
                    }
                });
            }
        });

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Cargar datos espec√≠ficos de la pesta√±a
            if (tabName === 'logs') {
                loadLogs();
            } else if (tabName === 'estadisticas') {
                updateStatistics();
            }
        }
        
        // SISTEMA DE LOGS PROFESIONAL
        let systemLogs = JSON.parse(localStorage.getItem('cfdi_system_logs') || '[]');
        let filteredLogs = [];
        
        // Funci√≥n para agregar un log al sistema
        window.addLog = function(level, message, details = null) {
            const logEntry = {
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                level: level, // 'info', 'success', 'warning', 'error'
                message: message,
                details: details,
                source: 'dashboard'
            };
            
            systemLogs.unshift(logEntry); // Agregar al inicio
            
            // Mantener solo los √∫ltimos 1000 logs
            if (systemLogs.length > 1000) {
                systemLogs = systemLogs.slice(0, 1000);
            }
            
            // Guardar en localStorage
            localStorage.setItem('cfdi_system_logs', JSON.stringify(systemLogs));
            
            // Actualizar vista si est√° activa
            if (document.getElementById('logsTab').classList.contains('active')) {
                renderLogs();
            }
            
            // Auto-scroll si est√° habilitado
            if (document.getElementById('autoScrollLogs')?.checked) {
                setTimeout(() => {
                    const logsContainer = document.querySelector('.logs-container');
                    if (logsContainer) {
                        logsContainer.scrollTop = 0;
                    }
                }, 100);
            }
        };
        
        // Funci√≥n para cargar logs
        function loadLogs() {
            systemLogs = JSON.parse(localStorage.getItem('cfdi_system_logs') || '[]');
            renderLogs();
            updateLogsStats();
        }
        
        // Funci√≥n para renderizar logs
        function renderLogs() {
            const logsContent = document.getElementById('logsContent');
            if (!logsContent) return;
            
            if (filteredLogs.length === 0 && systemLogs.length === 0) {
                logsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>üìã No hay logs del sistema</h3>
                        <p>Los logs aparecer√°n aqu√≠ cuando se realicen operaciones.</p>
                    </div>
                `;
                return;
            }
            
            const logsToShow = filteredLogs.length > 0 ? filteredLogs : systemLogs;
            
            logsContent.innerHTML = logsToShow.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('es-MX');
                const levelIcon = {
                    'info': '‚ÑπÔ∏è',
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå'
                }[log.level] || 'üìù';
                
                return `
                    <div class="log-entry ${log.level}">
                        <span class="log-timestamp">${timestamp}</span>
                        <span class="log-level ${log.level}">${levelIcon} ${log.level.toUpperCase()}</span>
                        <span class="log-message">${log.message}</span>
                        ${log.details ? `<div style="margin-top: 5px; color: #666; font-size: 12px;">üìÑ ${log.details}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Funci√≥n para filtrar logs
        function filterLogs() {
            const levelFilter = document.getElementById('logLevelFilter')?.value || 'all';
            const searchText = document.getElementById('logSearchInput')?.value.toLowerCase() || '';
            
            filteredLogs = systemLogs.filter(log => {
                const levelMatch = levelFilter === 'all' || log.level === levelFilter;
                const textMatch = searchText === '' || 
                    log.message.toLowerCase().includes(searchText) ||
                    (log.details && log.details.toLowerCase().includes(searchText));
                
                return levelMatch && textMatch;
            });
            
            renderLogs();
            updateLogsStats();
        }
        
        // Funci√≥n para actualizar estad√≠sticas de logs
        function updateLogsStats() {
            const totalLogs = systemLogs.length;
            const filteredCount = filteredLogs.length > 0 ? filteredLogs.length : totalLogs;
            
            const logsCountElement = document.getElementById('logsCount');
            const logsFilteredElement = document.getElementById('logsFiltered');
            
            if (logsCountElement) logsCountElement.textContent = `${totalLogs} logs`;
            if (logsFilteredElement) logsFilteredElement.textContent = `${filteredCount} mostrados`;
        }
        
        // Funci√≥n para limpiar logs
        function clearLogs() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los logs?')) {
                systemLogs = [];
                filteredLogs = [];
                localStorage.removeItem('cfdi_system_logs');
                renderLogs();
                updateLogsStats();
                addLog('info', 'Logs del sistema limpiados', 'Todos los logs anteriores han sido eliminados');
            }
        }
        
        // Funci√≥n para exportar logs
        function exportLogs() {
            const logsToExport = filteredLogs.length > 0 ? filteredLogs : systemLogs;
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Timestamp,Level,Message,Details\n' +
                logsToExport.map(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString('es-MX');
                    const message = `"${log.message.replace(/"/g, '""')}"`;
                    const details = log.details ? `"${log.details.replace(/"/g, '""')}"` : '';
                    return `${timestamp},${log.level},${message},${details}`;
                }).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `cfdi_logs_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addLog('success', 'Logs exportados', `Se exportaron ${logsToExport.length} logs a CSV`);
        }
        
        // Funci√≥n para actualizar logs
        function refreshLogs() {
            loadLogs();
            addLog('info', 'Logs actualizados', 'Vista de logs refrescada manualmente');
        }
        
        // Funci√≥n para actualizar estad√≠sticas generales
        function updateStatistics() {
            const totalXMLsElement = document.getElementById('totalXMLsCount');
            const totalEmisoresElement = document.getElementById('totalEmisoresCount');
            const xmlsThisMonthElement = document.getElementById('xmlsThisMonthCount');
            
            if (totalXMLsElement) {
                const xmlsCount = todosLosXMLs ? todosLosXMLs.length : 0;
                totalXMLsElement.textContent = xmlsCount;
            }
            
            if (totalEmisoresElement) {
                const emisoresCount = emisores ? emisores.length : 0;
                totalEmisoresElement.textContent = emisoresCount;
            }
            
            if (xmlsThisMonthElement) {
                const xmlsArray = todosLosXMLs || [];
                const thisMonth = xmlsArray.filter(xml => {
                    try {
                        // ‚úÖ USAR COMPATIBILIDAD COMPLETA DE FECHAS
                        const fechaValida = xml.fecha || xml.fecha_creacion || xml.created_at || xml.fecha_generacion;
                        const xmlDate = new Date(fechaValida);
                        const now = new Date();
                        return xmlDate.getMonth() === now.getMonth() && 
                               xmlDate.getFullYear() === now.getFullYear();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error procesando fecha en updateStatistics:', error);
                        return false;
                    }
                }).length;
                xmlsThisMonthElement.textContent = thisMonth;
                console.log('‚úÖ updateStatistics - XMLs este mes:', thisMonth);
            }
        }

        // ===== FUNCIONES DE UTILIDAD ADICIONALES =====
        
        // Funci√≥n de emergencia para mostrar modal (solo para debugging)
        function forceShowModal() {
            console.log('üö® EMERGENCIA: Forzando mostrar modal');
            const modal = document.getElementById('emisorModal');
            if (modal) {
                modal.style.display = 'block';
                modal.style.zIndex = '9999';
                console.log('‚úÖ Modal forzado a mostrar');
            } else {
                console.error('‚ùå Modal no encontrado');
            }
        }

        // FUNCI√ìN DUPLICADA ELIMINADA - Se usa closeEmisorModal() definida arriba

        function getEstadoBadgeClass(estado) {
            switch (estado) {
                case 'generado': return 'info';
                case 'sellado': return 'warning';
                case 'timbrado': return 'success';
                default: return 'info';
            }
        }

        async function downloadXML(xmlId) {
            const xml = xmls.find(x => x.id === xmlId);
            if (!xml) return;

            const blob = new Blob([xml.xml_content], { type: 'application/xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CFDI_${xml.version_cfdi}_${xml.emisor_rfc}_${xml.serie || ''}-${xml.folio}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        async function deleteXML(xmlId) {
            if (!confirm('¬øEst√° seguro de eliminar este XML?')) return;

            try {
                const token = localStorage.getItem('cfdi_token');
                const response = await fetch(`/.netlify/functions/xmls?id=${xmlId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadXMLs();
                    updateStats();
                } else {
                    alert('Error al eliminar XML');
                }
            } catch (error) {
                console.error('Error deleting XML:', error);
                alert('Error al eliminar XML');
            }
        }

        function editEmisor(emisorId) {
            showEmisorModal(emisorId);
        }

        async function deleteEmisor(emisorId) {
            if (!confirm('¬øEst√° seguro de eliminar este emisor?')) return;

            try {
                const token = localStorage.getItem('cfdi_token');
                const response = await fetch(`/.netlify/functions/emisores?id=${emisorId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await loadEmisores();
                    updateStats();
                } else {
                    alert('Error al eliminar emisor');
                }
            } catch (error) {
                console.error('Error deleting emisor:', error);
                alert('Error al eliminar emisor');
            }
        }

        function logout() {
            localStorage.removeItem('cfdi_token');
            localStorage.removeItem('cfdi_user');
            window.location.href = '/login.html';
        }

        // Manejar formulario de emisor
        document.getElementById('emisorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                rfc: document.getElementById('emisorRfc').value,
                nombre: document.getElementById('emisorNombre').value,
                codigo_postal: document.getElementById('emisorCodigoPostal').value,
                regimen_fiscal: document.getElementById('emisorRegimenFiscal').value
            };

            // Manejar archivos de certificado
            const cerFile = document.getElementById('certificadoCer').files[0];
            const keyFile = document.getElementById('certificadoKey').files[0];
            const password = document.getElementById('passwordKey').value;

            if (cerFile) {
                formData.certificado_cer = await fileToBase64(cerFile);
            }
            if (keyFile) {
                formData.certificado_key = await fileToBase64(keyFile);
            }
            if (password) {
                formData.password_key = password;
            }

            try {
                const token = localStorage.getItem('cfdi_token');
                const url = editingEmisorId 
                    ? `/.netlify/functions/emisores?id=${editingEmisorId}`
                    : '/.netlify/functions/emisores';
                
                const response = await fetch(url, {
                    method: editingEmisorId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('üì° Respuesta del servidor:', response.status, response.statusText);

                if (response.ok) {
                    closeEmisorModal();
                    await loadEmisores();
                    updateStats();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Error al guardar emisor');
                }
            } catch (error) {
                console.error('Error saving emisor:', error);
                alert('Error al guardar emisor');
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

function editEmisor(emisorId) {
    showEmisorModal(emisorId);
}

async function deleteEmisor(emisorId) {
    if (!confirm('¬øEst√° seguro de eliminar este emisor?')) return;

    try {
        const token = localStorage.getItem('cfdi_token');
        const response = await fetch(`/.netlify/functions/emisores?id=${emisorId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            await loadEmisores();
            updateStats();
        } else {
            alert('Error al eliminar emisor');
        }
    } catch (error) {
        console.error('Error deleting emisor:', error);
        alert('Error al eliminar emisor');
    }
}

function logout() {
    localStorage.removeItem('cfdi_token');
    localStorage.removeItem('cfdi_user');
    window.location.href = '/login.html';
}

// Manejar formulario de emisor
document.getElementById('emisorForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        rfc: document.getElementById('emisorRfc').value,
        nombre: document.getElementById('emisorNombre').value,
        codigo_postal: document.getElementById('emisorCodigoPostal').value,
        regimen_fiscal: document.getElementById('emisorRegimenFiscal').value
    };

    // Manejar archivos de certificado
    const cerFile = document.getElementById('certificadoCer').files[0];
    const keyFile = document.getElementById('certificadoKey').files[0];
    const password = document.getElementById('passwordKey').value;

    if (cerFile) {
        formData.certificado_cer = await fileToBase64(cerFile);
    }
    if (keyFile) {
        formData.certificado_key = await fileToBase64(keyFile);
    }
    if (password) {
        formData.password_key = password;
    }

    try {
        const token = localStorage.getItem('cfdi_token');
        const url = editingEmisorId 
            ? `/.netlify/functions/emisores?id=${editingEmisorId}`
            : '/.netlify/functions/emisores';
        
        const response = await fetch(url, {
            method: editingEmisorId ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(formData)
        });

        console.log(' Respuesta del servidor:', response.status, response.statusText);

        if (response.ok) {
            closeEmisorModal();
            await loadEmisores();
            updateStats();
        } else {
            const error = await response.json();
            alert(error.error || 'Error al guardar emisor');
        }
    } catch (error) {
        console.error('Error saving emisor:', error);
        alert('Error al guardar emisor');
    }
});

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
            // Si es el modal XML, limpiar variable
            if (modal.id === 'xmlModal') {
                xmlActualViewing = null;
            }
        }
    });
    const importModal = document.getElementById('importXMLModal');
    if (event.target === importModal) {
        closeImportXMLModal();
    }
}

// ===== FUNCIONALIDAD IMPORTAR XML =====
        
function openImportXMLModal() {
    console.log(' CFDI SYSTEM: Abriendo modal de importar XML...');
    const modal = document.getElementById('importXMLModal');
    if (modal) {
        modal.style.display = 'block';
        document.getElementById('importXMLFile').value = '';
        document.getElementById('importXMLResult').innerHTML = '';
        console.log(' Modal de importar XML abierto');
    } else {
        console.error(' Modal de importar XML no encontrado');
    }
}
        
function closeImportXMLModal() {
    console.log(' CFDI SYSTEM: Cerrando modal de importar XML...');
    const modal = document.getElementById('importXMLModal');
    if (modal) {
        modal.style.display = 'none';
        console.log(' Modal de importar XML cerrado');
    }
}
        
async function importarXML() {
    console.log(' CFDI SYSTEM: Iniciando importaci√≥n de XML...');
            
    const fileInput = document.getElementById('importXMLFile');
    const resultDiv = document.getElementById('importXMLResult');
            
    if (!fileInput.files || fileInput.files.length === 0) {
        resultDiv.innerHTML = '<div class="alert alert-error"> Debe seleccionar un archivo XML</div>';
        return;
    }
            
    const file = fileInput.files[0];
            
    // Validar extensi√≥n
    if (!file.name.toLowerCase().endsWith('.xml')) {
        resultDiv.innerHTML = '<div class="alert alert-error"> El archivo debe tener extensi√≥n .xml</div>';
        return;
    }
            
    // Validar tama√±o (m√°ximo 5MB)
    if (file.size > 5 * 1024 * 1024) {
        resultDiv.innerHTML = '<div class="alert alert-error"> El archivo XML no debe exceder 5MB</div>';
        return;
    }
            
    try {
        resultDiv.innerHTML = '<div class="alert alert-info"> Validando XML...</div>';
                
        // Leer contenido del archivo
        const xmlContent = await leerArchivoXML(file);
                
        // Validar estructura XML
        const validacionXML = validarEstructuraXML(xmlContent);
        if (!validacionXML.valido) {
            resultDiv.innerHTML = `<div class="alert alert-error"> Error de estructura XML: ${validacionXML.error}</div>`;
            return;
        }
                
        // Extraer informaci√≥n del CFDI
        const infoCFDI = extraerInformacionCFDI(xmlContent);
        if (!infoCFDI.valido) {
            resultDiv.innerHTML = `<div class="alert alert-error"> Error procesando CFDI: ${infoCFDI.error}</div>`;
            return;
        }
                
        // Validar contra XSD (simulado por ahora)
        const validacionXSD = await validarContraXSD(xmlContent, infoCFDI.version);
        if (!validacionXSD.valido) {
            resultDiv.innerHTML = `<div class="alert alert-error"> Error de validaci√≥n XSD: ${validacionXSD.error}</div>`;
            return;
        }
                
        // Guardar XML importado
        const xmlGuardado = await guardarXMLImportado(xmlContent, infoCFDI, file.name);
        if (xmlGuardado.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    XML importado exitosamente<br>
                    <strong>Versi√≥n:</strong> CFDI ${infoCFDI.version}<br>
                    <strong>RFC Emisor:</strong> ${infoCFDI.emisor.rfc}<br>
                    <strong>Serie-Folio:</strong> ${infoCFDI.serie || ''}-${infoCFDI.folio}<br>
                    <strong>Total:</strong> $${parseFloat(infoCFDI.total).toFixed(2)}
                </div>
            `;
                    
            // Actualizar lista de XMLs inmediatamente
            console.log(' Actualizando lista de XMLs tras importaci√≥n...');
                    
            // Recargar XMLs desde localStorage y actualizar variables globales
            const xmlsActualizados = JSON.parse(localStorage.getItem('cfdi_xmls') || '[]');
            xmls = xmlsActualizados;
            todosLosXMLs = [...xmlsActualizados];
            xmlsFiltrados = [...xmlsActualizados];
                    
            // Actualizar UI inmediatamente
            renderXMLs();
            updateStats();
                    
            console.log(' Lista de XMLs actualizada:', xmls.length, 'XMLs encontrados');
                    
            setTimeout(() => {
                closeImportXMLModal();
                showTab('xmls');
            }, 2000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-error"> Error guardando XML: ${xmlGuardado.message}</div>`;
        }
        // ===== FUNCIONALIDAD IMPORTAR XML =====
        
        function openImportXMLModal() {
            console.log('üìÅ CFDI SYSTEM: Abriendo modal de importar XML...');
            const modal = document.getElementById('importXMLModal');
            if (modal) {
                modal.style.display = 'block';
                document.getElementById('importXMLFile').value = '';
                document.getElementById('importXMLResult').innerHTML = '';
                console.log('‚úÖ Modal de importar XML abierto');
            } else {
                console.error('‚ùå Modal de importar XML no encontrado');
            }
        }
        
        function closeImportXMLModal() {
            console.log('üìÅ CFDI SYSTEM: Cerrando modal de importar XML...');
            const modal = document.getElementById('importXMLModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal de importar XML cerrado');
            }
        }
        
        async function importarXML() {
            console.log('üìÅ CFDI SYSTEM: Iniciando importaci√≥n de XML...');
            
            const fileInput = document.getElementById('importXMLFile');
            const resultDiv = document.getElementById('importXMLResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-error">‚ùå Debe seleccionar un archivo XML</div>';
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validar extensi√≥n
            if (!file.name.toLowerCase().endsWith('.xml')) {
                resultDiv.innerHTML = '<div class="alert alert-error">‚ùå El archivo debe tener extensi√≥n .xml</div>';
                return;
            }
            
            // Validar tama√±o (m√°ximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                resultDiv.innerHTML = '<div class="alert alert-error">‚ùå El archivo XML no debe exceder 5MB</div>';
                return;
            }
            
            try {
                resultDiv.innerHTML = '<div class="alert alert-info">üîÑ Validando XML...</div>';
                
                // Leer contenido del archivo
                const xmlContent = await leerArchivoXML(file);
                
                // Validar estructura XML
                const validacionXML = validarEstructuraXML(xmlContent);
                if (!validacionXML.valido) {
                    resultDiv.innerHTML = `<div class="alert alert-error">‚ùå Error de estructura XML: ${validacionXML.error}</div>`;
                    return;
                }
                
                // Extraer informaci√≥n del CFDI
                const infoCFDI = extraerInformacionCFDI(xmlContent);
                if (!infoCFDI.valido) {
                    resultDiv.innerHTML = `<div class="alert alert-error">‚ùå Error procesando CFDI: ${infoCFDI.error}</div>`;
                    return;
                }
                
                // Validar contra XSD (simulado por ahora)
                const validacionXSD = await validarContraXSD(xmlContent, infoCFDI.version);
                if (!validacionXSD.valido) {
                    resultDiv.innerHTML = `<div class="alert alert-error">‚ùå Error de validaci√≥n XSD: ${validacionXSD.error}</div>`;
                    return;
                }
                
                // Guardar XML importado
                const xmlGuardado = await guardarXMLImportado(xmlContent, infoCFDI, file.name);
                if (xmlGuardado.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ XML importado exitosamente<br>
                            <strong>Versi√≥n:</strong> CFDI ${infoCFDI.version}<br>
                            <strong>RFC Emisor:</strong> ${infoCFDI.emisor.rfc}<br>
                            <strong>Serie-Folio:</strong> ${infoCFDI.serie || ''}-${infoCFDI.folio}<br>
                            <strong>Total:</strong> $${parseFloat(infoCFDI.total).toFixed(2)}
                        </div>
                    `;
                    
                    // Actualizar lista de XMLs inmediatamente
                    console.log('üîÑ Actualizando lista de XMLs tras importaci√≥n...');
                    
                    // Recargar XMLs desde localStorage y actualizar variables globales
                    const xmlsActualizados = JSON.parse(localStorage.getItem('cfdi_xmls') || '[]');
                    xmls = xmlsActualizados;
                    todosLosXMLs = [...xmlsActualizados];
                    xmlsFiltrados = [...xmlsActualizados];
                    
                    // Actualizar UI inmediatamente
                    renderXMLs();
                    updateStats();
                    
                    console.log('‚úÖ Lista de XMLs actualizada:', xmls.length, 'XMLs encontrados');
                    
                    setTimeout(() => {
                        closeImportXMLModal();
                        showTab('xmls');
                    }, 2000);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">‚ùå Error guardando XML: ${xmlGuardado.message}</div>`;
                }
                
            } catch (error) {
                console.error('‚ùå Error importando XML:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">‚ùå Error cr√≠tico: ${error.message}</div>`;
            }
        }
        
        // Funci√≥n para leer archivo XML
        function leerArchivoXML(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Error leyendo archivo'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // Funci√≥n para validar estructura XML
        function validarEstructuraXML(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
                
                // Verificar errores de parsing
                const parseError = xmlDoc.getElementsByTagName('parsererror');
                if (parseError.length > 0) {
                    return { valido: false, error: 'XML mal formado' };
                }
                
                // Verificar que sea un CFDI
                const comprobante = xmlDoc.getElementsByTagName('cfdi:Comprobante')[0];
                if (!comprobante) {
                    return { valido: false, error: 'No es un XML de CFDI v√°lido' };
                }
                
                return { valido: true, xmlDoc };
            } catch (error) {
                return { valido: false, error: error.message };
            }
        }
        
        // Funci√≥n para extraer informaci√≥n del CFDI
        function extraerInformacionCFDI(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
                const comprobante = xmlDoc.getElementsByTagName('cfdi:Comprobante')[0];
                
                if (!comprobante) {
                    return { valido: false, error: 'No se encontr√≥ el nodo Comprobante' };
                }
                
                const version = comprobante.getAttribute('Version');
                const serie = comprobante.getAttribute('Serie') || '';
                const folio = comprobante.getAttribute('Folio');
                const fecha = comprobante.getAttribute('Fecha');
                const total = comprobante.getAttribute('Total');
                
                // Extraer datos del emisor
                const emisorNode = xmlDoc.getElementsByTagName('cfdi:Emisor')[0];
                const emisor = {
                    rfc: emisorNode ? emisorNode.getAttribute('Rfc') : '',
                    nombre: emisorNode ? emisorNode.getAttribute('Nombre') : ''
                };
                
                // Extraer datos del receptor
                const receptorNode = xmlDoc.getElementsByTagName('cfdi:Receptor')[0];
                const receptor = {
                    rfc: receptorNode ? receptorNode.getAttribute('Rfc') : '',
                    nombre: receptorNode ? receptorNode.getAttribute('Nombre') : ''
                };
                
                // Procesar fecha correctamente (formato SAT: YYYY-MM-DDTHH:mm:ss)
                let fechaProcesada = fecha;
                if (fecha) {
                    try {
                        // La fecha del SAT viene en formato ISO, convertir a fecha legible
                        const fechaObj = new Date(fecha);
                        if (!isNaN(fechaObj.getTime())) {
                            fechaProcesada = fechaObj.toISOString();
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error procesando fecha:', fecha, e);
                        fechaProcesada = new Date().toISOString(); // Fecha actual como fallback
                    }
                }
                
                return {
                    valido: true,
                    version,
                    serie,
                    folio,
                    fecha: fechaProcesada,
                    total,
                    emisor,
                    receptor
                };
            } catch (error) {
                return { valido: false, error: error.message };
            }
        }
        
        // Funci√≥n para validar contra XSD (simulada por ahora)
        async function validarContraXSD(xmlContent, version) {
            // Por ahora simulamos la validaci√≥n XSD
            // En el futuro aqu√≠ se implementar√° la validaci√≥n real contra los XSD
            console.log(`üîç Validando XML contra XSD de CFDI ${version}...`);
            
            // Simulaci√≥n de validaci√≥n
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Validaciones b√°sicas
            if (!xmlContent.includes('xmlns:cfdi')) {
                return { valido: false, error: 'Namespace CFDI faltante' };
            }
            
            if (version === '4.0' && !xmlContent.includes('cfdv40.xsd')) {
                return { valido: false, error: 'Schema XSD incorrecto para CFDI 4.0' };
            }
            
            if (version === '3.3' && !xmlContent.includes('cfdv33.xsd')) {
                return { valido: false, error: 'Schema XSD incorrecto para CFDI 3.3' };
            }
            
            return { valido: true };
        }
        
        // Funci√≥n para guardar XML importado
        async function guardarXMLImportado(xmlContent, infoCFDI, nombreArchivo) {
            try {
                const xmlData = {
                    id: 'imported-' + Date.now(),
                    fecha_creacion: new Date().toISOString(),
                    version_cfdi: infoCFDI.version,
                    serie: infoCFDI.serie,
                    folio: infoCFDI.folio,
                    emisor_rfc: infoCFDI.emisor.rfc,
                    emisor_nombre: infoCFDI.emisor.nombre,
                    receptor_rfc: infoCFDI.receptor.rfc,
                    receptor_nombre: infoCFDI.receptor.nombre,
                    total: infoCFDI.total,
                    xml_content: xmlContent,
                    estado: 'importado',
                    nombre_archivo: nombreArchivo,
                    tipo: 'importado'
                };
                
                // Guardar en localStorage
                const xmlsGuardados = JSON.parse(localStorage.getItem('cfdi_xmls') || '[]');
                xmlsGuardados.push(xmlData);
                localStorage.setItem('cfdi_xmls', JSON.stringify(xmlsGuardados));
                
                console.log('‚úÖ XML importado guardado en localStorage');
                return { success: true, data: xmlData };
            } catch (error) {
                console.error('‚ùå Error guardando XML importado:', error);
                return { success: false, message: error.message };
            }
        }
        
        // Funci√≥n para abrir el editor completo de XML
        function abrirEditorXML(xmlId) {
            const xml = xmls.find(x => x.id === xmlId);
            if (!xml) {
                showAlert('‚ùå Error: XML no encontrado', 'error');
                return;
            }
            
            if (xml.estado === 'sellado') {
                showAlert('‚ö†Ô∏è No se puede editar un XML sellado', 'warning');
                return;
            }
            
            console.log('üìù Abriendo editor completo para XML:', xmlId);
            
            // Crear modal de edici√≥n completa
            const modal = document.createElement('div');
            modal.id = 'xmlEditorModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 95%; max-height: 95%; overflow-y: auto;">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Editar XML CFDI - ${xml.serie || ''}-${xml.folio}</h2>
                        <span class="close" onclick="cerrarEditorXML()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="xml-editor-container">
                            ${crearFormularioEdicion(xml)}
                        </div>
                        <div class="modal-actions" style="margin-top: 20px; text-align: center;">
                            <button type="button" class="btn btn-success" onclick="guardarCambiosXML('${xmlId}')">
                                üíæ Guardar Cambios
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cerrarEditorXML()">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cargar cat√°logos si es necesario
            cargarCatalogosEditor();
        }
        
        // Funci√≥n para crear el formulario de edici√≥n completo
        function crearFormularioEdicion(xml) {
            return `
                <form id="xmlEditorForm" class="xml-editor-form">
                    <!-- Informaci√≥n General -->
                    <div class="form-section">
                        <h3>üìã Informaci√≥n General</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Versi√≥n CFDI:</label>
                                <select id="editVersionCfdi" class="form-control" onchange="cambiarVersionEdicion()">
                                    <option value="3.3" ${xml.version_cfdi === '3.3' ? 'selected' : ''}>CFDI 3.3</option>
                                    <option value="4.0" ${xml.version_cfdi === '4.0' ? 'selected' : ''}>CFDI 4.0</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Serie:</label>
                                <input type="text" id="editSerie" class="form-control" value="${xml.serie || ''}">
                            </div>
                            <div class="form-group">
                                <label>Folio:</label>
                                <input type="text" id="editFolio" class="form-control" value="${xml.folio || ''}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="datetime-local" id="editFecha" class="form-control" value="${formatearFechaParaInput(xml.fecha_creacion)}" required>
                            </div>
                            <div class="form-group">
                                <label>M√©todo de Pago:</label>
                                <select id="editMetodoPago" class="form-control" required>
                                    <option value="">Seleccionar m√©todo de pago</option>
                                    <option value="PUE" ${xml.metodo_pago === 'PUE' ? 'selected' : ''}>PUE - Pago en una sola exhibici√≥n</option>
                                    <option value="PPD" ${xml.metodo_pago === 'PPD' ? 'selected' : ''}>PPD - Pago en parcialidades o diferido</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Emisor -->
                    <div class="form-section">
                        <h3>üè¢ Datos del Emisor</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>RFC Emisor:</label>
                                <input type="text" id="editEmisorRfc" class="form-control" value="${xml.emisor_rfc || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre/Raz√≥n Social:</label>
                                <input type="text" id="editEmisorNombre" class="form-control" value="${xml.emisor_nombre || ''}" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Receptor -->
                    <div class="form-section">
                        <h3>üë§ Datos del Receptor</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>RFC Receptor:</label>
                                <input type="text" id="editReceptorRfc" class="form-control" value="${xml.receptor_rfc || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre/Raz√≥n Social:</label>
                                <input type="text" id="editReceptorNombre" class="form-control" value="${xml.receptor_nombre || ''}" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conceptos -->
                    <div class="form-section">
                        <h3>üì¶ Conceptos</h3>
                        <div id="editConceptosContainer">
                            ${crearConceptosEdicion(xml)}
                        </div>
                        <button type="button" class="btn btn-primary" onclick="agregarConceptoEdicion()">
                            ‚ûï Agregar Concepto
                        </button>
                    </div>
                    
                    <!-- Totales -->
                    <div class="form-section">
                        <h3>üí∞ Totales</h3>
                        <div class="totales-display">
                            <div class="total-item">
                                <label>Subtotal:</label>
                                <span id="editSubtotal">$0.00</span>
                            </div>
                            <div class="total-item">
                                <label>IVA:</label>
                                <span id="editIva">$0.00</span>
                            </div>
                            <div class="total-item">
                                <label>Total:</label>
                                <span id="editTotal">$${parseFloat(xml.total || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </form>
            `;
        }
        
        // Funci√≥n para formatear fecha para input datetime-local
        function formatearFechaParaInput(fecha) {
            if (!fecha) return '';
            try {
                const fechaObj = new Date(fecha);
                return fechaObj.toISOString().slice(0, 16);
            } catch (e) {
                return '';
            }
        }
        
        // Funci√≥n para crear conceptos en modo edici√≥n
        function crearConceptosEdicion(xml) {
            // Por ahora, crear un concepto b√°sico
            // En una implementaci√≥n completa, aqu√≠ se cargar√≠an los conceptos del XML
            return `
                <div class="concepto-item" data-concepto-id="1">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <input type="text" class="form-control concepto-descripcion" value="Producto/Servicio" required>
                        </div>
                        <div class="form-group">
                            <label>Cantidad:</label>
                            <input type="number" class="form-control concepto-cantidad" value="1" min="1" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Valor Unitario:</label>
                            <input type="number" class="form-control concepto-valor" value="${xml.total || 0}" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-danger" onclick="eliminarConceptoEdicion(this)">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Funci√≥n para cerrar el editor
        function cerrarEditorXML() {
            const modal = document.getElementById('xmlEditorModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Funci√≥n para guardar cambios del XML
        function guardarCambiosXML(xmlId) {
            try {
                const xmlIndex = xmls.findIndex(xml => xml.id === xmlId);
                if (xmlIndex === -1) {
                    showAlert('‚ùå Error: XML no encontrado', 'error');
                    return;
                }
                
                // Obtener datos del formulario
                const datosActualizados = {
                    version_cfdi: document.getElementById('editVersionCfdi').value,
                    serie: document.getElementById('editSerie').value,
                    folio: document.getElementById('editFolio').value,
                    fecha_creacion: new Date(document.getElementById('editFecha').value).toISOString(),
                    metodo_pago: document.getElementById('editMetodoPago').value,
                    emisor_rfc: document.getElementById('editEmisorRfc').value,
                    emisor_nombre: document.getElementById('editEmisorNombre').value,
                    receptor_rfc: document.getElementById('editReceptorRfc').value,
                    receptor_nombre: document.getElementById('editReceptorNombre').value,
                    total: document.getElementById('editTotal').textContent.replace('$', '')
                };
                
                // Validar campos obligatorios
                if (!datosActualizados.folio || !datosActualizados.emisor_rfc || !datosActualizados.receptor_rfc) {
                    showAlert('‚ö†Ô∏è Complete todos los campos obligatorios', 'error');
                    return;
                }
                
                // Actualizar XML
                Object.assign(xmls[xmlIndex], datosActualizados);
                
                // Guardar en localStorage
                localStorage.setItem('cfdi_xmls', JSON.stringify(xmls));
                
                // Actualizar variables globales
                todosLosXMLs = [...xmls];
                xmlsFiltrados = [...xmls];
                
                // Recargar tabla
                renderXMLs();
                
                // Cerrar modal
                cerrarEditorXML();
                
                showAlert('‚úÖ XML actualizado correctamente', 'success');
                console.log('üìù XML actualizado:', xmlId);
                
            } catch (error) {
                console.error('‚ùå Error guardando cambios:', error);
                showAlert('‚ùå Error guardando cambios: ' + error.message, 'error');
            }
        }
        
        // Funciones auxiliares para el editor
        function cambiarVersionEdicion() {
            // L√≥gica para cambiar campos seg√∫n versi√≥n
            console.log('üîÑ Cambiando versi√≥n en editor');
        }
        
        function cargarCatalogosEditor() {
            // Cargar cat√°logos necesarios para el editor
            console.log('üìö Cargando cat√°logos para editor');
        }
        
        function agregarConceptoEdicion() {
            showAlert('üîß Funci√≥n en desarrollo', 'info');
        }
        
        function eliminarConceptoEdicion(button) {
            button.closest('.concepto-item').remove();
        }
        
        // Variables globales para el modal XML
        let xmlActualViewing = null;
        
        // Funci√≥n para ver contenido del XML
        function viewXML(xmlId) {
            try {
                // üîç OBTENER XMLs DE TODAS LAS FUENTES
                const xmlsFromStorage = JSON.parse(localStorage.getItem('xmls_generados') || '[]');
                const xml = xmlsFromStorage.find(x => x.id === xmlId);
                
                console.log('üîç Buscando XML ID:', xmlId, 'Total XMLs:', xmlsFromStorage.length);
                
                if (!xml) {
                    showAlert('‚ùå Error: XML no encontrado', 'error');
                    console.error('‚ùå XML no encontrado. ID buscado:', xmlId);
                    return;
                }
                
                console.log('‚úÖ XML encontrado:', xml.serie, xml.folio);
                xmlActualViewing = xml;
                
                // Mostrar informaci√≥n del XML
                document.getElementById('xmlInfo').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>üìÑ Serie-Folio:</strong> ${xml.serie || ''}-${xml.folio}</div>
                        <div><strong>üè¢ Emisor:</strong> ${xml.emisor_nombre || xml.emisor_rfc || 'N/A'}</div>
                        <div><strong>üë§ Receptor:</strong> ${xml.receptor_nombre || xml.receptor_rfc || 'N/A'}</div>
                        <div><strong>üí∞ Total:</strong> $${parseFloat(xml.total || 0).toFixed(2)}</div>
                        <div><strong>üìÖ Fecha:</strong> ${xml.fecha ? new Date(xml.fecha).toLocaleString() : 'N/A'}</div>
                        <div><strong>üîñ Estado:</strong> <span class="badge badge-${getEstadoBadgeClass(xml.estado || 'generado')}">${xml.estado || 'generado'}</span></div>
                    </div>
                `;
                
                // Mostrar contenido XML
                const xmlContent = xml.xml_content || xml.contenido_xml || 'No hay contenido XML disponible';
                document.getElementById('xmlContent').textContent = xmlContent;
                
                // Mostrar modal
                document.getElementById('xmlModal').style.display = 'block';
                
                addLog('info', `XML visualizado: ${xml.serie || ''}-${xml.folio}`);
                console.log('üëÅÔ∏è Mostrando XML:', xmlId);
            } catch (error) {
                console.error('‚ùå Error al mostrar XML:', error);
                addLog('error', 'Error al mostrar XML', { xmlId, error: error.message });
                showAlert('‚ùå Error al mostrar el XML', 'error');
            }
        }
        
        // Funci√≥n para cerrar modal XML
        function cerrarModalXML() {
            document.getElementById('xmlModal').style.display = 'none';
            xmlActualViewing = null;
        }
        
        // Funci√≥n para copiar XML actual
        function copiarXMLActual() {
            if (xmlActualViewing) {
                const xmlContent = xmlActualViewing.xml_content || xmlActualViewing.contenido_xml || '';
                copyToClipboard(xmlContent);
            }
        }
        
        // Funci√≥n para descargar XML actual
        function descargarXMLActual() {
            if (xmlActualViewing) {
                downloadXML(xmlActualViewing.id);
            }
        }
        
        // Funci√≥n para editar XML (redirigir al generador)
        function editXML(xmlId) {
            const xml = xmls.find(x => x.id === xmlId);
            if (!xml) {
                showAlert('‚ùå Error: XML no encontrado', 'error');
                return;
            }
            
            if (xml.estado === 'sellado') {
                showAlert('‚ö†Ô∏è No se puede editar un XML sellado', 'warning');
                return;
            }
            
            // Guardar datos del XML en localStorage para cargar en el generador
            localStorage.setItem('cfdi_edit_data', JSON.stringify(xml));
            
            // Redirigir al generador
            window.location.href = '/generator?edit=' + xmlId;
        }
        
        // Funci√≥n para mostrar alertas al usuario
        function showAlert(message, type = 'info') {
            console.log(`üîî ALERT [${type.toUpperCase()}]: ${message}`);
            
            // Crear elemento de alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                padding: 15px 20px;
                border-radius: 8px;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
            `;
            
            // Estilos seg√∫n tipo
            const styles = {
                'success': 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;',
                'error': 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;',
                'warning': 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;',
                'info': 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;'
            };
            
            alertDiv.style.cssText += styles[type] || styles['info'];
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: 10px;">&times;</button>
                </div>
            `;
            
            // Agregar al DOM
            document.body.appendChild(alertDiv);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Funci√≥n auxiliar para copiar al portapapeles
        function copyToClipboard(text) {
            if (!text) {
                console.warn('‚ùå No hay contenido para copiar');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                console.log('‚úÖ XML copiado al portapapeles');
                showAlert('‚úÖ XML copiado al portapapeles', 'success');
            }).catch(err => {
                console.error('Error copiando al portapapeles:', err);
                showAlert('‚ùå Error copiando al portapapeles', 'error');
            });
        }
        
        console.log('‚úÖ CFDI SYSTEM: Dashboard JavaScript cargado completamente');
    </script>

</body>
</html>
