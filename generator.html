<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">üöÄ Generador CFDI - Sistema Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header-nav { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .header-nav .btn { padding: 8px 16px; font-size: 14px; }
        .version-selector { background: #f8f9fa; padding: 20px; border-bottom: 2px solid #e9ecef; }
        .version-warning { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 15px; color: #856404; display: none; }
        .content { padding: 30px; }
        .form-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 25px; border-left: 4px solid #007bff; }
        .form-section h3 { color: #2c3e50; margin-bottom: 20px; font-size: 1.3rem; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #495057; margin-bottom: 8px; }
        .form-group input, .form-group select { padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; }
        .btn:hover { transform: translateY(-2px); }
        .conceptos-container { margin-top: 25px; }
        .concepto-item { background: white; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; margin-bottom: 15px; position: relative; }
        .concepto-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .concepto-title { font-weight: 600; color: #2c3e50; }
        .btn-remove { background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 14px; }
        .totales { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 25px; border-radius: 10px; margin: 25px 0; }
        .totales h3 { margin-bottom: 15px; }
        .totales-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .total-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; }
        .total-label { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        .total-value { font-size: 1.4rem; font-weight: 700; }
        .xml-output { background: #2d3748; color: #e2e8f0; padding: 25px; border-radius: 10px; margin-top: 25px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; }
        .actions { text-align: center; margin: 30px 0; }
        .actions .btn { margin: 0 10px; }
        .save-options { background: #e8f5e8; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .save-options h4 { color: #155724; margin-bottom: 15px; }
        .save-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-info { background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .alert { padding: 12px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-nav">
                <a href="/dashboard.html" class="btn btn-secondary">üìÑ Dashboard</a>
                <button onclick="logout()" class="btn btn-danger">üö™ Salir</button>
            </div>
            <h1 id="mainTitle">üöÄ Generador CFDI - Sistema Completo</h1>
            <p>Generador integrado con almacenamiento autom√°tico</p>
        </div>

        <!-- Info del usuario logueado -->
        <div id="userInfo" class="user-info" style="display: none;">
            <strong>Usuario:</strong> <span id="currentUserName"></span> | 
            <strong>Email:</strong> <span id="currentUserEmail"></span>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <div class="version-selector">
            <div class="form-group">
                <label for="versionCfdi">üîß Seleccionar Versi√≥n CFDI:</label>
                <select id="versionCfdi" onchange="cambiarVersionCfdi()">
                    <option value="4.0">CFDI 4.0 (Actual)</option>
                    <option value="3.3">CFDI 3.3 (Legacy)</option>
                </select>
            </div>
            <div id="versionWarning" class="version-warning">
                ‚ö†Ô∏è <strong>Versi√≥n 3.3:</strong> Esta es una versi√≥n legacy. Se recomienda usar CFDI 4.0 para nuevos comprobantes.
            </div>
        </div>

        <div class="content">
            <!-- Datos Generales -->
            <div class="form-section">
                <h3>üìã Datos Generales del Comprobante</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="serie">Serie</label>
                        <input type="text" id="serie" placeholder="A">
                    </div>
                    <div class="form-group">
                        <label for="folio">Folio *</label>
                        <input type="text" id="folio" placeholder="Ej: 1, 123, A001" maxlength="40" required>
                    </div>
                    <div class="form-group">
                        <label for="fecha">Fecha y Hora *</label>
                        <input type="datetime-local" id="fecha" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="metodoPago">M√©todo de Pago *</label>
                        <select id="metodoPago" required>
                            <option value="">Seleccionar m√©todo de pago</option>
                            <option value="PUE">PUE - Pago en una sola exhibici√≥n</option>
                            <option value="PPD">PPD - Pago en parcialidades o diferido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="formaPago">Forma de Pago *</label>
                        <select id="formaPago" required>
                            <option value="">Seleccionar forma de pago</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Datos del Emisor -->
            <div class="form-section">
                <h3>üë§ Datos del Emisor</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorSelect">Seleccionar Emisor Registrado</label>
                        <select id="emisorSelect" onchange="cargarDatosEmisor()">
                            <option value="">Seleccionar emisor o llenar manualmente</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorRfc">RFC del Emisor *</label>
                        <input type="text" id="emisorRfc" placeholder="RFC123456789" required>
                    </div>
                    <div class="form-group">
                        <label for="emisorNombre">Nombre/Raz√≥n Social *</label>
                        <input type="text" id="emisorNombre" placeholder="Empresa S.A. de C.V." required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorCodigoPostal">C√≥digo Postal *</label>
                        <input type="text" id="emisorCodigoPostal" placeholder="06000" maxlength="5" pattern="[0-9]{5}" required>
                    </div>
                    <div class="form-group">
                        <label for="emisorRegimenFiscal">R√©gimen Fiscal *</label>
                        <select id="emisorRegimenFiscal" required>
                            <option value="">Seleccionar r√©gimen fiscal</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Datos del Receptor -->
            <div class="form-section">
                <h3>üè¢ Datos del Receptor</h3>
                
                <!-- Selector de Receptor Guardado -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptorGuardado">Receptor Guardado</label>
                        <select id="receptorGuardado" onchange="cargarReceptorGuardado()">
                            <option value="">Seleccionar receptor guardado o capturar manualmente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-info" onclick="gestionarReceptores()" style="margin-top: 25px;">üìã Gestionar Receptores</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptorRfc">RFC del Receptor *</label>
                        <input type="text" id="receptorRfc" placeholder="XAXX010101000" required>
                    </div>
                    <div class="form-group">
                        <label for="receptorNombre">Nombre/Raz√≥n Social *</label>
                        <input type="text" id="receptorNombre" placeholder="Cliente S.A. de C.V." required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptorCodigoPostal">C√≥digo Postal *</label>
                        <input type="text" id="receptorCodigoPostal" placeholder="06000" maxlength="5" pattern="[0-9]{5}" required>
                    </div>
                    <div class="form-group">
                        <label for="receptorRegimenFiscal">R√©gimen Fiscal *</label>
                        <select id="receptorRegimenFiscal" required>
                            <option value="">Seleccionar r√©gimen fiscal</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="usoCfdi">Uso de CFDI *</label>
                        <select id="usoCfdi" required>
                            <option value="">Seleccionar uso de CFDI</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Datos Adicionales eliminados: ObjetoImp ahora solo va por concepto -->

            <!-- Conceptos -->
            <div class="form-section">
                <h3>üõçÔ∏è Conceptos</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="conceptoDescripcion">Descripci√≥n *</label>
                        <input type="text" id="conceptoDescripcion" placeholder="Descripci√≥n del producto o servicio">
                    </div>
                    <div class="form-group">
                        <label for="conceptoCantidad">Cantidad *</label>
                        <input type="number" id="conceptoCantidad" placeholder="1" min="0.01" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="conceptoValorUnitario">Valor Unitario *</label>
                        <input type="number" id="conceptoValorUnitario" placeholder="100.00" min="0.01" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="conceptoClaveUnidad">Clave Unidad *</label>
                        <select id="conceptoClaveUnidad">
                            <option value="">Seleccionar unidad</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="conceptoClaveProducto">Clave Producto/Servicio *</label>
                        <input type="text" id="conceptoClaveProducto" placeholder="12345678" maxlength="8" pattern="[0-9]{8}">
                    </div>
                    <div class="form-group">
                        <label for="conceptoImpuesto">Impuesto</label>
                        <select id="conceptoImpuesto">
                            <option value="">Sin impuesto</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="conceptoObjetoImpGroup" style="display: none;">
                    <div class="form-group">
                        <label for="conceptoObjetoImp">Objeto de Impuesto (CFDI 4.0) *</label>
                        <select id="conceptoObjetoImp">
                            <option value="">Seleccionar objeto de impuesto</option>
                            <option value="01">01 - No objeto de impuesto</option>
                            <option value="02">02 - S√≠ objeto de impuesto</option>
                            <option value="03">03 - S√≠ objeto de impuesto y no obligado al desglose</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <!-- Espacio para mantener el dise√±o -->
                    </div>
                </div>
                <div class="actions">
                    <button type="button" class="btn btn-primary" onclick="agregarConcepto()">‚û• Agregar Concepto</button>
                </div>

                <div class="conceptos-container" id="conceptosContainer">
                    <!-- Los conceptos se agregar√°n aqu√≠ din√°micamente -->
                </div>
            </div>

            <!-- Totales -->
            <div class="totales">
                <h3>üí∞ Totales</h3>
                <div class="totales-grid">
                    <div class="total-item">
                        <div class="total-label">Subtotal</div>
                        <div class="total-value" id="subtotalValue">$0.00</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">IVA</div>
                        <div class="total-value" id="ivaValue">$0.00</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Total</div>
                        <div class="total-value" id="totalValue">$0.00</div>
                    </div>
                </div>
            </div>

            <!-- Opciones de Guardado -->
            <div class="save-options">
                <h4>üíæ Opciones de Guardado</h4>
                <div class="save-checkbox">
                    <input type="checkbox" id="autoSave" checked>
                    <label for="autoSave">Guardar autom√°ticamente en mi cuenta</label>
                </div>
                <div class="save-checkbox">
                    <input type="checkbox" id="downloadXml" checked>
                    <label for="downloadXml">Descargar XML al generar</label>
                </div>
            </div>

            <!-- Acciones -->
            <div class="actions">
                <button type="button" class="btn btn-success" onclick="generarXML()">üöÄ Generar XML</button>
                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">üßπ Limpiar</button>
                <button type="button" class="btn btn-danger" onclick="cancelarEdicion()">‚ùå Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="descargarXML()" id="btnDescargar" style="display: none;">üìÖ Descargar XML</button>
            </div>

            <!-- Salida XML -->
            <div id="xmlOutput" class="xml-output" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let conceptos = [];
        let conceptoCounter = 0;
        let xmlGenerado = '';
        let currentUser = null;
        let emisoresUsuario = [];

        // Cat√°logos SAT
        const catalogos = {
            formaPago: {
                '01': 'Efectivo',
                '02': 'Cheque Nominativo',
                '03': 'Transferencia Electr√≥nica de Fondos SPEI',
                '04': 'Tarjeta de Cr√©dito',
                '05': 'Monedero Electr√≥nico',
                '06': 'Dinero Electr√≥nico',
                '08': 'Vales de Despensa',
                '12': 'Daci√≥n en Pago',
                '13': 'Pago por Subrogaci√≥n',
                '14': 'Pago por Consignaci√≥n',
                '15': 'Condonaci√≥n',
                '17': 'Compensaci√≥n',
                '23': 'Novaci√≥n',
                '24': 'Confusi√≥n',
                '25': 'Remisi√≥n de Deuda',
                '26': 'Prescripci√≥n o Caducidad',
                '27': 'A Satisfacci√≥n del Acreedor',
                '28': 'Tarjeta de D√©bito',
                '29': 'Tarjeta de Servicios',
                '30': 'Aplicaci√≥n de Anticipos',
                '31': 'Intermediario Pagos',
                '99': 'Por Definir'
            },
            claveUnidad: {
                'H87': 'Pieza',
                'E48': 'Unidad de servicio',
                'ACT': 'Actividad',
                'E51': 'Trabajo',
                'A9': 'Tarifa',
                'MTR': 'Metro',
                'KGM': 'Kilogramo',
                'LTR': 'Litro',
                'HUR': 'Hora',
                'DAY': 'D√≠a',
                'MON': 'Mes',
                'ANN': 'A√±o'
            },
            impuestos: {
                '001': 'ISR',
                '002': 'IVA',
                '003': 'IEPS'
            },
            usoCfdi: {
                'G01': 'Adquisici√≥n de mercanc√≠as',
                'G02': 'Devoluciones, descuentos o bonificaciones',
                'G03': 'Gastos en general',
                'I01': 'Construcciones',
                'I02': 'Mobiliario y equipo de oficina por inversiones',
                'I03': 'Equipo de transporte',
                'I04': 'Equipo de computo y accesorios',
                'I05': 'Dados, troqueles, moldes, matrices y herramental',
                'I06': 'Comunicaciones telef√≥nicas',
                'I07': 'Comunicaciones satelitales',
                'I08': 'Otra maquinaria y equipo',
                'D01': 'Honorarios m√©dicos, dentales y gastos hospitalarios',
                'D02': 'Gastos m√©dicos por incapacidad o discapacidad',
                'D03': 'Gastos funerales',
                'D04': 'Donativos',
                'D05': 'Intereses reales efectivamente pagados por cr√©ditos hipotecarios',
                'D06': 'Aportaciones voluntarias al SAR',
                'D07': 'Primas por seguros de gastos m√©dicos',
                'D08': 'Gastos de transportaci√≥n escolar obligatoria',
                'D09': 'Dep√≥sitos en cuentas para el ahorro, primas que tengan como base planes de pensiones',
                'D10': 'Pagos por servicios educativos',
                'P01': 'Por definir',
                'S01': 'Sin efectos fiscales',
                'CP01': 'Pagos',
                'CN01': 'N√≥mina'
            },
            regimenFiscal33: {
                '601': 'General de Ley Personas Morales',
                '603': 'Personas Morales con Fines no Lucrativos',
                '605': 'Sueldos y Salarios e Ingresos Asimilados a Salarios',
                '606': 'Arrendamiento',
                '608': 'Dem√°s ingresos',
                '609': 'Consolidaci√≥n',
                '610': 'Residentes en el Extranjero sin Establecimiento Permanente en M√©xico',
                '611': 'Ingresos por Dividendos (socios y accionistas)',
                '612': 'Personas F√≠sicas con Actividades Empresariales y Profesionales',
                '614': 'Ingresos por intereses',
                '616': 'Sin obligaciones fiscales',
                '620': 'Sociedades Cooperativas de Producci√≥n que optan por diferir sus ingresos',
                '621': 'Incorporaci√≥n Fiscal',
                '622': 'Actividades Agr√≠colas, Ganaderas, Silv√≠colas y Pesqueras',
                '623': 'Opcional para Grupos de Sociedades',
                '624': 'Coordinados',
                '628': 'Hidrocarburos',
                '607': 'R√©gimen de Enajenaci√≥n o Adquisici√≥n de Bienes',
                '629': 'De los Reg√≠menes Fiscales Preferentes y de las Empresas Multinacionales',
                '630': 'Enajenaci√≥n de acciones en bolsa de valores'
            },
            regimenFiscal40: {
                '601': 'General de Ley Personas Morales',
                '603': 'Personas Morales con Fines no Lucrativos',
                '605': 'Sueldos y Salarios e Ingresos Asimilados a Salarios',
                '606': 'Arrendamiento',
                '607': 'R√©gimen de Enajenaci√≥n o Adquisici√≥n de Bienes',
                '608': 'Dem√°s ingresos',
                '610': 'Residentes en el Extranjero sin Establecimiento Permanente en M√©xico',
                '611': 'Ingresos por Dividendos (socios y accionistas)',
                '612': 'Personas F√≠sicas con Actividades Empresariales y Profesionales',
                '614': 'Ingresos por intereses',
                '615': 'R√©gimen de los ingresos por obtenci√≥n de premios',
                '616': 'Sin obligaciones fiscales',
                '620': 'Sociedades Cooperativas de Producci√≥n que optan por diferir sus ingresos',
                '621': 'Incorporaci√≥n Fiscal',
                '622': 'Actividades Agr√≠colas, Ganaderas, Silv√≠colas y Pesqueras',
                '623': 'Opcional para Grupos de Sociedades',
                '624': 'Coordinados',
                '625': 'R√©gimen de las Actividades Empresariales con ingresos a trav√©s de Plataformas Tecnol√≥gicas',
                '626': 'R√©gimen Simplificado de Confianza'
            }
        };

        // Verificar autenticaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            await verificarAutenticacion();
            await cargarEmisores();
            inicializarAplicacion();
            
            // üéØ ACTIVAR LISTENERS PARA REGLAS AUTOM√ÅTICAS
            // Listener para regla de pagos diferidos
            const metodoPagoSelect = document.getElementById('metodoPago');
            if (metodoPagoSelect) {
                metodoPagoSelect.addEventListener('change', aplicarReglaPagosDiferidos);
                console.log('‚úÖ Listener para regla pagos diferidos activado');
            }
            
            // Aplicar regla inicial si ya hay valor seleccionado
            aplicarReglaPagosDiferidos();
        });

        // Funci√≥n para verificar autenticaci√≥n
        async function verificarAutenticacion() {
            const token = localStorage.getItem('cfdi_token');
            if (!token) {
                // Permitir uso sin login pero con funcionalidad limitada
                showAlert('Usando modo invitado. Para guardar XMLs, <a href="/login">inicia sesi√≥n</a>.', 'info');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ action: 'verify' })
                });

                const data = await response.json();
                if (data.valid) {
                    currentUser = data.user;
                    document.getElementById('userInfo').style.display = 'block';
                    document.getElementById('currentUserName').textContent = currentUser.nombre;
                    document.getElementById('currentUserEmail').textContent = currentUser.email;
                } else {
                    localStorage.removeItem('cfdi_token');
                    localStorage.removeItem('cfdi_user');
                    showAlert('Sesi√≥n expirada. Usando modo invitado.', 'info');
                }
            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                showAlert('Error de conexi√≥n. Usando modo invitado.', 'info');
            }
        }

        // Funci√≥n para cargar emisores del usuario desde base de datos
        async function cargarEmisores() {
            console.log('üè¢ CFDI GENERATOR: Cargando emisores desde base de datos...');
            
            try {
                // Verificar si hay usuario autenticado
                const token = localStorage.getItem('token');
                let emisoresCargados = [];
                
                if (token) {
                    console.log('üîê Usuario autenticado, cargando desde base de datos...');
                    
                    try {
                        // Cargar emisores desde la base de datos
                        const response = await fetch('/.netlify/functions/emisores', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            emisoresCargados = data.emisores || [];
                            console.log(`‚úÖ ${emisoresCargados.length} emisores cargados desde base de datos`);
                            
                            // Guardar en localStorage como cache
                            localStorage.setItem('emisores', JSON.stringify(emisoresCargados));
                            
                        } else {
                            console.warn('‚ö†Ô∏è Error en respuesta de BD, usando localStorage como fallback');
                            throw new Error('Error en respuesta de BD');
                        }
                        
                    } catch (dbError) {
                        console.warn('‚ö†Ô∏è Error conectando a BD, usando localStorage:', dbError.message);
                        
                        // Fallback a localStorage
                        const emisoresLocal = localStorage.getItem('emisores');
                        if (emisoresLocal) {
                            emisoresCargados = JSON.parse(emisoresLocal);
                            console.log(`üìÑ ${emisoresCargados.length} emisores cargados desde localStorage (fallback)`);
                        }
                    }
                    
                } else {
                    console.log('üë§ Sin usuario autenticado, usando localStorage √∫nicamente');
                    
                    // Sin usuario, usar localStorage
                    const emisoresLocal = localStorage.getItem('emisores');
                    if (emisoresLocal) {
                        emisoresCargados = JSON.parse(emisoresLocal);
                        console.log(`üìÑ ${emisoresCargados.length} emisores cargados desde localStorage`);
                    }
                }
                
                // Asignar emisores cargados
                emisoresUsuario = emisoresCargados;
                
                // Actualizar el select de emisores
                const select = document.getElementById('emisorSelect');
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar emisor o llenar manualmente</option>';
                    
                    if (emisoresUsuario.length > 0) {
                        emisoresUsuario.forEach(emisor => {
                            const option = document.createElement('option');
                            option.value = emisor.id;
                            option.textContent = `${emisor.rfc} - ${emisor.razon_social || emisor.nombre}`;
                            select.appendChild(option);
                        });
                        
                        console.log(`‚úÖ Select de emisores actualizado con ${emisoresUsuario.length} opciones`);
                    } else {
                        console.log('üìÑ No hay emisores disponibles para mostrar');
                    }
                    
                } else {
                    console.error('‚ùå Select de emisores no encontrado en el DOM');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando emisores:', error);
                emisoresUsuario = [];
                
                // Intentar mostrar mensaje de error al usuario
                const select = document.getElementById('emisorSelect');
                if (select) {
                    select.innerHTML = '<option value="">Error cargando emisores - Llenar manualmente</option>';
                }
            }
        }

        // Funci√≥n para cargar datos del emisor seleccionado
        function cargarDatosEmisor() {
            const emisorId = document.getElementById('emisorSelect').value;
            if (!emisorId) {
                console.log('üìã No hay emisor seleccionado, limpiando campos...');
                // Limpiar campos si no hay emisor seleccionado
                document.getElementById('emisorRfc').value = '';
                document.getElementById('emisorNombre').value = '';
                document.getElementById('emisorCodigoPostal').value = '';
                document.getElementById('emisorRegimenFiscal').value = '';
                return;
            }

            const emisor = emisoresUsuario.find(e => e.id === emisorId);
            if (emisor) {
                console.log('üè¢ Cargando datos del emisor:', emisor.rfc);
                
                // Cargar datos con compatibilidad para ambas estructuras (BD y localStorage)
                document.getElementById('emisorRfc').value = emisor.rfc || '';
                document.getElementById('emisorNombre').value = emisor.razon_social || emisor.nombre || '';
                document.getElementById('emisorCodigoPostal').value = emisor.codigo_postal || '';
                document.getElementById('emisorRegimenFiscal').value = emisor.regimen_fiscal || '';
                
                console.log('‚úÖ Datos del emisor cargados exitosamente');
            } else {
                console.warn('‚ö†Ô∏è Emisor no encontrado con ID:', emisorId);
            }
        }

        function logout() {
            localStorage.removeItem('cfdi_token');
            localStorage.removeItem('cfdi_user');
            window.location.href = '/';
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Funci√≥n para inicializar la aplicaci√≥n
        function inicializarAplicacion() {
            inicializarFecha();
            cargarCatalogos();
            actualizarRegimenesFiscales();
            cambiarVersionCfdi();
            
            // Verificar si estamos en modo edici√≥n
            verificarModoEdicion();
        }
        
        // Funci√≥n para verificar y manejar el modo edici√≥n
        function verificarModoEdicion() {
            // Verificar par√°metros URL
            const urlParams = new URLSearchParams(window.location.search);
            const modo = urlParams.get('modo');
            const xmlId = urlParams.get('id');
            
            // Verificar sessionStorage
            const xmlEditando = sessionStorage.getItem('xml_editando');
            
            if (modo === 'edicion' && (xmlId || xmlEditando)) {
                console.log('üîÑ Modo edici√≥n detectado');
                
                // Cambiar t√≠tulo de la p√°gina
                document.getElementById('pageTitle').textContent = '‚úèÔ∏è Editar CFDI - Sistema Completo';
                document.querySelector('.header h1').innerHTML = '‚úèÔ∏è Editar Comprobante CFDI';
                
                // Mostrar alerta de modo edici√≥n
                showAlert('üìù Modo edici√≥n activado. Modificando XML existente.', 'info');
                
                // Cargar datos del XML para edici√≥n
                if (xmlEditando) {
                    try {
                        const datosEdicion = JSON.parse(xmlEditando);
                        console.log('üìã Cargando datos para edici√≥n:', datosEdicion);
                        
                        // Pre-poblar formulario con datos del XML
                        setTimeout(() => {
                            prePopularFormulario(datosEdicion.datos);
                        }, 1000); // Esperar a que se carguen los cat√°logos
                        
                    } catch (error) {
                        console.error('‚ùå Error parseando datos de edici√≥n:', error);
                        showAlert('‚ùå Error cargando datos para edici√≥n', 'danger');
                    }
                }
            }
        }
        
        // Funci√≥n para extraer todos los datos del XML content
        function extraerDatosDelXML(xmlContent) {
            console.log('üîç Extrayendo todos los datos del XML...');
            
            const datos = {};
            
            try {
                // Datos b√°sicos del comprobante
                datos.serie = xmlContent.match(/Serie="([^"]*)"/)?.[1] || '';
                datos.folio = xmlContent.match(/Folio="([^"]*)"/)?.[1] || '';
                datos.fecha = xmlContent.match(/Fecha="([^"]*)"/)?.[1] || '';
                datos.formaPago = xmlContent.match(/FormaPago="([^"]*)"/)?.[1] || '';
                datos.metodoPago = xmlContent.match(/MetodoPago="([^"]*)"/)?.[1] || '';
                datos.moneda = xmlContent.match(/Moneda="([^"]*)"/)?.[1] || 'MXN';
                datos.tipoCambio = xmlContent.match(/TipoCambio="([^"]*)"/)?.[1] || '';
                datos.lugarExpedicion = xmlContent.match(/LugarExpedicion="([^"]*)"/)?.[1] || '';
                datos.tipoDeComprobante = xmlContent.match(/TipoDeComprobante="([^"]*)"/)?.[1] || 'I';
                
                // Datos del emisor
                const emisorMatch = xmlContent.match(/<cfdi:Emisor[^>]*>/)?.[0] || '';
                datos.emisorRfc = emisorMatch.match(/Rfc="([^"]*)"/)?.[1] || xmlContent.match(/Rfc="([^"]*)"/)?.[1] || '';
                datos.emisorNombre = emisorMatch.match(/Nombre="([^"]*)"/)?.[1] || '';
                datos.emisorRegimenFiscal = emisorMatch.match(/RegimenFiscal="([^"]*)"/)?.[1] || '';
                
                // C√≥digo postal del emisor (LugarExpedicion ES el c√≥digo postal del emisor)
                datos.emisorCodigoPostal = xmlContent.match(/LugarExpedicion="([^"]*)"/)?.[1] || 
                                         xmlContent.match(/DomicilioFiscal[^>]*CodigoPostal="([^"]*)"/)?.[1] || 
                                         emisorMatch.match(/CodigoPostal="([^"]*)"/)?.[1] || '';
                
                // Datos del receptor
                const receptorMatch = xmlContent.match(/<cfdi:Receptor[^>]*>/)?.[0] || '';
                datos.receptorRfc = receptorMatch.match(/Rfc="([^"]*)"/)?.[1] || '';
                datos.receptorNombre = receptorMatch.match(/Nombre="([^"]*)"/)?.[1] || '';
                
                // C√≥digo postal del receptor (puede estar en diferentes lugares seg√∫n versi√≥n)
                datos.receptorCodigoPostal = receptorMatch.match(/DomicilioFiscalReceptor="([^"]*)"/)?.[1] || 
                                           xmlContent.match(/DomicilioFiscalReceptor="([^"]*)"/)?.[1] || '';
                
                // R√©gimen fiscal del receptor (puede estar en diferentes lugares seg√∫n versi√≥n)
                datos.receptorRegimenFiscal = receptorMatch.match(/RegimenFiscalReceptor="([^"]*)"/)?.[1] || 
                                            xmlContent.match(/RegimenFiscalReceptor="([^"]*)"/)?.[1] || '';
                
                // Uso CFDI
                datos.usoCfdi = receptorMatch.match(/UsoCFDI="([^"]*)"/)?.[1] || 
                               xmlContent.match(/UsoCFDI="([^"]*)"/)?.[1] || '';
                
                // Formatear fecha para input datetime-local
                if (datos.fecha) {
                    const fechaObj = new Date(datos.fecha);
                    if (!isNaN(fechaObj.getTime())) {
                        datos.fechaFormateada = fechaObj.toISOString().slice(0, 16);
                    }
                }
                
                console.log('‚úÖ Datos extra√≠dos del XML:', datos);
                console.log('üîç DEBUG: Datos b√°sicos extra√≠dos:', {
                    serie: datos.serie,
                    folio: datos.folio,
                    fecha: datos.fecha,
                    fechaFormateada: datos.fechaFormateada,
                    formaPago: datos.formaPago,
                    metodoPago: datos.metodoPago
                });
                console.log('üîç DEBUG: Datos emisor extra√≠dos:', {
                    rfc: datos.emisorRfc,
                    nombre: datos.emisorNombre,
                    regimen: datos.emisorRegimenFiscal,
                    codigoPostal: datos.emisorCodigoPostal
                });
                console.log('üîç DEBUG: Datos receptor extra√≠dos:', {
                    rfc: datos.receptorRfc,
                    nombre: datos.receptorNombre,
                    regimen: datos.receptorRegimenFiscal,
                    codigoPostal: datos.receptorCodigoPostal,
                    usoCfdi: datos.usoCfdi
                });
                return datos;
                
            } catch (error) {
                console.error('‚ùå Error extrayendo datos del XML:', error);
                return {};
            }
        }
        
        // Funci√≥n para pre-poblar el formulario con datos del XML
        function prePopularFormulario(xmlData) {
            console.log('üîÑ Pre-poblando formulario con datos:', xmlData);
            console.log('üîç DEBUG: Campos disponibles en xmlData:', Object.keys(xmlData));
            console.log('üîç DEBUG: xml_content disponible:', !!xmlData.xml_content);
            console.log('üîç DEBUG: xml_content length:', xmlData.xml_content?.length || 0);
            
            try {
                let datosExtraidos = {};
                
                // Si tenemos xml_content, extraer todos los datos del XML
                if (xmlData.xml_content) {
                    datosExtraidos = extraerDatosDelXML(xmlData.xml_content);
                }
                
                // Funci√≥n helper para establecer valor de forma segura
                const setValueSafely = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value || '';
                        console.log(`‚úÖ ${elementId}: ${value || '(vac√≠o)'}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Elemento no encontrado: ${elementId}`);
                    }
                };
                
                console.log('üîÑ Estableciendo valores en formulario...');
                
                // Datos b√°sicos del comprobante (priorizar datos extra√≠dos del XML)
                setValueSafely('serie', datosExtraidos.serie || xmlData.serie);
                setValueSafely('folio', datosExtraidos.folio || xmlData.folio);
                setValueSafely('fecha', datosExtraidos.fechaFormateada || xmlData.fecha);
                setValueSafely('formaPago', datosExtraidos.formaPago || xmlData.forma_pago);
                setValueSafely('metodoPago', datosExtraidos.metodoPago || xmlData.metodo_pago);
                setValueSafely('moneda', datosExtraidos.moneda || xmlData.moneda || 'MXN');
                setValueSafely('tipoCambio', datosExtraidos.tipoCambio || xmlData.tipo_cambio);
                // Lugar de expedici√≥n es el c√≥digo postal del emisor (no hay campo separado)
                // setValueSafely('lugarExpedicion', datosExtraidos.lugarExpedicion || xmlData.lugar_expedicion);
                console.log('‚ÑπÔ∏è Lugar de expedici√≥n ser√° el c√≥digo postal del emisor:', datosExtraidos.emisorCodigoPostal || xmlData.emisor_codigo_postal);
                
                // Datos del emisor (priorizar datos extra√≠dos del XML)
                setValueSafely('emisorRfc', datosExtraidos.emisorRfc || xmlData.emisor_rfc);
                setValueSafely('emisorNombre', datosExtraidos.emisorNombre || xmlData.emisor_nombre);
                setValueSafely('emisorRegimenFiscal', datosExtraidos.emisorRegimenFiscal || xmlData.emisor_regimen_fiscal);
                setValueSafely('emisorCodigoPostal', datosExtraidos.emisorCodigoPostal || xmlData.emisor_codigo_postal);
                
                // Datos del receptor (priorizar datos extra√≠dos del XML)
                setValueSafely('receptorRfc', datosExtraidos.receptorRfc || xmlData.receptor_rfc);
                setValueSafely('receptorNombre', datosExtraidos.receptorNombre || xmlData.receptor_nombre);
                setValueSafely('receptorCodigoPostal', datosExtraidos.receptorCodigoPostal || xmlData.receptor_codigo_postal);
                setValueSafely('receptorRegimenFiscal', datosExtraidos.receptorRegimenFiscal || xmlData.receptor_regimen_fiscal);
                setValueSafely('usoCfdi', datosExtraidos.usoCfdi || xmlData.uso_cfdi);
                
                // Parsear y cargar conceptos del XML
                if (xmlData.xml_content) {
                    cargarConceptosDesdeXML(xmlData.xml_content);
                }
                
                // Actualizar totales
                setTimeout(() => {
                    actualizarTotales();
                }, 500);
                
                console.log('‚úÖ Formulario pre-poblado exitosamente');
                showAlert('‚úÖ Datos cargados para edici√≥n', 'success');
                
            } catch (error) {
                console.error('‚ùå Error pre-poblando formulario:', error);
                showAlert('‚ùå Error cargando algunos campos: ' + error.message, 'warning');
            }
        }
        
        // Funci√≥n para extraer y cargar conceptos desde XML
        function cargarConceptosDesdeXML(xmlContent) {
            try {
                console.log('üìã Extrayendo conceptos del XML...');
                console.log('üîç DEBUG: xmlContent recibido:', !!xmlContent);
                console.log('üîç DEBUG: xmlContent length:', xmlContent?.length || 0);
                console.log('üîç DEBUG: xmlContent preview:', xmlContent?.substring(0, 200) || 'VAC√çO');
                
                // Limpiar conceptos existentes
                conceptos = [];
                
                // Buscar todos los conceptos en el XML (solo elementos <cfdi:Concepto>, no <cfdi:Conceptos>)
                const conceptoMatches = xmlContent.match(/<cfdi:Concepto\s[^>]*>/g) || [];
                console.log('üîç DEBUG: conceptoMatches encontrados:', conceptoMatches.length);
                console.log('üîç DEBUG: conceptoMatches array:', conceptoMatches);
                
                conceptoMatches.forEach((match, index) => {
                    console.log(`üîç DEBUG: Procesando match ${index + 1}:`, match);
                    
                    const concepto = {
                        id: Date.now() + index,
                        cantidad: match.match(/Cantidad="([^"]*)"/)?.[1] || '1',
                        claveUnidad: match.match(/ClaveUnidad="([^"]*)"/)?.[1] || 'H87',
                        unidad: match.match(/Unidad="([^"]*)"/)?.[1] || 'Pieza',
                        claveProdServ: match.match(/ClaveProdServ="([^"]*)"/)?.[1] || '01010101',
                        claveProdServNombre: 'Producto/Servicio',
                        claveProducto: match.match(/ClaveProdServ="([^"]*)"/)?.[1] || '01010101',
                        noIdentificacion: match.match(/NoIdentificacion="([^"]*)"/)?.[1] || '',
                        descripcion: match.match(/Descripcion="([^"]*)"/)?.[1] || '',
                        valorUnitario: parseFloat(match.match(/ValorUnitario="([^"]*)"/)?.[1] || '0') || 0,
                        importe: parseFloat(match.match(/Importe="([^"]*)"/)?.[1] || '0') || 0,
                        descuento: parseFloat(match.match(/Descuento="([^"]*)"/)?.[1] || '0') || 0,
                        objetoImp: match.match(/ObjetoImp="([^"]*)"/)?.[1] || '02',
                        impuesto: {
                            codigo: '002',
                            nombre: 'IVA',
                            tasa: 0.16,
                            tipoFactor: 'Tasa',
                            importe: 0
                        }
                    };
                    
                    console.log(`üîç DEBUG: Concepto ${index + 1} extra√≠do:`, {
                        descripcion: concepto.descripcion,
                        importe: concepto.importe,
                        valorUnitario: concepto.valorUnitario,
                        cantidad: concepto.cantidad
                    });
                    
                    // Calcular impuesto de forma segura
                    const baseImponible = (concepto.importe || 0) - (concepto.descuento || 0);
                    concepto.impuesto.importe = baseImponible * (concepto.impuesto.tasa || 0.16);
                    
                    // VALIDACI√ìN: Solo agregar conceptos v√°lidos (con importe > 0 y descripci√≥n)
                    if (concepto.importe > 0 && concepto.descripcion && concepto.descripcion.trim() !== '') {
                        conceptos.push(concepto);
                        console.log(`‚úÖ Concepto v√°lido agregado: ${concepto.descripcion} - $${concepto.importe}`);
                    } else {
                        console.log(`‚ö†Ô∏è Concepto inv√°lido omitido: importe=${concepto.importe}, descripcion='${concepto.descripcion}'`);
                    }
                });
                
                console.log(`‚úÖ ${conceptos.length} conceptos extra√≠dos del XML`);
                
                // Renderizar conceptos en la UI
                renderizarConceptos();
                
            } catch (error) {
                console.error('‚ùå Error extrayendo conceptos del XML:', error);
                showAlert('‚ö†Ô∏è Error cargando conceptos del XML', 'warning');
            }
        }

        // Funci√≥n para inicializar fecha y hora actual
        function inicializarFecha() {
            const now = new Date();
            // Asegurar que los segundos nunca sean 00
            if (now.getSeconds() === 0) {
                now.setSeconds(1);
            }
            const fechaISO = now.toISOString().slice(0, 19);
            document.getElementById('fecha').value = fechaISO;
            cargarCatalogos();
            cargarEmisores();
            cargarListaReceptores(); // Cargar receptores guardados
            cambiarVersionCfdi();
        }

        // Funci√≥n para cargar cat√°logos en los selects
        function cargarCatalogos() {
            // Cargar forma de pago - ORDENADO POR C√ìDIGO NUM√âRICO
            const formaPagoSelect = document.getElementById('formaPago');
            // üö® FIX CR√çTICO: Limpiar select antes de cargar para evitar duplicados
            formaPagoSelect.innerHTML = '<option value="">Seleccionar forma de pago</option>';
            
            // üéØ CORRECCI√ìN: Ordenar por c√≥digo num√©rico para mejor UX
            const formasPagoOrdenadas = Object.entries(catalogos.formaPago)
                .sort(([a], [b]) => parseInt(a) - parseInt(b));
            
            formasPagoOrdenadas.forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                formaPagoSelect.appendChild(option);
            });

            // Cargar clave unidad
            const claveUnidadSelect = document.getElementById('conceptoClaveUnidad');
            Object.entries(catalogos.claveUnidad).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                claveUnidadSelect.appendChild(option);
            });

            // Cargar impuestos - ORDENADO POR C√ìDIGO NUM√âRICO SIN DUPLICADOS
            const impuestoSelect = document.getElementById('conceptoImpuesto');
            // üö® FIX CR√çTICO: Limpiar select antes de cargar para evitar duplicados
            // Mantener solo la opci√≥n "Sin impuesto" que est√° en el HTML
            const sinImpuestoOption = impuestoSelect.querySelector('option[value=""]');
            impuestoSelect.innerHTML = '';
            if (sinImpuestoOption) {
                impuestoSelect.appendChild(sinImpuestoOption);
            } else {
                // Recrear opci√≥n "Sin impuesto" si no existe
                const sinImpuesto = document.createElement('option');
                sinImpuesto.value = '';
                sinImpuesto.textContent = 'Sin impuesto';
                impuestoSelect.appendChild(sinImpuesto);
            }
            
            // üéØ CORRECCI√ìN: Ordenar por c√≥digo num√©rico y eliminar duplicados
            const impuestosOrdenados = Object.entries(catalogos.impuestos)
                .sort(([a], [b]) => parseInt(a) - parseInt(b))
                .filter((item, index, arr) => {
                    // Eliminar duplicados por c√≥digo
                    return arr.findIndex(([codigo]) => codigo === item[0]) === index;
                });
            
            impuestosOrdenados.forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                impuestoSelect.appendChild(option);
            });

            // Cargar uso de CFDI
            const usoCfdiSelect = document.getElementById('usoCfdi');
            Object.entries(catalogos.usoCfdi).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                usoCfdiSelect.appendChild(option);
            });
        }

        // Funci√≥n para actualizar reg√≠menes fiscales seg√∫n la versi√≥n
        function actualizarRegimenesFiscales() {
            const version = document.getElementById('versionCfdi').value;
            const regimenes = version === '4.0' ? catalogos.regimenFiscal40 : catalogos.regimenFiscal33;
            
            // Actualizar emisor
            const emisorSelect = document.getElementById('emisorRegimenFiscal');
            emisorSelect.innerHTML = '<option value="">Seleccionar r√©gimen fiscal</option>';
            Object.entries(regimenes).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                emisorSelect.appendChild(option);
            });

            // Actualizar receptor
            const receptorSelect = document.getElementById('receptorRegimenFiscal');
            receptorSelect.innerHTML = '<option value="">Seleccionar r√©gimen fiscal</option>';
            Object.entries(regimenes).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                receptorSelect.appendChild(option);
            });
        }

        // Funci√≥n para cambiar versi√≥n CFDI
        function cambiarVersionCfdi() {
            const version = document.getElementById('versionCfdi').value;
            const conceptoObjetoImpGroup = document.getElementById('conceptoObjetoImpGroup'); // Campo por concepto
            const versionWarning = document.getElementById('versionWarning');
            const mainTitle = document.getElementById('mainTitle');
            const pageTitle = document.getElementById('pageTitle');
            
            console.log(`üîß CFDI GENERATOR: Cambiando versi√≥n a ${version}`);
            
            if (version === '3.3') {
                // CFDI 3.3: Ocultar ObjetoImp por concepto (no existe en 3.3)
                if (conceptoObjetoImpGroup) conceptoObjetoImpGroup.style.display = 'none';
                versionWarning.style.display = 'block';
                mainTitle.textContent = 'üìÑ Generador CFDI 3.3 - Sistema Completo';
                pageTitle.textContent = 'üìÑ Generador CFDI 3.3 - Sistema Completo';
                console.log('‚úÖ CFDI 3.3: ObjetoImp por concepto oculto (no aplica)');
            } else {
                // CFDI 4.0: Mostrar ObjetoImp por concepto
                if (conceptoObjetoImpGroup) conceptoObjetoImpGroup.style.display = 'block'; // Mostrar campo por concepto
                versionWarning.style.display = 'none';
                mainTitle.textContent = 'üöÄ Generador CFDI 4.0 - Sistema Completo';
                pageTitle.textContent = 'üöÄ Generador CFDI 4.0 - Sistema Completo';
                console.log('‚úÖ CFDI 4.0: ObjetoImp por concepto habilitado');
            }
            
            actualizarRegimenesFiscales();
        }

        // üéØ REGLA AUTOM√ÅTICA: Pagos diferidos ‚Üí Forma de pago "Por Definir"
        function aplicarReglaPagosDiferidos() {
            const metodoPago = document.getElementById('metodoPago').value;
            const formaPago = document.getElementById('formaPago');
            
            console.log('üîç VERIFICANDO REGLA PAGOS DIFERIDOS:', metodoPago);
            
            if (metodoPago === 'PPD') {
                // PPD = Pago en parcialidades o diferido
                formaPago.value = '99'; // Por Definir
                formaPago.disabled = true;
                console.log('‚úÖ REGLA APLICADA: PPD ‚Üí Forma de pago "Por Definir" (99)');
            } else {
                // PUE = Pago en una sola exhibici√≥n
                formaPago.disabled = false;
                console.log('‚úÖ REGLA: PUE ‚Üí Forma de pago libre');
            }
        }

        // Funciones de testing eliminadas - ya no son necesarias
        
        // SISTEMA DE RECEPTORES GUARDADOS
        let receptoresGuardados = JSON.parse(localStorage.getItem('receptoresGuardados') || '[]');
        
        // SISTEMA DE XMLs GUARDADOS EN LOCALSTORAGE
        let xmlsGuardados = JSON.parse(localStorage.getItem('xmlsGuardados') || '[]');
        
        // Funci√≥n para guardar XML en localStorage
        function guardarXMLEnLocalStorage(xmlContent, sellado, infoSellado) {
            try {
                const xmlData = {
                    id: Date.now().toString(),
                    fecha: new Date().toISOString(),
                    version: document.getElementById('versionCfdi').value,
                    serie: document.getElementById('serie').value || '',
                    folio: document.getElementById('folio').value,
                    emisor_rfc: document.getElementById('emisorRfc').value,
                    emisor_nombre: document.getElementById('emisorNombre').value,
                    receptor_rfc: document.getElementById('receptorRfc').value,
                    receptor_nombre: document.getElementById('receptorNombre').value,
                    subtotal: conceptos.reduce((sum, c) => sum + c.importe, 0).toFixed(2),
                    total: (conceptos.reduce((sum, c) => sum + c.importe, 0) + conceptos.reduce((sum, c) => sum + (c.impuesto ? c.impuesto.importe : 0), 0)).toFixed(2),
                    xml_content: xmlContent,
                    sellado: sellado,
                    info_sellado: infoSellado,
                    estado: sellado ? 'sellado' : 'generado',
                    uuid: null // Se generar√≠a con timbrado
                };
                
                xmlsGuardados.push(xmlData);
                localStorage.setItem('xmlsGuardados', JSON.stringify(xmlsGuardados));
                
                console.log('‚úÖ XML guardado en localStorage:', xmlData.id);
                showAlert(`‚úÖ XML guardado localmente. Serie: ${xmlData.serie} Folio: ${xmlData.folio}`, 'success');
                
                return xmlData;
            } catch (error) {
                console.error('‚ùå Error guardando XML en localStorage:', error);
                showAlert('‚ùå Error guardando XML localmente', 'error');
                throw error;
            }
        }
        
        // Funci√≥n para cargar receptores guardados en el selector
        function cargarListaReceptores() {
            const selector = document.getElementById('receptorGuardado');
            selector.innerHTML = '<option value="">Seleccionar receptor guardado o capturar manualmente</option>';
            
            receptoresGuardados.forEach((receptor, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${receptor.rfc} - ${receptor.nombre}`;
                selector.appendChild(option);
            });
            
            console.log('üìã Receptores cargados:', receptoresGuardados.length);
        }
        
        // Funci√≥n para cargar datos de receptor guardado
        window.cargarReceptorGuardado = function() {
            const selector = document.getElementById('receptorGuardado');
            const index = selector.value;
            
            if (index === '') {
                // Limpiar campos si se selecciona "capturar manualmente"
                document.getElementById('receptorRfc').value = '';
                document.getElementById('receptorNombre').value = '';
                document.getElementById('receptorCodigoPostal').value = '';
                document.getElementById('receptorRegimenFiscal').value = '';
                document.getElementById('usoCfdi').value = '';
                return;
            }
            
            const receptor = receptoresGuardados[index];
            if (receptor) {
                document.getElementById('receptorRfc').value = receptor.rfc;
                document.getElementById('receptorNombre').value = receptor.nombre;
                document.getElementById('receptorCodigoPostal').value = receptor.codigoPostal;
                document.getElementById('receptorRegimenFiscal').value = receptor.regimenFiscal;
                document.getElementById('usoCfdi').value = receptor.usoCfdi;
                
                console.log('‚úÖ Receptor cargado:', receptor.rfc, '-', receptor.nombre);
                showAlert(`‚úÖ Receptor cargado: ${receptor.nombre}`, 'success');
            }
        };
        
        // Funci√≥n para guardar receptor autom√°ticamente
        function guardarReceptorAutomaticamente() {
            const receptorData = {
                rfc: document.getElementById('receptorRfc').value,
                nombre: document.getElementById('receptorNombre').value,
                codigoPostal: document.getElementById('receptorCodigoPostal').value,
                regimenFiscal: document.getElementById('receptorRegimenFiscal').value,
                usoCfdi: document.getElementById('usoCfdi').value,
                fechaCreacion: new Date().toISOString()
            };
            
            // Verificar si el receptor ya existe (por RFC)
            const existeIndex = receptoresGuardados.findIndex(r => r.rfc === receptorData.rfc);
            
            if (existeIndex >= 0) {
                // Actualizar receptor existente
                receptoresGuardados[existeIndex] = { ...receptoresGuardados[existeIndex], ...receptorData };
                console.log('üîÑ Receptor actualizado:', receptorData.rfc);
            } else {
                // Agregar nuevo receptor
                receptoresGuardados.push(receptorData);
                console.log('‚úÖ Nuevo receptor guardado:', receptorData.rfc);
            }
            
            // Guardar en localStorage
            localStorage.setItem('receptoresGuardados', JSON.stringify(receptoresGuardados));
            
            // Recargar lista
            cargarListaReceptores();
            
            return receptorData;
        }
        
        // Funci√≥n para gestionar receptores
        window.gestionarReceptores = function() {
            const mensaje = `üìã RECEPTORES GUARDADOS (${receptoresGuardados.length}):\n\n` +
                receptoresGuardados.map((r, i) => 
                    `${i + 1}. ${r.rfc} - ${r.nombre}\n   CP: ${r.codigoPostal} | R√©gimen: ${r.regimenFiscal} | Uso: ${r.usoCfdi}`
                ).join('\n\n') +
                '\n\n‚ÑπÔ∏è Los receptores se guardan autom√°ticamente al generar XMLs exitosamente.';
            
            alert(mensaje);
        };
        
        // Funci√≥n para agregar concepto - DISPONIBLE GLOBALMENTE
        window.agregarConcepto = function agregarConcepto() {
            console.log('üîß DIAGN√ìSTICO: Iniciando agregarConcepto()');
            
            // Verificar elementos del DOM
            const elementos = {
                descripcion: document.getElementById('conceptoDescripcion'),
                cantidad: document.getElementById('conceptoCantidad'),
                valorUnitario: document.getElementById('conceptoValorUnitario'),
                claveUnidad: document.getElementById('conceptoClaveUnidad'),
                claveProducto: document.getElementById('conceptoClaveProducto'),
                impuesto: document.getElementById('conceptoImpuesto'),
                objetoImp: document.getElementById('conceptoObjetoImp'),
                version: document.getElementById('versionCfdi')
            };
            
            // Verificar que todos los elementos existan
            for (const [nombre, elemento] of Object.entries(elementos)) {
                if (!elemento) {
                    console.error(`‚ùå ERROR: Elemento '${nombre}' no encontrado en el DOM`);
                    showAlert(`Error: Campo '${nombre}' no encontrado`, 'error');
                    return;
                }
            }
            
            const descripcion = elementos.descripcion.value;
            const cantidad = parseFloat(elementos.cantidad.value);
            const valorUnitario = parseFloat(elementos.valorUnitario.value);
            const claveUnidad = elementos.claveUnidad.value;
            const claveProducto = elementos.claveProducto.value;
            const impuesto = elementos.impuesto.value;
            const objetoImp = elementos.objetoImp.value;
            const version = elementos.version.value;
            
            console.log('üìã VALORES CAPTURADOS:', {
                descripcion, cantidad, valorUnitario, claveUnidad, 
                claveProducto, impuesto, objetoImp, version
            });
            
            // VALIDACI√ìN DETALLADA CON LOGS
            console.log('üîç VALIDANDO CAMPOS OBLIGATORIOS...');
            
            if (!descripcion) {
                console.error('‚ùå FALLA: Descripci√≥n vac√≠a');
                showAlert('‚ö†Ô∏è Complete la descripci√≥n del concepto', 'error');
                return;
            }
            
            if (!cantidad || isNaN(cantidad)) {
                console.error('‚ùå FALLA: Cantidad inv√°lida:', cantidad);
                showAlert('‚ö†Ô∏è Complete la cantidad del concepto', 'error');
                return;
            }
            
            if (!valorUnitario || isNaN(valorUnitario)) {
                console.error('‚ùå FALLA: Valor unitario inv√°lido:', valorUnitario);
                showAlert('‚ö†Ô∏è Complete el valor unitario del concepto', 'error');
                return;
            }
            
            if (!claveUnidad) {
                console.error('‚ùå FALLA: Clave unidad vac√≠a');
                showAlert('‚ö†Ô∏è Seleccione la clave de unidad', 'error');
                return;
            }
            
            if (!claveProducto) {
                console.error('‚ùå FALLA: Clave producto vac√≠a');
                showAlert('‚ö†Ô∏è Complete la clave de producto/servicio', 'error');
                return;
            }
            
            console.log('üîç VALIDANDO CLAVE DE PRODUCTO...');
            if (claveProducto.length !== 8) {
                console.error('‚ùå FALLA: Clave producto longitud incorrecta:', claveProducto.length, 'caracteres');
                showAlert('‚ö†Ô∏è La clave de producto/servicio debe tener exactamente 8 d√≠gitos', 'error');
                return;
            }
            
            if (!/^[0-9]{8}$/.test(claveProducto)) {
                console.error('‚ùå FALLA: Clave producto formato incorrecto:', claveProducto);
                showAlert('‚ö†Ô∏è La clave de producto/servicio debe contener solo n√∫meros', 'error');
                return;
            }
            
            console.log('üîç VALIDANDO OBJETO DE IMPUESTO...');
            if (version === '4.0' && !objetoImp) {
                console.error('‚ùå FALLA: ObjetoImp requerido para CFDI 4.0');
                showAlert('‚ö†Ô∏è Objeto de Impuesto es obligatorio para CFDI 4.0', 'error');
                return;
            }
            
            console.log('‚úÖ TODAS LAS VALIDACIONES PASARON');
            
            
            const importe = cantidad * valorUnitario;
            let impuestoInfo = null;
            
            if (impuesto) {
                const tasaImpuesto = impuesto === '002' ? 0.16 : 0; // IVA 16%
                const importeImpuesto = importe * tasaImpuesto;
                impuestoInfo = {
                    codigo: impuesto,
                    nombre: catalogos.impuestos[impuesto],
                    tasa: tasaImpuesto,
                    importe: importeImpuesto
                };
            }
            
            const concepto = {
                id: ++conceptoCounter,
                descripcion,
                cantidad,
                valorUnitario,
                claveUnidad,
                claveProducto,
                importe,
                impuesto: impuestoInfo,
                objetoImp: version === '4.0' ? objetoImp : null
            };
            
            console.log('‚úÖ CONCEPTO CREADO:', concepto);
            conceptos.push(concepto);
            console.log('üìä ARRAY CONCEPTOS ACTUALIZADO:', conceptos);
            console.log('üîÑ Llamando renderizarConceptos()...');
            renderizarConceptos();
            console.log('üßπ Limpiando formulario...');
            limpiarFormularioConcepto();
            console.log('üí∞ Actualizando totales...');
            actualizarTotales();
            console.log('‚úÖ CONCEPTO AGREGADO EXITOSAMENTE');
        }

        // Funci√≥n para limpiar formulario de concepto
        function limpiarFormularioConcepto() {
            document.getElementById('conceptoDescripcion').value = '';
            document.getElementById('conceptoCantidad').value = '';
            document.getElementById('conceptoValorUnitario').value = '';
            document.getElementById('conceptoClaveUnidad').value = '';
            document.getElementById('conceptoClaveProducto').value = '';
            
            // üéØ VALORES POR DEFECTO SOLICITADOS POR USUARIO
            // Impuesto por defecto: IVA (002)
            document.getElementById('conceptoImpuesto').value = '002';
            
            // Objeto de impuesto por defecto: "S√≠ objeto de impuesto" (02) - solo para CFDI 4.0
            const version = document.getElementById('versionCfdi').value;
            if (version === '4.0') {
                document.getElementById('conceptoObjetoImp').value = '02';
            } else {
                document.getElementById('conceptoObjetoImp').value = '';
            }
        }

        // Funci√≥n para renderizar conceptos
        function renderizarConceptos() {
            console.log('üé® RENDERIZANDO CONCEPTOS:', conceptos.length, 'conceptos');
            const container = document.getElementById('conceptosContainer');
            
            if (!container) {
                console.error('‚ùå ERROR: Container conceptosContainer no encontrado');
                return;
            }
            
            console.log('üì¶ Container encontrado:', container);
            container.innerHTML = '';
            
            if (conceptos.length === 0) {
                console.log('‚ö†Ô∏è No hay conceptos para renderizar');
                return;
            }
            
            conceptos.forEach((concepto, index) => {
                console.log(`üîÑ Renderizando concepto ${index + 1}:`, concepto);
                const conceptoDiv = document.createElement('div');
                conceptoDiv.className = 'concepto-item';
                conceptoDiv.innerHTML = `
                    <div class="concepto-header">
                        <span class="concepto-title">Concepto #${concepto.id}</span>
                        <button class="btn-remove" onclick="eliminarConcepto(${concepto.id})" title="Eliminar concepto">√ó</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <strong>Descripci√≥n:</strong> ${concepto.descripcion}
                        </div>
                        <div class="form-group">
                            <strong>Cantidad:</strong> ${concepto.cantidad}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <strong>Valor Unitario:</strong> $${concepto.valorUnitario.toFixed(2)}
                        </div>
                        <div class="form-group">
                            <strong>Importe:</strong> $${concepto.importe.toFixed(2)}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <strong>Clave Unidad:</strong> ${concepto.claveUnidad}
                        </div>
                        <div class="form-group">
                            <strong>Clave Producto:</strong> ${concepto.claveProducto}
                        </div>
                    </div>
                    ${concepto.impuesto ? `
                        <div class="form-row">
                            <div class="form-group">
                                <strong>Impuesto:</strong> ${concepto.impuesto.nombre || 'IVA'} (${((concepto.impuesto.tasa || 0.16) * 100).toFixed(0)}%)
                            </div>
                            <div class="form-group">
                                <strong>Importe Impuesto:</strong> $${(concepto.impuesto.importe || 0).toFixed(2)}
                            </div>
                        </div>
                    ` : ''}
                `;
                container.appendChild(conceptoDiv);
            });
        }

        // Funci√≥n para eliminar concepto
        function eliminarConcepto(id) {
            conceptos = conceptos.filter(c => c.id !== id);
            renderizarConceptos();
            actualizarTotales();
        }

        // Funci√≥n para actualizar totales
        function actualizarTotales() {
            const subtotal = conceptos.reduce((sum, c) => sum + c.importe, 0);
            const iva = conceptos.reduce((sum, c) => sum + (c.impuesto ? c.impuesto.importe : 0), 0);
            const total = subtotal + iva;
            
            document.getElementById('subtotalValue').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('ivaValue').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('totalValue').textContent = `$${total.toFixed(2)}`;
        }

        // Funci√≥n principal para generar XML
        // Funci√≥n para generar XML - DISPONIBLE GLOBALMENTE
        window.generarXML = async function generarXML() {
            console.log('üöÄ INICIO: Funci√≥n generarXML ejecut√°ndose...');
            console.log('üîç Estado inicial:', {
                conceptos: conceptos.length,
                autoSave: document.getElementById('autoSave')?.checked,
                currentUser: !!currentUser
            });
            console.log('üöÄ DIAGN√ìSTICO: Iniciando generarXML()');
            if (conceptos.length === 0) {
                showAlert('‚ö†Ô∏è Debe agregar al menos un concepto', 'error');
                return;
            }

            // SISTEMA ROBUSTO DE VALIDACI√ìN Y CONTROL DE ERRORES
            console.log('üîç INICIANDO VALIDACI√ìN COMPLETA DE CAMPOS...');
            
            const erroresValidacion = [];
            const version = document.getElementById('versionCfdi').value;
            
            // 1. VALIDAR DATOS GENERALES
            console.log('üîç Validando Datos Generales...');
            const serie = document.getElementById('serie').value.trim();
            const folio = document.getElementById('folio').value.trim();
            const fecha = document.getElementById('fecha').value.trim();
            const metodoPago = document.getElementById('metodoPago').value.trim();
            const formaPago = document.getElementById('formaPago').value.trim();
            
            if (!folio) erroresValidacion.push('‚ùå Folio es obligatorio');
            if (!fecha) erroresValidacion.push('‚ùå Fecha es obligatoria');
            if (!metodoPago) erroresValidacion.push('‚ùå M√©todo de Pago es obligatorio');
            if (!formaPago) erroresValidacion.push('‚ùå Forma de Pago es obligatoria');
            
            // 2. VALIDAR SELECCI√ìN DE EMISOR
            console.log('üîç Validando Selecci√≥n de Emisor...');
            const emisorSeleccionado = document.getElementById('emisorSelect').value.trim();
            
            if (!emisorSeleccionado) {
                erroresValidacion.push('‚ùå Debe seleccionar un Emisor de la lista');
            }
            
            // 2.1. VALIDAR DATOS DEL EMISOR (si est√° seleccionado)
            console.log('üîç Validando Datos del Emisor...');
            const emisorRfc = document.getElementById('emisorRfc').value.trim();
            const emisorNombre = document.getElementById('emisorNombre').value.trim();
            const emisorCP = document.getElementById('emisorCodigoPostal').value.trim();
            const emisorRegimen = document.getElementById('emisorRegimenFiscal').value.trim();
            
            if (!emisorRfc) {
                erroresValidacion.push('‚ùå RFC del Emisor es obligatorio');
            } else if (!/^[A-Z&√ë]{3,4}[0-9]{6}[A-Z0-9]{3}$/.test(emisorRfc)) {
                erroresValidacion.push('‚ùå RFC del Emisor tiene formato inv√°lido');
            }
            
            if (!emisorNombre) erroresValidacion.push('‚ùå Nombre del Emisor es obligatorio');
            
            if (!emisorCP) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Emisor es obligatorio');
            } else if (!/^[0-9]{5}$/.test(emisorCP)) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Emisor debe tener 5 d√≠gitos');
            }
            
            if (!emisorRegimen) erroresValidacion.push('‚ùå R√©gimen Fiscal del Emisor es obligatorio');
            
            // 3. VALIDAR SELECCI√ìN DE RECEPTOR
            console.log('üîç Validando Selecci√≥n de Receptor...');
            const receptorSeleccionado = document.getElementById('receptorSelect')?.value?.trim();
            
            // Verificar si hay un receptor seleccionado de la lista o datos manuales
            const receptorRfc = document.getElementById('receptorRfc').value.trim();
            const receptorNombre = document.getElementById('receptorNombre').value.trim();
            
            if (!receptorSeleccionado && (!receptorRfc || !receptorNombre)) {
                erroresValidacion.push('‚ùå Debe seleccionar un Receptor de la lista o capturar los datos manualmente');
            }
            
            // 3.1. VALIDAR DATOS DEL RECEPTOR (si est√°n capturados)
            console.log('üîç Validando Datos del Receptor...');
            const receptorCP = document.getElementById('receptorCodigoPostal').value.trim();
            const receptorRegimen = document.getElementById('receptorRegimenFiscal').value.trim();
            const usoCfdi = document.getElementById('usoCfdi').value.trim();
            
            if (!receptorRfc) {
                erroresValidacion.push('‚ùå RFC del Receptor es obligatorio');
            } else if (!/^[A-Z&√ë]{3,4}[0-9]{6}[A-Z0-9]{3}$/.test(receptorRfc)) {
                erroresValidacion.push('‚ùå RFC del Receptor tiene formato inv√°lido');
            }
            
            if (!receptorNombre) erroresValidacion.push('‚ùå Nombre del Receptor es obligatorio');
            
            if (!receptorCP) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Receptor es obligatorio');
            } else if (!/^[0-9]{5}$/.test(receptorCP)) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Receptor debe tener 5 d√≠gitos');
            }
            
            if (!receptorRegimen) erroresValidacion.push('‚ùå R√©gimen Fiscal del Receptor es obligatorio');
            if (!usoCfdi) erroresValidacion.push('‚ùå Uso de CFDI es obligatorio');
            
            // 4. VALIDAR CONCEPTOS
            console.log('üîç Validando Conceptos...');
            if (conceptos.length === 0) {
                erroresValidacion.push('‚ùå Debe agregar al menos un concepto');
            } else {
                // Validar cada concepto
                conceptos.forEach((concepto, index) => {
                    if (!concepto.descripcion) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Descripci√≥n faltante`);
                    if (!concepto.cantidad || concepto.cantidad <= 0) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Cantidad inv√°lida`);
                    if (!concepto.valorUnitario || concepto.valorUnitario <= 0) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Valor unitario inv√°lido`);
                    if (!concepto.claveUnidad) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Clave de unidad faltante`);
                    if (!concepto.claveProducto) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Clave de producto faltante`);
                    
                    // Validar ObjetoImp para CFDI 4.0
                    if (version === '4.0' && !concepto.objetoImp) {
                        erroresValidacion.push(`‚ùå Concepto ${index + 1}: Objeto de Impuesto es obligatorio para CFDI 4.0`);
                    }
                });
            }
            
            // 5. MOSTRAR ERRORES SI EXISTEN
            if (erroresValidacion.length > 0) {
                console.error('‚ùå ERRORES DE VALIDACI√ìN ENCONTRADOS:', erroresValidacion);
                const mensajeError = `üò® NO SE PUEDE GENERAR EL XML\n\nERRORES ENCONTRADOS (${erroresValidacion.length}):\n\n` +
                    erroresValidacion.map((error, i) => `${i + 1}. ${error}`).join('\n') +
                    '\n\n‚ÑπÔ∏è Por favor corrija estos errores e intente nuevamente.';
                
                showAlert(mensajeError, 'error');
                return;
            }
            
            console.log('‚úÖ TODAS LAS VALIDACIONES PASARON EXITOSAMENTE');
            

            try {
                // Generar XML base
                const xmlContent = construirXML();
                let xmlFinal = xmlContent;
                let sellado = false;
                let infoSellado = null;

                // XML generado sin sellar seg√∫n especificaciones SAT
                // Los atributos NoCertificado, Certificado y Sello se agregan solo durante el sellado
                showAlert('‚úÖ XML generado exitosamente (sin sellar)', 'success');
                
                // Nota: El sellado debe ser un proceso separado usando el bot√≥n "Sellar XML"

                // Actualizar variable global
                xmlGenerado = xmlFinal;

                // Mostrar XML final
                document.getElementById('xmlOutput').textContent = xmlFinal;
                document.getElementById('xmlOutput').style.display = 'block';
                document.getElementById('btnDescargar').style.display = 'inline-block';

                // Mostrar informaci√≥n del sellado si aplica
                if (sellado && infoSellado) {
                    mostrarInfoSellado(infoSellado);
                }

                // Guardar receptor autom√°ticamente al generar XML exitosamente
                try {
                    const receptorGuardado = guardarReceptorAutomaticamente();
                    console.log('üìã Receptor guardado autom√°ticamente:', receptorGuardado.rfc);
                    showAlert(`‚úÖ XML generado exitosamente. Receptor ${receptorGuardado.nombre} guardado para uso futuro.`, 'success');
                } catch (error) {
                    console.error('Error guardando receptor:', error);
                }
                
                // Guardar autom√°ticamente el XML generado
                console.log('üéØ PUNTO CR√çTICO: Llegando al c√≥digo de guardado...');
                const autoSave = document.getElementById('autoSave').checked;
                console.log('üîç Estado de guardado:', { autoSave, currentUser: !!currentUser });
                
                if (autoSave) {
                    console.log('‚úÖ AutoSave habilitado, procediendo con guardado...');
                    if (currentUser) {
                        // Guardar en base de datos si el usuario est√° logueado
                        console.log('üíæ Guardando XML en base de datos...');
                        try {
                            await guardarXMLEnBD(xmlFinal, sellado, infoSellado);
                            console.log('‚úÖ XML guardado en base de datos exitosamente');
                        } catch (error) {
                            console.error('‚ùå Error guardando en BD:', error);
                            console.log('üîÑ Fallback: Intentando guardar en localStorage...');
                            guardarXMLEnLocalStorage(xmlFinal, sellado, infoSellado);
                        }
                    } else {
                        // Guardar en localStorage si no hay usuario logueado
                        console.log('üíæ Guardando XML en localStorage (usuario no logueado)...');
                        console.log('üìä Datos a guardar:', {
                            xmlLength: xmlFinal.length,
                            sellado,
                            conceptosCount: conceptos.length
                        });
                        const resultado = guardarXMLEnLocalStorage(xmlFinal, sellado, infoSellado);
                        console.log('üéØ Resultado del guardado:', resultado);
                    }
                } else {
                    console.log('‚ö†Ô∏è Guardado autom√°tico deshabilitado');
                }

                // Descargar autom√°ticamente si est√° habilitado
                const downloadXml = document.getElementById('downloadXml').checked;
                if (downloadXml) {
                    descargarXML();
                }

            } catch (error) {
                console.error('Error generando XML:', error);
                showAlert('‚ùå Error al generar XML: ' + error.message, 'error');
            }
        }

        // Funci√≥n para construir el XML
        function construirXML() {
            const version = document.getElementById('versionCfdi').value;
            const fecha = document.getElementById('fecha').value; // SAT requiere formato ISO 8601: YYYY-MM-DDTHH:MM:SS
            const serie = document.getElementById('serie').value || '';
            const folio = document.getElementById('folio').value;
            
            // Datos del emisor
            const emisorRfc = document.getElementById('emisorRfc').value;
            const emisorNombre = document.getElementById('emisorNombre').value;
            const emisorCodigoPostal = document.getElementById('emisorCodigoPostal').value;
            const emisorRegimenFiscal = document.getElementById('emisorRegimenFiscal').value;
            
            // Datos del receptor
            const receptorRfc = document.getElementById('receptorRfc').value;
            const receptorNombre = document.getElementById('receptorNombre').value;
            const receptorCodigoPostal = document.getElementById('receptorCodigoPostal').value;
            const receptorRegimenFiscal = document.getElementById('receptorRegimenFiscal').value;
            const usoCfdi = document.getElementById('usoCfdi').value;
            
            // Datos de pago (ahora en Datos Generales)
            const metodoPago = document.getElementById('metodoPago').value;
            const formaPago = document.getElementById('formaPago').value;
            // ObjetoImp eliminado: ahora solo va por concepto
            
            // Calcular totales
            const subtotal = conceptos.reduce((sum, c) => sum + c.importe, 0);
            const totalImpuestos = conceptos.reduce((sum, c) => sum + (c.impuesto ? c.impuesto.importe : 0), 0);
            const total = subtotal + totalImpuestos;
            
            // Construir XML seg√∫n la versi√≥n
            let xml = '';
            
            if (version === '4.0') {
                xml = `<?xml version="1.0" encoding="UTF-8"?>
<cfdi:Comprobante xmlns:cfdi="http://www.sat.gob.mx/cfd/4" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sat.gob.mx/cfd/4 http://www.sat.gob.mx/sitio_internet/cfd/4/cfdv40.xsd" Version="4.0" Fecha="${fecha}" FormaPago="${formaPago}" SubTotal="${subtotal.toFixed(2)}" Moneda="MXN" Total="${total.toFixed(2)}" TipoDeComprobante="I" Exportacion="01" MetodoPago="${metodoPago}" LugarExpedicion="${emisorCodigoPostal}"${serie ? ` Serie="${serie}"` : ''} Folio="${folio}">
`;
            } else {
                xml = `<?xml version="1.0" encoding="UTF-8"?>
<cfdi:Comprobante xmlns:cfdi="http://www.sat.gob.mx/cfd/3" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sat.gob.mx/cfd/3 http://www.sat.gob.mx/sitio_internet/cfd/3/cfdv33.xsd" Version="3.3" Fecha="${fecha}" FormaPago="${formaPago}" SubTotal="${subtotal.toFixed(2)}" Moneda="MXN" Total="${total.toFixed(2)}" TipoDeComprobante="I" MetodoPago="${metodoPago}" LugarExpedicion="${emisorCodigoPostal}"${serie ? ` Serie="${serie}"` : ''} Folio="${folio}">
`;
            }
            
            // Emisor
            xml += `  <cfdi:Emisor Rfc="${emisorRfc}" Nombre="${emisorNombre}" RegimenFiscal="${emisorRegimenFiscal}"/>
`;
            
            // Receptor
            if (version === '4.0') {
                xml += `  <cfdi:Receptor Rfc="${receptorRfc}" Nombre="${receptorNombre}" DomicilioFiscalReceptor="${receptorCodigoPostal}" RegimenFiscalReceptor="${receptorRegimenFiscal}" UsoCFDI="${usoCfdi}"/>
`;
            } else {
                xml += `  <cfdi:Receptor Rfc="${receptorRfc}" Nombre="${receptorNombre}" UsoCFDI="${usoCfdi}"/>
`;
            }
            
            // Conceptos
            xml += `  <cfdi:Conceptos>
`;
            conceptos.forEach(concepto => {
                // ObjetoImp por concepto (CFDI 4.0) - Corregido seg√∫n especificaciones SAT
                const objetoImpAttr = version === '4.0' && concepto.objetoImp ? ` ObjetoImp="${concepto.objetoImp}"` : '';
                xml += `    <cfdi:Concepto ClaveProdServ="${concepto.claveProducto}" Cantidad="${concepto.cantidad}" ClaveUnidad="${concepto.claveUnidad}" Descripcion="${concepto.descripcion}" ValorUnitario="${concepto.valorUnitario.toFixed(2)}" Importe="${concepto.importe.toFixed(2)}"${objetoImpAttr}`;
                
                if (concepto.impuesto) {
                    xml += `>
      <cfdi:Impuestos>
        <cfdi:Traslados>
          <cfdi:Traslado Base="${concepto.importe.toFixed(2)}" Impuesto="${concepto.impuesto.codigo}" TipoFactor="Tasa" TasaOCuota="${concepto.impuesto.tasa.toFixed(6)}" Importe="${concepto.impuesto.importe.toFixed(2)}"/>
        </cfdi:Traslados>
      </cfdi:Impuestos>
    </cfdi:Concepto>
`;
                } else {
                    xml += `/>
`;
                }
            });
            xml += `  </cfdi:Conceptos>
`;
            
            // Impuestos totales
            if (totalImpuestos > 0) {
                xml += `  <cfdi:Impuestos TotalImpuestosTrasladados="${totalImpuestos.toFixed(6)}">
`;
                xml += `    <cfdi:Traslados>
`;
                
                // Agrupar impuestos por tipo
                const impuestosAgrupados = {};
                conceptos.forEach(concepto => {
                    if (concepto.impuesto) {
                        const key = concepto.impuesto.codigo;
                        if (!impuestosAgrupados[key]) {
                            impuestosAgrupados[key] = {
                                codigo: concepto.impuesto.codigo,
                                tasa: concepto.impuesto.tasa,
                                base: 0,
                                importe: 0
                            };
                        }
                        impuestosAgrupados[key].base += concepto.importe;
                        impuestosAgrupados[key].importe += concepto.impuesto.importe;
                    }
                });
                
                Object.values(impuestosAgrupados).forEach(impuesto => {
                    // CR√çTICO: Seg√∫n validador SAT oficial, Base S√ç es obligatorio en traslados totales
                    xml += `      <cfdi:Traslado Base="${impuesto.base.toFixed(2)}" Impuesto="${impuesto.codigo}" TipoFactor="Tasa" TasaOCuota="${impuesto.tasa.toFixed(6)}" Importe="${impuesto.importe.toFixed(2)}"/>
`;
                });
                
                xml += `    </cfdi:Traslados>
`;
                xml += `  </cfdi:Impuestos>
`;
            }
            
            xml += `</cfdi:Comprobante>`;
            
            return xml;
        }

        // Funci√≥n para guardar XML en la base de datos
        async function guardarXMLEnBD(xmlContent) {
            if (!currentUser) return;

            try {
                const emisorId = document.getElementById('emisorSelect').value || null;
                const data = {
                    xml_content: xmlContent,
                    version_cfdi: document.getElementById('versionCfdi').value,
                    emisor_rfc: document.getElementById('emisorRfc').value,
                    emisor_nombre: document.getElementById('emisorNombre').value,
                    receptor_rfc: document.getElementById('receptorRfc').value,
                    receptor_nombre: document.getElementById('receptorNombre').value,
                    serie: document.getElementById('serie').value || null,
                    folio: document.getElementById('folio').value,
                    total: document.getElementById('totalValue').textContent.replace('$', ''),
                    emisor_id: emisorId
                };

                const token = localStorage.getItem('cfdi_token');
                const response = await fetch('/.netlify/functions/xmls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('üíæ XML guardado autom√°ticamente en tu cuenta', 'success');
                } else {
                    console.error('Error guardando XML:', await response.text());
                }
            } catch (error) {
                console.error('Error guardando XML:', error);
            }
        }

        // Funci√≥n para descargar XML
        function descargarXML() {
            if (!xmlGenerado) {
                showAlert('‚ö†Ô∏è Primero debe generar el XML', 'error');
                return;
            }

            const version = document.getElementById('versionCfdi').value;
            const emisorRfc = document.getElementById('emisorRfc').value;
            const serie = document.getElementById('serie').value || '';
            const folio = document.getElementById('folio').value;
            
            const filename = `CFDI_${version}_${emisorRfc}_${serie}${serie ? '-' : ''}${folio}.xml`;
            
            const blob = new Blob([xmlGenerado], { type: 'application/xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Funci√≥n para sellar XML con emisor
        async function sellarXMLConEmisor(xmlContent, emisorId, version) {
            try {
                const token = localStorage.getItem('cfdi_token');
                const response = await fetch('/.netlify/functions/sellar-cfdi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        xmlContent: xmlContent,
                        emisorId: emisorId,
                        version: version
                    })
                });

                if (response.ok) {
                    const resultado = await response.json();
                    return {
                        exito: true,
                        xmlSellado: resultado.xmlSellado,
                        selloDigital: resultado.selloDigital,
                        numeroCertificado: resultado.numeroCertificado,
                        emisor: resultado.emisor
                    };
                } else {
                    const error = await response.json();
                    return {
                        exito: false,
                        error: error.error || 'Error desconocido en el sellado'
                    };
                }
            } catch (error) {
                console.error('Error en sellado:', error);
                return {
                    exito: false,
                    error: 'Error de conexi√≥n durante el sellado'
                };
            }
        }

        // Funci√≥n para mostrar informaci√≥n del sellado
        function mostrarInfoSellado(infoSellado) {
            const infoDiv = document.getElementById('selladoInfo') || crearDivInfoSellado();
            
            infoDiv.innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <h4 style="color: #155724; margin-bottom: 10px;">üîê Informaci√≥n del Sellado Digital</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-size: 14px;">
                        <div><strong>Emisor:</strong> ${infoSellado.emisor.rfc} - ${infoSellado.emisor.nombre}</div>
                        <div><strong>Certificado:</strong> ${infoSellado.numeroCertificado}</div>
                        <div><strong>Sello:</strong> ${infoSellado.selloDigital.substring(0, 20)}...</div>
                        <div><strong>Estado:</strong> <span style="color: #28a745;">‚úÖ Sellado V√°lido</span></div>
                    </div>
                </div>
            `;
            
            infoDiv.style.display = 'block';
        }

        // Funci√≥n para crear div de informaci√≥n de sellado
        function crearDivInfoSellado() {
            const infoDiv = document.createElement('div');
            infoDiv.id = 'selladoInfo';
            infoDiv.style.display = 'none';
            
            const xmlOutput = document.getElementById('xmlOutput');
            xmlOutput.parentNode.insertBefore(infoDiv, xmlOutput);
            
            return infoDiv;
        }

        // Funci√≥n para limpiar formulario
        function limpiarFormulario() {
            // Limpiar todos los campos del formulario
            document.getElementById('serie').value = '';
            document.getElementById('folio').value = '';
            document.getElementById('emisorSelect').value = '';
            document.getElementById('emisorRfc').value = '';
            document.getElementById('emisorNombre').value = '';
            document.getElementById('emisorCodigoPostal').value = '';
            document.getElementById('emisorRegimenFiscal').value = '';
            document.getElementById('receptorRfc').value = '';
            document.getElementById('receptorNombre').value = '';
            document.getElementById('receptorCodigoPostal').value = '';
            document.getElementById('receptorRegimenFiscal').value = '';
            document.getElementById('usoCfdi').value = '';
            document.getElementById('formaPago').value = '';
            document.getElementById('objetoImp').value = '';
            
            // Limpiar conceptos
            conceptos = [];
            conceptoCounter = 0;
            renderizarConceptos();
            actualizarTotales();
            
            // Limpiar formulario de concepto
            limpiarFormularioConcepto();
            
            // Ocultar XML y bot√≥n de descarga
            document.getElementById('xmlOutput').style.display = 'none';
            document.getElementById('btnDescargar').style.display = 'none';
            xmlGenerado = '';
            
            // Reinicializar fecha
            inicializarFecha();
            
            showAlert('üßπ Formulario limpiado', 'info');
        }
        
        // Funci√≥n para cancelar edici√≥n y regresar al dashboard
        function cancelarEdicion() {
            // Verificar si estamos en modo edici√≥n
            const urlParams = new URLSearchParams(window.location.search);
            const modo = urlParams.get('modo');
            
            if (modo === 'edicion') {
                // Confirmar cancelaci√≥n si hay cambios
                const confirmar = confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas cancelar la edici√≥n?\n\nSe perder√°n todos los cambios no guardados.');
                
                if (confirmar) {
                    console.log('‚ùå Cancelando edici√≥n y regresando al dashboard');
                    
                    // Limpiar sessionStorage
                    sessionStorage.removeItem('xml_editando');
                    
                    // Mostrar mensaje de cancelaci√≥n
                    showAlert('‚ùå Edici√≥n cancelada', 'warning');
                    
                    // Regresar al dashboard despu√©s de un breve delay
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                }
            } else {
                // Si no estamos en modo edici√≥n, simplemente regresar al dashboard
                const confirmar = confirm('‚ö†Ô∏è ¬øDeseas regresar al dashboard?\n\nSe perder√°n todos los datos no guardados.');
                
                if (confirmar) {
                    console.log('‚ùå Regresando al dashboard');
                    showAlert('‚ùå Regresando al dashboard', 'info');
                    
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                }
            }
        }
    </script>
</body>
</html>
