<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">üöÄ Generador CFDI - Sistema Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header-nav { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .header-nav .btn { padding: 8px 16px; font-size: 14px; }
        .version-selector { background: #f8f9fa; padding: 20px; border-bottom: 2px solid #e9ecef; }
        .version-warning { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 15px; color: #856404; display: none; }
        .content { padding: 30px; }
        .form-section { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 25px; border-left: 4px solid #007bff; }
        .form-section h3 { color: #2c3e50; margin-bottom: 20px; font-size: 1.3rem; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #495057; margin-bottom: 8px; }
        .form-group input, .form-group select { padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; }
        .btn:hover { transform: translateY(-2px); }
        .conceptos-container { margin-top: 25px; }
        .concepto-item { background: white; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; margin-bottom: 15px; position: relative; }
        .concepto-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .concepto-title { font-weight: 600; color: #2c3e50; }
        .btn-remove { background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 14px; }
        .totales { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 25px; border-radius: 10px; margin: 25px 0; }
        .totales h3 { margin-bottom: 15px; }
        .totales-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .total-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; }
        .total-label { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        .total-value { font-size: 1.4rem; font-weight: 700; }
        .xml-output { background: #2d3748; color: #e2e8f0; padding: 25px; border-radius: 10px; margin-top: 25px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; }
        .actions { text-align: center; margin: 30px 0; }
        .actions .btn { margin: 0 10px; }
        .save-options { background: #e8f5e8; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .save-options h4 { color: #155724; margin-bottom: 15px; }
        .save-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-info { background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .alert { padding: 12px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-nav">
                <a href="/dashboard.html" class="btn btn-secondary">üìÑ Dashboard</a>
                <button onclick="logout()" class="btn btn-danger">üö™ Salir</button>
            </div>
            <h1 id="mainTitle">üöÄ Generador CFDI - Sistema Completo</h1>
            <p>Generador integrado con almacenamiento autom√°tico</p>
        </div>

        <!-- Info del usuario logueado -->
        <div id="userInfo" class="user-info" style="display: none;">
            <strong>Usuario:</strong> <span id="currentUserName"></span> | 
            <strong>Email:</strong> <span id="currentUserEmail"></span>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <div class="version-selector">
            <div class="form-group">
                <label for="versionCfdi">üîß Seleccionar Versi√≥n CFDI:</label>
                <select id="versionCfdi" onchange="cambiarVersionCfdi()">
                    <option value="4.0">CFDI 4.0 (Actual)</option>
                    <option value="3.3">CFDI 3.3 (Legacy)</option>
                </select>
            </div>
            <div id="versionWarning" class="version-warning">
                ‚ö†Ô∏è <strong>Versi√≥n 3.3:</strong> Esta es una versi√≥n legacy. Se recomienda usar CFDI 4.0 para nuevos comprobantes.
            </div>
        </div>

        <div class="content">
            <!-- Datos Generales -->
            <div class="form-section">
                <h3>üìã Datos Generales del Comprobante</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="serie">Serie</label>
                        <input type="text" id="serie" placeholder="A">
                    </div>
                    <div class="form-group">
                        <label for="folio">Folio *</label>
                        <input type="text" id="folio" placeholder="Ej: 1, 123, A001" maxlength="40" required>
                    </div>
                    <div class="form-group">
                        <label for="fecha">Fecha y Hora *</label>
                        <input type="datetime-local" id="fecha" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="metodoPago">M√©todo de Pago *</label>
                        <select id="metodoPago" required>
                            <option value="">Seleccionar m√©todo de pago</option>
                            <option value="PUE">PUE - Pago en una sola exhibici√≥n</option>
                            <option value="PPD">PPD - Pago en parcialidades o diferido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="formaPago">Forma de Pago *</label>
                        <select id="formaPago" required>
                            <option value="">Seleccionar forma de pago</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Datos del Emisor -->
            <div class="form-section">
                <h3>üë§ Datos del Emisor</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorSelect">Seleccionar Emisor Registrado</label>
                        <select id="emisorSelect" onchange="cargarDatosEmisor()">
                            <option value="">Seleccionar emisor o llenar manualmente</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorRfc">RFC del Emisor *</label>
                        <input type="text" id="emisorRfc" placeholder="RFC123456789" required>
                    </div>
                    <div class="form-group">
                        <label for="emisorNombre">Nombre/Raz√≥n Social *</label>
                        <input type="text" id="emisorNombre" placeholder="Empresa S.A. de C.V." required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emisorCodigoPostal">C√≥digo Postal *</label>
                        <input type="text" id="emisorCodigoPostal" placeholder="06000" maxlength="5" pattern="[0-9]{5}" required>
                    </div>
                    <div class="form-group">
                        <label for="emisorRegimenFiscal">R√©gimen Fiscal *</label>
                        <select id="emisorRegimenFiscal" required>
                            <option value="">Seleccionar r√©gimen fiscal</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Datos del Receptor -->
            <div class="form-section">
                <h3>üè¢ Datos del Receptor</h3>
                
                <!-- Selector de Receptor Guardado -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptorGuardado">Receptor Guardado</label>
                        <select id="receptorGuardado" onchange="cargarReceptorGuardado()">
                            <option value="">Seleccionar receptor guardado o capturar manualmente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-info" onclick="gestionarReceptores()" style="margin-top: 25px;">üìã Gestionar Receptores</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptorRfc">RFC del Receptor *</label>
                        <input type="text" id="receptorRfc" placeholder="XAXX010101000" required>
                    </div>
                    <div class="form-group">
                        <label for="receptorNombre">Nombre/Raz√≥n Social *</label>
                        <input type="text" id="receptorNombre" placeholder="Cliente S.A. de C.V." required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptorCodigoPostal">C√≥digo Postal *</label>
                        <input type="text" id="receptorCodigoPostal" placeholder="06000" maxlength="5" pattern="[0-9]{5}" required>
                    </div>
                    <div class="form-group">
                        <label for="receptorRegimenFiscal">R√©gimen Fiscal *</label>
                        <select id="receptorRegimenFiscal" required>
                            <option value="">Seleccionar r√©gimen fiscal</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="usoCfdi">Uso de CFDI *</label>
                        <select id="usoCfdi" required>
                            <option value="">Seleccionar uso de CFDI</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Datos Adicionales eliminados: ObjetoImp ahora solo va por concepto -->

            <!-- Conceptos -->
            <div class="form-section">
                <h3>üõçÔ∏è Conceptos</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="conceptoDescripcion">Descripci√≥n *</label>
                        <input type="text" id="conceptoDescripcion" placeholder="Descripci√≥n del producto o servicio">
                    </div>
                    <div class="form-group">
                        <label for="conceptoCantidad">Cantidad *</label>
                        <input type="number" id="conceptoCantidad" placeholder="1" min="0.01" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="conceptoValorUnitario">Valor Unitario *</label>
                        <input type="number" id="conceptoValorUnitario" placeholder="100.00" min="0.01" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="conceptoClaveUnidad">Clave Unidad *</label>
                        <select id="conceptoClaveUnidad">
                            <option value="">Seleccionar unidad</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="conceptoClaveProducto">Clave Producto/Servicio *</label>
                        <input type="text" id="conceptoClaveProducto" placeholder="12345678" maxlength="8" pattern="[0-9]{8}">
                    </div>
                    <div class="form-group">
                        <label for="conceptoImpuesto">Impuesto</label>
                        <select id="conceptoImpuesto">
                            <option value="">Sin impuesto</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="conceptoObjetoImpGroup" style="display: none;">
                    <div class="form-group">
                        <label for="conceptoObjetoImp">Objeto de Impuesto (CFDI 4.0) *</label>
                        <select id="conceptoObjetoImp">
                            <option value="">Seleccionar objeto de impuesto</option>
                            <option value="01">01 - No objeto de impuesto</option>
                            <option value="02">02 - S√≠ objeto de impuesto</option>
                            <option value="03">03 - S√≠ objeto de impuesto y no obligado al desglose</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <!-- Espacio para mantener el dise√±o -->
                    </div>
                </div>
                <div class="actions">
                    <!-- BOTONES DE PRUEBA TEMPORALES -->
                    <button type="button" class="btn btn-secondary" onclick="testFunction()" style="margin-right: 10px;">üîß Test JS</button>
                    <button type="button" class="btn btn-info" onclick="verificarFunciones()" style="margin-right: 10px;">üîç Verificar</button>
                    <button type="button" class="btn btn-primary" onclick="agregarConcepto()">‚û• Agregar Concepto</button>
                </div>

                <div class="conceptos-container" id="conceptosContainer">
                    <!-- Los conceptos se agregar√°n aqu√≠ din√°micamente -->
                </div>
            </div>

            <!-- Totales -->
            <div class="totales">
                <h3>üí∞ Totales</h3>
                <div class="totales-grid">
                    <div class="total-item">
                        <div class="total-label">Subtotal</div>
                        <div class="total-value" id="subtotalValue">$0.00</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">IVA</div>
                        <div class="total-value" id="ivaValue">$0.00</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Total</div>
                        <div class="total-value" id="totalValue">$0.00</div>
                    </div>
                </div>
            </div>

            <!-- Opciones de Guardado -->
            <div class="save-options">
                <h4>üíæ Opciones de Guardado</h4>
                <div class="save-checkbox">
                    <input type="checkbox" id="autoSave" checked>
                    <label for="autoSave">Guardar autom√°ticamente en mi cuenta</label>
                </div>
                <div class="save-checkbox">
                    <input type="checkbox" id="downloadXml" checked>
                    <label for="downloadXml">Descargar XML al generar</label>
                </div>
            </div>

            <!-- Acciones -->
            <div class="actions">
                <button type="button" class="btn btn-success" onclick="generarXML()">üöÄ Generar XML</button>
                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">üßπ Limpiar</button>
                <button type="button" class="btn btn-primary" onclick="descargarXML()" id="btnDescargar" style="display: none;">üì• Descargar XML</button>
            </div>

            <!-- Salida XML -->
            <div id="xmlOutput" class="xml-output" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let conceptos = [];
        let conceptoCounter = 0;
        let xmlGenerado = '';
        let currentUser = null;
        let emisoresUsuario = [];

        // Cat√°logos SAT
        const catalogos = {
            formaPago: {
                '001': 'Efectivo',
                '002': 'Cheque Nominativo',
                '003': 'Transferencia Electr√≥nica de Fondos SPEI',
                '004': 'Tarjeta de Cr√©dito',
                '005': 'Monedero Electr√≥nico',
                '006': 'Dinero Electr√≥nico',
                '008': 'Vales de Despensa',
                '012': 'Daci√≥n en Pago',
                '013': 'Pago por Subrogaci√≥n',
                '014': 'Pago por Consignaci√≥n',
                '015': 'Condonaci√≥n',
                '017': 'Compensaci√≥n',
                '023': 'Novaci√≥n',
                '024': 'Confusi√≥n',
                '025': 'Remisi√≥n de Deuda',
                '026': 'Prescripci√≥n o Caducidad',
                '027': 'A Satisfacci√≥n del Acreedor',
                '028': 'Tarjeta de D√©bito',
                '029': 'Tarjeta de Servicios',
                '030': 'Aplicaci√≥n de Anticipos',
                '031': 'Intermediario Pagos',
                '099': 'Por Definir'
            },
            claveUnidad: {
                'H87': 'Pieza',
                'E48': 'Unidad de servicio',
                'ACT': 'Actividad',
                'E51': 'Trabajo',
                'A9': 'Tarifa',
                'MTR': 'Metro',
                'KGM': 'Kilogramo',
                'LTR': 'Litro',
                'HUR': 'Hora',
                'DAY': 'D√≠a',
                'MON': 'Mes',
                'ANN': 'A√±o'
            },
            impuestos: {
                '001': 'ISR',
                '002': 'IVA',
                '003': 'IEPS'
            },
            usoCfdi: {
                'G01': 'Adquisici√≥n de mercanc√≠as',
                'G02': 'Devoluciones, descuentos o bonificaciones',
                'G03': 'Gastos en general',
                'I01': 'Construcciones',
                'I02': 'Mobiliario y equipo de oficina por inversiones',
                'I03': 'Equipo de transporte',
                'I04': 'Equipo de computo y accesorios',
                'I05': 'Dados, troqueles, moldes, matrices y herramental',
                'I06': 'Comunicaciones telef√≥nicas',
                'I07': 'Comunicaciones satelitales',
                'I08': 'Otra maquinaria y equipo',
                'D01': 'Honorarios m√©dicos, dentales y gastos hospitalarios',
                'D02': 'Gastos m√©dicos por incapacidad o discapacidad',
                'D03': 'Gastos funerales',
                'D04': 'Donativos',
                'D05': 'Intereses reales efectivamente pagados por cr√©ditos hipotecarios',
                'D06': 'Aportaciones voluntarias al SAR',
                'D07': 'Primas por seguros de gastos m√©dicos',
                'D08': 'Gastos de transportaci√≥n escolar obligatoria',
                'D09': 'Dep√≥sitos en cuentas para el ahorro, primas que tengan como base planes de pensiones',
                'D10': 'Pagos por servicios educativos',
                'P01': 'Por definir',
                'S01': 'Sin efectos fiscales',
                'CP01': 'Pagos',
                'CN01': 'N√≥mina'
            },
            regimenFiscal33: {
                '601': 'General de Ley Personas Morales',
                '603': 'Personas Morales con Fines no Lucrativos',
                '605': 'Sueldos y Salarios e Ingresos Asimilados a Salarios',
                '606': 'Arrendamiento',
                '608': 'Dem√°s ingresos',
                '609': 'Consolidaci√≥n',
                '610': 'Residentes en el Extranjero sin Establecimiento Permanente en M√©xico',
                '611': 'Ingresos por Dividendos (socios y accionistas)',
                '612': 'Personas F√≠sicas con Actividades Empresariales y Profesionales',
                '614': 'Ingresos por intereses',
                '616': 'Sin obligaciones fiscales',
                '620': 'Sociedades Cooperativas de Producci√≥n que optan por diferir sus ingresos',
                '621': 'Incorporaci√≥n Fiscal',
                '622': 'Actividades Agr√≠colas, Ganaderas, Silv√≠colas y Pesqueras',
                '623': 'Opcional para Grupos de Sociedades',
                '624': 'Coordinados',
                '628': 'Hidrocarburos',
                '607': 'R√©gimen de Enajenaci√≥n o Adquisici√≥n de Bienes',
                '629': 'De los Reg√≠menes Fiscales Preferentes y de las Empresas Multinacionales',
                '630': 'Enajenaci√≥n de acciones en bolsa de valores'
            },
            regimenFiscal40: {
                '601': 'General de Ley Personas Morales',
                '603': 'Personas Morales con Fines no Lucrativos',
                '605': 'Sueldos y Salarios e Ingresos Asimilados a Salarios',
                '606': 'Arrendamiento',
                '607': 'R√©gimen de Enajenaci√≥n o Adquisici√≥n de Bienes',
                '608': 'Dem√°s ingresos',
                '610': 'Residentes en el Extranjero sin Establecimiento Permanente en M√©xico',
                '611': 'Ingresos por Dividendos (socios y accionistas)',
                '612': 'Personas F√≠sicas con Actividades Empresariales y Profesionales',
                '614': 'Ingresos por intereses',
                '615': 'R√©gimen de los ingresos por obtenci√≥n de premios',
                '616': 'Sin obligaciones fiscales',
                '620': 'Sociedades Cooperativas de Producci√≥n que optan por diferir sus ingresos',
                '621': 'Incorporaci√≥n Fiscal',
                '622': 'Actividades Agr√≠colas, Ganaderas, Silv√≠colas y Pesqueras',
                '623': 'Opcional para Grupos de Sociedades',
                '624': 'Coordinados',
                '625': 'R√©gimen de las Actividades Empresariales con ingresos a trav√©s de Plataformas Tecnol√≥gicas',
                '626': 'R√©gimen Simplificado de Confianza'
            }
        };

        // Verificar autenticaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            await verificarAutenticacion();
            await cargarEmisores();
            inicializarAplicacion();
        });

        // Funci√≥n para verificar autenticaci√≥n
        async function verificarAutenticacion() {
            const token = localStorage.getItem('cfdi_token');
            if (!token) {
                // Permitir uso sin login pero con funcionalidad limitada
                showAlert('Usando modo invitado. Para guardar XMLs, <a href="/login">inicia sesi√≥n</a>.', 'info');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ action: 'verify' })
                });

                const data = await response.json();
                if (data.valid) {
                    currentUser = data.user;
                    document.getElementById('userInfo').style.display = 'block';
                    document.getElementById('currentUserName').textContent = currentUser.nombre;
                    document.getElementById('currentUserEmail').textContent = currentUser.email;
                } else {
                    localStorage.removeItem('cfdi_token');
                    localStorage.removeItem('cfdi_user');
                    showAlert('Sesi√≥n expirada. Usando modo invitado.', 'info');
                }
            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                showAlert('Error de conexi√≥n. Usando modo invitado.', 'info');
            }
        }

        // Funci√≥n para cargar emisores del usuario desde localStorage
        async function cargarEmisores() {
            console.log('üìã CFDI GENERATOR: Cargando emisores desde localStorage...');
            
            try {
                // Cargar emisores desde localStorage (consistente con dashboard)
                const emisoresGuardados = localStorage.getItem('cfdi_emisores');
                if (emisoresGuardados) {
                    emisoresUsuario = JSON.parse(emisoresGuardados);
                    console.log(`‚úÖ ${emisoresUsuario.length} emisores cargados desde localStorage`);
                } else {
                    emisoresUsuario = [];
                    console.log('üìÑ No hay emisores guardados');
                }
                
                // Actualizar el select de emisores
                const select = document.getElementById('emisorSelect');
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar emisor o llenar manualmente</option>';
                    
                    emisoresUsuario.forEach(emisor => {
                        const option = document.createElement('option');
                        option.value = emisor.id;
                        option.textContent = `${emisor.rfc} - ${emisor.nombre}`;
                        select.appendChild(option);
                    });
                    
                    console.log(`‚úÖ Select de emisores actualizado con ${emisoresUsuario.length} opciones`);
                } else {
                    console.error('‚ùå Select de emisores no encontrado en el DOM');
                }
            } catch (error) {
                console.error('‚ùå Error cargando emisores:', error);
                emisoresUsuario = [];
            }
        }

        // Funci√≥n para cargar datos del emisor seleccionado
        function cargarDatosEmisor() {
            const emisorId = document.getElementById('emisorSelect').value;
            if (!emisorId) return;

            const emisor = emisoresUsuario.find(e => e.id === emisorId);
            if (emisor) {
                document.getElementById('emisorRfc').value = emisor.rfc;
                document.getElementById('emisorNombre').value = emisor.nombre;
                document.getElementById('emisorCodigoPostal').value = emisor.codigo_postal;
                document.getElementById('emisorRegimenFiscal').value = emisor.regimen_fiscal;
            }
        }

        function logout() {
            localStorage.removeItem('cfdi_token');
            localStorage.removeItem('cfdi_user');
            window.location.href = '/';
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Funci√≥n para inicializar la aplicaci√≥n
        function inicializarAplicacion() {
            inicializarFecha();
            cargarCatalogos();
            actualizarRegimenesFiscales();
            cambiarVersionCfdi();
        }

        // Funci√≥n para inicializar fecha y hora actual
        function inicializarFecha() {
            const now = new Date();
            // Asegurar que los segundos nunca sean 00
            if (now.getSeconds() === 0) {
                now.setSeconds(1);
            }
            const fechaISO = now.toISOString().slice(0, 19);
            document.getElementById('fecha').value = fechaISO;
            cargarCatalogos();
            cargarEmisores();
            cargarListaReceptores(); // Cargar receptores guardados
            cambiarVersionCfdi();
        }

        // Funci√≥n para cargar cat√°logos en los selects
        function cargarCatalogos() {
            // Cargar forma de pago
            const formaPagoSelect = document.getElementById('formaPago');
            Object.entries(catalogos.formaPago).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                formaPagoSelect.appendChild(option);
            });

            // Cargar clave unidad
            const claveUnidadSelect = document.getElementById('conceptoClaveUnidad');
            Object.entries(catalogos.claveUnidad).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                claveUnidadSelect.appendChild(option);
            });

            // Cargar impuestos
            const impuestoSelect = document.getElementById('conceptoImpuesto');
            Object.entries(catalogos.impuestos).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                impuestoSelect.appendChild(option);
            });

            // Cargar uso de CFDI
            const usoCfdiSelect = document.getElementById('usoCfdi');
            Object.entries(catalogos.usoCfdi).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                usoCfdiSelect.appendChild(option);
            });
        }

        // Funci√≥n para actualizar reg√≠menes fiscales seg√∫n la versi√≥n
        function actualizarRegimenesFiscales() {
            const version = document.getElementById('versionCfdi').value;
            const regimenes = version === '4.0' ? catalogos.regimenFiscal40 : catalogos.regimenFiscal33;
            
            // Actualizar emisor
            const emisorSelect = document.getElementById('emisorRegimenFiscal');
            emisorSelect.innerHTML = '<option value="">Seleccionar r√©gimen fiscal</option>';
            Object.entries(regimenes).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                emisorSelect.appendChild(option);
            });

            // Actualizar receptor
            const receptorSelect = document.getElementById('receptorRegimenFiscal');
            receptorSelect.innerHTML = '<option value="">Seleccionar r√©gimen fiscal</option>';
            Object.entries(regimenes).forEach(([codigo, descripcion]) => {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = `${codigo} - ${descripcion}`;
                receptorSelect.appendChild(option);
            });
        }

        // Funci√≥n para cambiar versi√≥n CFDI
        function cambiarVersionCfdi() {
            const version = document.getElementById('versionCfdi').value;
            const conceptoObjetoImpGroup = document.getElementById('conceptoObjetoImpGroup'); // Campo por concepto
            const versionWarning = document.getElementById('versionWarning');
            const mainTitle = document.getElementById('mainTitle');
            const pageTitle = document.getElementById('pageTitle');
            
            console.log(`üîß CFDI GENERATOR: Cambiando versi√≥n a ${version}`);
            
            if (version === '3.3') {
                // CFDI 3.3: Ocultar ObjetoImp por concepto (no existe en 3.3)
                if (conceptoObjetoImpGroup) conceptoObjetoImpGroup.style.display = 'none';
                versionWarning.style.display = 'block';
                mainTitle.textContent = 'üìÑ Generador CFDI 3.3 - Sistema Completo';
                pageTitle.textContent = 'üìÑ Generador CFDI 3.3 - Sistema Completo';
                console.log('‚úÖ CFDI 3.3: ObjetoImp por concepto oculto (no aplica)');
            } else {
                // CFDI 4.0: Mostrar ObjetoImp por concepto
                if (conceptoObjetoImpGroup) conceptoObjetoImpGroup.style.display = 'block'; // Mostrar campo por concepto
                versionWarning.style.display = 'none';
                mainTitle.textContent = 'üöÄ Generador CFDI 4.0 - Sistema Completo';
                pageTitle.textContent = 'üöÄ Generador CFDI 4.0 - Sistema Completo';
                console.log('‚úÖ CFDI 4.0: ObjetoImp por concepto habilitado');
            }
            
            actualizarRegimenesFiscales();
        }

        // FUNCI√ìN DE EMERGENCIA PARA TESTING
        window.testFunction = function() {
            alert('‚úÖ JavaScript funciona correctamente!');
            console.log('‚úÖ Funci√≥n de prueba ejecutada');
        };
        
        // VERIFICACI√ìN DE FUNCIONES GLOBALES
        window.verificarFunciones = function() {
            console.log('üîç VERIFICANDO FUNCIONES GLOBALES:');
            console.log('- testFunction:', typeof window.testFunction);
            console.log('- agregarConcepto:', typeof window.agregarConcepto);
            console.log('- generarXML:', typeof window.generarXML);
            console.log('- conceptos array:', conceptos ? conceptos.length : 'undefined');
            alert('‚úÖ Verificaci√≥n completa - Ver consola para detalles');
        };
        
        // SISTEMA DE RECEPTORES GUARDADOS
        let receptoresGuardados = JSON.parse(localStorage.getItem('receptoresGuardados') || '[]');
        
        // Funci√≥n para cargar receptores guardados en el selector
        function cargarListaReceptores() {
            const selector = document.getElementById('receptorGuardado');
            selector.innerHTML = '<option value="">Seleccionar receptor guardado o capturar manualmente</option>';
            
            receptoresGuardados.forEach((receptor, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${receptor.rfc} - ${receptor.nombre}`;
                selector.appendChild(option);
            });
            
            console.log('üìã Receptores cargados:', receptoresGuardados.length);
        }
        
        // Funci√≥n para cargar datos de receptor guardado
        window.cargarReceptorGuardado = function() {
            const selector = document.getElementById('receptorGuardado');
            const index = selector.value;
            
            if (index === '') {
                // Limpiar campos si se selecciona "capturar manualmente"
                document.getElementById('receptorRfc').value = '';
                document.getElementById('receptorNombre').value = '';
                document.getElementById('receptorCodigoPostal').value = '';
                document.getElementById('receptorRegimenFiscal').value = '';
                document.getElementById('usoCfdi').value = '';
                return;
            }
            
            const receptor = receptoresGuardados[index];
            if (receptor) {
                document.getElementById('receptorRfc').value = receptor.rfc;
                document.getElementById('receptorNombre').value = receptor.nombre;
                document.getElementById('receptorCodigoPostal').value = receptor.codigoPostal;
                document.getElementById('receptorRegimenFiscal').value = receptor.regimenFiscal;
                document.getElementById('usoCfdi').value = receptor.usoCfdi;
                
                console.log('‚úÖ Receptor cargado:', receptor.rfc, '-', receptor.nombre);
                showAlert(`‚úÖ Receptor cargado: ${receptor.nombre}`, 'success');
            }
        };
        
        // Funci√≥n para guardar receptor autom√°ticamente
        function guardarReceptorAutomaticamente() {
            const receptorData = {
                rfc: document.getElementById('receptorRfc').value,
                nombre: document.getElementById('receptorNombre').value,
                codigoPostal: document.getElementById('receptorCodigoPostal').value,
                regimenFiscal: document.getElementById('receptorRegimenFiscal').value,
                usoCfdi: document.getElementById('usoCfdi').value,
                fechaCreacion: new Date().toISOString()
            };
            
            // Verificar si el receptor ya existe (por RFC)
            const existeIndex = receptoresGuardados.findIndex(r => r.rfc === receptorData.rfc);
            
            if (existeIndex >= 0) {
                // Actualizar receptor existente
                receptoresGuardados[existeIndex] = { ...receptoresGuardados[existeIndex], ...receptorData };
                console.log('üîÑ Receptor actualizado:', receptorData.rfc);
            } else {
                // Agregar nuevo receptor
                receptoresGuardados.push(receptorData);
                console.log('‚úÖ Nuevo receptor guardado:', receptorData.rfc);
            }
            
            // Guardar en localStorage
            localStorage.setItem('receptoresGuardados', JSON.stringify(receptoresGuardados));
            
            // Recargar lista
            cargarListaReceptores();
            
            return receptorData;
        }
        
        // Funci√≥n para gestionar receptores
        window.gestionarReceptores = function() {
            const mensaje = `üìã RECEPTORES GUARDADOS (${receptoresGuardados.length}):\n\n` +
                receptoresGuardados.map((r, i) => 
                    `${i + 1}. ${r.rfc} - ${r.nombre}\n   CP: ${r.codigoPostal} | R√©gimen: ${r.regimenFiscal} | Uso: ${r.usoCfdi}`
                ).join('\n\n') +
                '\n\n‚ÑπÔ∏è Los receptores se guardan autom√°ticamente al generar XMLs exitosamente.';
            
            alert(mensaje);
        };
        
        // Funci√≥n para agregar concepto - DISPONIBLE GLOBALMENTE
        window.agregarConcepto = function agregarConcepto() {
            console.log('üîß DIAGN√ìSTICO: Iniciando agregarConcepto()');
            
            // Verificar elementos del DOM
            const elementos = {
                descripcion: document.getElementById('conceptoDescripcion'),
                cantidad: document.getElementById('conceptoCantidad'),
                valorUnitario: document.getElementById('conceptoValorUnitario'),
                claveUnidad: document.getElementById('conceptoClaveUnidad'),
                claveProducto: document.getElementById('conceptoClaveProducto'),
                impuesto: document.getElementById('conceptoImpuesto'),
                objetoImp: document.getElementById('conceptoObjetoImp'),
                version: document.getElementById('versionCfdi')
            };
            
            // Verificar que todos los elementos existan
            for (const [nombre, elemento] of Object.entries(elementos)) {
                if (!elemento) {
                    console.error(`‚ùå ERROR: Elemento '${nombre}' no encontrado en el DOM`);
                    showAlert(`Error: Campo '${nombre}' no encontrado`, 'error');
                    return;
                }
            }
            
            const descripcion = elementos.descripcion.value;
            const cantidad = parseFloat(elementos.cantidad.value);
            const valorUnitario = parseFloat(elementos.valorUnitario.value);
            const claveUnidad = elementos.claveUnidad.value;
            const claveProducto = elementos.claveProducto.value;
            const impuesto = elementos.impuesto.value;
            const objetoImp = elementos.objetoImp.value;
            const version = elementos.version.value;
            
            console.log('üìã VALORES CAPTURADOS:', {
                descripcion, cantidad, valorUnitario, claveUnidad, 
                claveProducto, impuesto, objetoImp, version
            });
            
            // VALIDACI√ìN DETALLADA CON LOGS
            console.log('üîç VALIDANDO CAMPOS OBLIGATORIOS...');
            
            if (!descripcion) {
                console.error('‚ùå FALLA: Descripci√≥n vac√≠a');
                showAlert('‚ö†Ô∏è Complete la descripci√≥n del concepto', 'error');
                return;
            }
            
            if (!cantidad || isNaN(cantidad)) {
                console.error('‚ùå FALLA: Cantidad inv√°lida:', cantidad);
                showAlert('‚ö†Ô∏è Complete la cantidad del concepto', 'error');
                return;
            }
            
            if (!valorUnitario || isNaN(valorUnitario)) {
                console.error('‚ùå FALLA: Valor unitario inv√°lido:', valorUnitario);
                showAlert('‚ö†Ô∏è Complete el valor unitario del concepto', 'error');
                return;
            }
            
            if (!claveUnidad) {
                console.error('‚ùå FALLA: Clave unidad vac√≠a');
                showAlert('‚ö†Ô∏è Seleccione la clave de unidad', 'error');
                return;
            }
            
            if (!claveProducto) {
                console.error('‚ùå FALLA: Clave producto vac√≠a');
                showAlert('‚ö†Ô∏è Complete la clave de producto/servicio', 'error');
                return;
            }
            
            console.log('üîç VALIDANDO CLAVE DE PRODUCTO...');
            if (claveProducto.length !== 8) {
                console.error('‚ùå FALLA: Clave producto longitud incorrecta:', claveProducto.length, 'caracteres');
                showAlert('‚ö†Ô∏è La clave de producto/servicio debe tener exactamente 8 d√≠gitos', 'error');
                return;
            }
            
            if (!/^[0-9]{8}$/.test(claveProducto)) {
                console.error('‚ùå FALLA: Clave producto formato incorrecto:', claveProducto);
                showAlert('‚ö†Ô∏è La clave de producto/servicio debe contener solo n√∫meros', 'error');
                return;
            }
            
            console.log('üîç VALIDANDO OBJETO DE IMPUESTO...');
            if (version === '4.0' && !objetoImp) {
                console.error('‚ùå FALLA: ObjetoImp requerido para CFDI 4.0');
                showAlert('‚ö†Ô∏è Objeto de Impuesto es obligatorio para CFDI 4.0', 'error');
                return;
            }
            
            console.log('‚úÖ TODAS LAS VALIDACIONES PASARON');
            
            
            const importe = cantidad * valorUnitario;
            let impuestoInfo = null;
            
            if (impuesto) {
                const tasaImpuesto = impuesto === '002' ? 0.16 : 0; // IVA 16%
                const importeImpuesto = importe * tasaImpuesto;
                impuestoInfo = {
                    codigo: impuesto,
                    nombre: catalogos.impuestos[impuesto],
                    tasa: tasaImpuesto,
                    importe: importeImpuesto
                };
            }
            
            const concepto = {
                id: ++conceptoCounter,
                descripcion,
                cantidad,
                valorUnitario,
                claveUnidad,
                claveProducto,
                importe,
                impuesto: impuestoInfo,
                objetoImp: version === '4.0' ? objetoImp : null
            };
            
            console.log('‚úÖ CONCEPTO CREADO:', concepto);
            conceptos.push(concepto);
            console.log('üìä ARRAY CONCEPTOS ACTUALIZADO:', conceptos);
            console.log('üîÑ Llamando renderizarConceptos()...');
            renderizarConceptos();
            console.log('üßπ Limpiando formulario...');
            limpiarFormularioConcepto();
            console.log('üí∞ Actualizando totales...');
            actualizarTotales();
            console.log('‚úÖ CONCEPTO AGREGADO EXITOSAMENTE');
        }

        // Funci√≥n para limpiar formulario de concepto
        function limpiarFormularioConcepto() {
            document.getElementById('conceptoDescripcion').value = '';
            document.getElementById('conceptoCantidad').value = '';
            document.getElementById('conceptoValorUnitario').value = '';
            document.getElementById('conceptoClaveUnidad').value = '';
            document.getElementById('conceptoClaveProducto').value = '';
            document.getElementById('conceptoImpuesto').value = '';
            document.getElementById('conceptoObjetoImp').value = '';
        }

        // Funci√≥n para renderizar conceptos
        function renderizarConceptos() {
            console.log('üé® RENDERIZANDO CONCEPTOS:', conceptos.length, 'conceptos');
            const container = document.getElementById('conceptosContainer');
            
            if (!container) {
                console.error('‚ùå ERROR: Container conceptosContainer no encontrado');
                return;
            }
            
            console.log('üì¶ Container encontrado:', container);
            container.innerHTML = '';
            
            if (conceptos.length === 0) {
                console.log('‚ö†Ô∏è No hay conceptos para renderizar');
                return;
            }
            
            conceptos.forEach((concepto, index) => {
                console.log(`üîÑ Renderizando concepto ${index + 1}:`, concepto);
                const conceptoDiv = document.createElement('div');
                conceptoDiv.className = 'concepto-item';
                conceptoDiv.innerHTML = `
                    <div class="concepto-header">
                        <span class="concepto-title">Concepto #${concepto.id}</span>
                        <button class="btn-remove" onclick="eliminarConcepto(${concepto.id})" title="Eliminar concepto">√ó</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <strong>Descripci√≥n:</strong> ${concepto.descripcion}
                        </div>
                        <div class="form-group">
                            <strong>Cantidad:</strong> ${concepto.cantidad}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <strong>Valor Unitario:</strong> $${concepto.valorUnitario.toFixed(2)}
                        </div>
                        <div class="form-group">
                            <strong>Importe:</strong> $${concepto.importe.toFixed(2)}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <strong>Clave Unidad:</strong> ${concepto.claveUnidad}
                        </div>
                        <div class="form-group">
                            <strong>Clave Producto:</strong> ${concepto.claveProducto}
                        </div>
                    </div>
                    ${concepto.impuesto ? `
                        <div class="form-row">
                            <div class="form-group">
                                <strong>Impuesto:</strong> ${concepto.impuesto.nombre} (${(concepto.impuesto.tasa * 100).toFixed(0)}%)
                            </div>
                            <div class="form-group">
                                <strong>Importe Impuesto:</strong> $${concepto.impuesto.importe.toFixed(2)}
                            </div>
                        </div>
                    ` : ''}
                `;
                container.appendChild(conceptoDiv);
            });
        }

        // Funci√≥n para eliminar concepto
        function eliminarConcepto(id) {
            conceptos = conceptos.filter(c => c.id !== id);
            renderizarConceptos();
            actualizarTotales();
        }

        // Funci√≥n para actualizar totales
        function actualizarTotales() {
            const subtotal = conceptos.reduce((sum, c) => sum + c.importe, 0);
            const iva = conceptos.reduce((sum, c) => sum + (c.impuesto ? c.impuesto.importe : 0), 0);
            const total = subtotal + iva;
            
            document.getElementById('subtotalValue').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('ivaValue').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('totalValue').textContent = `$${total.toFixed(2)}`;
        }

        // Funci√≥n principal para generar XML
        // Funci√≥n para generar XML - DISPONIBLE GLOBALMENTE
        window.generarXML = async function generarXML() {
            console.log('üöÄ DIAGN√ìSTICO: Iniciando generarXML()');
            if (conceptos.length === 0) {
                showAlert('‚ö†Ô∏è Debe agregar al menos un concepto', 'error');
                return;
            }

            // SISTEMA ROBUSTO DE VALIDACI√ìN Y CONTROL DE ERRORES
            console.log('üîç INICIANDO VALIDACI√ìN COMPLETA DE CAMPOS...');
            
            const erroresValidacion = [];
            const version = document.getElementById('versionCfdi').value;
            
            // 1. VALIDAR DATOS GENERALES
            console.log('üîç Validando Datos Generales...');
            const serie = document.getElementById('serie').value.trim();
            const folio = document.getElementById('folio').value.trim();
            const fecha = document.getElementById('fecha').value.trim();
            const metodoPago = document.getElementById('metodoPago').value.trim();
            const formaPago = document.getElementById('formaPago').value.trim();
            
            if (!folio) erroresValidacion.push('‚ùå Folio es obligatorio');
            if (!fecha) erroresValidacion.push('‚ùå Fecha es obligatoria');
            if (!metodoPago) erroresValidacion.push('‚ùå M√©todo de Pago es obligatorio');
            if (!formaPago) erroresValidacion.push('‚ùå Forma de Pago es obligatoria');
            
            // 2. VALIDAR DATOS DEL EMISOR
            console.log('üîç Validando Datos del Emisor...');
            const emisorRfc = document.getElementById('emisorRfc').value.trim();
            const emisorNombre = document.getElementById('emisorNombre').value.trim();
            const emisorCP = document.getElementById('emisorCodigoPostal').value.trim();
            const emisorRegimen = document.getElementById('emisorRegimenFiscal').value.trim();
            
            if (!emisorRfc) {
                erroresValidacion.push('‚ùå RFC del Emisor es obligatorio');
            } else if (!/^[A-Z&√ë]{3,4}[0-9]{6}[A-Z0-9]{3}$/.test(emisorRfc)) {
                erroresValidacion.push('‚ùå RFC del Emisor tiene formato inv√°lido');
            }
            
            if (!emisorNombre) erroresValidacion.push('‚ùå Nombre del Emisor es obligatorio');
            
            if (!emisorCP) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Emisor es obligatorio');
            } else if (!/^[0-9]{5}$/.test(emisorCP)) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Emisor debe tener 5 d√≠gitos');
            }
            
            if (!emisorRegimen) erroresValidacion.push('‚ùå R√©gimen Fiscal del Emisor es obligatorio');
            
            // 3. VALIDAR DATOS DEL RECEPTOR
            console.log('üîç Validando Datos del Receptor...');
            const receptorRfc = document.getElementById('receptorRfc').value.trim();
            const receptorNombre = document.getElementById('receptorNombre').value.trim();
            const receptorCP = document.getElementById('receptorCodigoPostal').value.trim();
            const receptorRegimen = document.getElementById('receptorRegimenFiscal').value.trim();
            const usoCfdi = document.getElementById('usoCfdi').value.trim();
            
            if (!receptorRfc) {
                erroresValidacion.push('‚ùå RFC del Receptor es obligatorio');
            } else if (!/^[A-Z&√ë]{3,4}[0-9]{6}[A-Z0-9]{3}$/.test(receptorRfc)) {
                erroresValidacion.push('‚ùå RFC del Receptor tiene formato inv√°lido');
            }
            
            if (!receptorNombre) erroresValidacion.push('‚ùå Nombre del Receptor es obligatorio');
            
            if (!receptorCP) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Receptor es obligatorio');
            } else if (!/^[0-9]{5}$/.test(receptorCP)) {
                erroresValidacion.push('‚ùå C√≥digo Postal del Receptor debe tener 5 d√≠gitos');
            }
            
            if (!receptorRegimen) erroresValidacion.push('‚ùå R√©gimen Fiscal del Receptor es obligatorio');
            if (!usoCfdi) erroresValidacion.push('‚ùå Uso de CFDI es obligatorio');
            
            // 4. VALIDAR CONCEPTOS
            console.log('üîç Validando Conceptos...');
            if (conceptos.length === 0) {
                erroresValidacion.push('‚ùå Debe agregar al menos un concepto');
            } else {
                // Validar cada concepto
                conceptos.forEach((concepto, index) => {
                    if (!concepto.descripcion) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Descripci√≥n faltante`);
                    if (!concepto.cantidad || concepto.cantidad <= 0) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Cantidad inv√°lida`);
                    if (!concepto.valorUnitario || concepto.valorUnitario <= 0) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Valor unitario inv√°lido`);
                    if (!concepto.claveUnidad) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Clave de unidad faltante`);
                    if (!concepto.claveProducto) erroresValidacion.push(`‚ùå Concepto ${index + 1}: Clave de producto faltante`);
                    
                    // Validar ObjetoImp para CFDI 4.0
                    if (version === '4.0' && !concepto.objetoImp) {
                        erroresValidacion.push(`‚ùå Concepto ${index + 1}: Objeto de Impuesto es obligatorio para CFDI 4.0`);
                    }
                });
            }
            
            // 5. MOSTRAR ERRORES SI EXISTEN
            if (erroresValidacion.length > 0) {
                console.error('‚ùå ERRORES DE VALIDACI√ìN ENCONTRADOS:', erroresValidacion);
                const mensajeError = `üò® NO SE PUEDE GENERAR EL XML\n\nERRORES ENCONTRADOS (${erroresValidacion.length}):\n\n` +
                    erroresValidacion.map((error, i) => `${i + 1}. ${error}`).join('\n') +
                    '\n\n‚ÑπÔ∏è Por favor corrija estos errores e intente nuevamente.';
                
                showAlert(mensajeError, 'error');
                return;
            }
            
            console.log('‚úÖ TODAS LAS VALIDACIONES PASARON EXITOSAMENTE');
            

            try {
                // Generar XML base
                const xmlContent = construirXML();
                let xmlFinal = xmlContent;
                let sellado = false;
                let infoSellado = null;

                // Verificar si hay un emisor seleccionado para sellado autom√°tico
                const emisorSeleccionado = document.getElementById('emisorSelect').value;
                if (emisorSeleccionado && currentUser) {
                    try {
                        showAlert('üîê Procesando sellado digital...', 'info');
                        
                        // Llamar a la funci√≥n de sellado
                        const resultadoSellado = await sellarXMLConEmisor(xmlContent, emisorSeleccionado, version);
                        
                        if (resultadoSellado.exito) {
                            xmlFinal = resultadoSellado.xmlSellado;
                            sellado = true;
                            infoSellado = {
                                selloDigital: resultadoSellado.selloDigital,
                                numeroCertificado: resultadoSellado.numeroCertificado,
                                emisor: resultadoSellado.emisor
                            };
                            showAlert('‚úÖ XML generado y sellado digitalmente', 'success');
                        } else {
                            showAlert('‚ö†Ô∏è XML generado sin sellar: ' + resultadoSellado.error, 'warning');
                        }
                    } catch (selladoError) {
                        console.error('Error en sellado:', selladoError);
                        showAlert('‚ö†Ô∏è XML generado sin sellar: Error en el proceso de sellado', 'warning');
                    }
                } else {
                    showAlert('‚úÖ XML generado exitosamente (sin sellar)', 'success');
                }

                // Actualizar variable global
                xmlGenerado = xmlFinal;

                // Mostrar XML final
                document.getElementById('xmlOutput').textContent = xmlFinal;
                document.getElementById('xmlOutput').style.display = 'block';
                document.getElementById('btnDescargar').style.display = 'inline-block';

                // Mostrar informaci√≥n del sellado si aplica
                if (sellado && infoSellado) {
                    mostrarInfoSellado(infoSellado);
                }

                // Guardar receptor autom√°ticamente al generar XML exitosamente
                try {
                    const receptorGuardado = guardarReceptorAutomaticamente();
                    console.log('üìã Receptor guardado autom√°ticamente:', receptorGuardado.rfc);
                    showAlert(`‚úÖ XML generado exitosamente. Receptor ${receptorGuardado.nombre} guardado para uso futuro.`, 'success');
                } catch (error) {
                    console.error('Error guardando receptor:', error);
                }
                
                // Guardar autom√°ticamente si est√° habilitado y el usuario est√° logueado
                const autoSave = document.getElementById('autoSave').checked;
                if (autoSave && currentUser) {
                    await guardarXMLEnBD(xmlFinal, sellado, infoSellado);
                }

                // Descargar autom√°ticamente si est√° habilitado
                const downloadXml = document.getElementById('downloadXml').checked;
                if (downloadXml) {
                    descargarXML();
                }

            } catch (error) {
                console.error('Error generando XML:', error);
                showAlert('‚ùå Error al generar XML: ' + error.message, 'error');
            }
        }

        // Funci√≥n para construir el XML
        function construirXML() {
            const version = document.getElementById('versionCfdi').value;
            const fecha = document.getElementById('fecha').value.replace('T', ' ');
            const serie = document.getElementById('serie').value || '';
            const folio = document.getElementById('folio').value;
            
            // Datos del emisor
            const emisorRfc = document.getElementById('emisorRfc').value;
            const emisorNombre = document.getElementById('emisorNombre').value;
            const emisorCodigoPostal = document.getElementById('emisorCodigoPostal').value;
            const emisorRegimenFiscal = document.getElementById('emisorRegimenFiscal').value;
            
            // Datos del receptor
            const receptorRfc = document.getElementById('receptorRfc').value;
            const receptorNombre = document.getElementById('receptorNombre').value;
            const receptorCodigoPostal = document.getElementById('receptorCodigoPostal').value;
            const receptorRegimenFiscal = document.getElementById('receptorRegimenFiscal').value;
            const usoCfdi = document.getElementById('usoCfdi').value;
            
            // Datos de pago (ahora en Datos Generales)
            const metodoPago = document.getElementById('metodoPago').value;
            const formaPago = document.getElementById('formaPago').value;
            // ObjetoImp eliminado: ahora solo va por concepto
            
            // Calcular totales
            const subtotal = conceptos.reduce((sum, c) => sum + c.importe, 0);
            const totalImpuestos = conceptos.reduce((sum, c) => sum + (c.impuesto ? c.impuesto.importe : 0), 0);
            const total = subtotal + totalImpuestos;
            
            // Construir XML seg√∫n la versi√≥n
            let xml = '';
            
            if (version === '4.0') {
                xml = `<?xml version="1.0" encoding="UTF-8"?>
<cfdi:Comprobante xmlns:cfdi="http://www.sat.gob.mx/cfd/4" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sat.gob.mx/cfd/4 http://www.sat.gob.mx/sitio_internet/cfd/4/cfdv40.xsd" Version="4.0" Fecha="${fecha}" Sello="" FormaPago="${formaPago}" NoCertificado="" Certificado="" SubTotal="${subtotal.toFixed(2)}" Moneda="MXN" Total="${total.toFixed(2)}" TipoDeComprobante="I" Exportacion="01" MetodoPago="${metodoPago}" LugarExpedicion="${emisorCodigoPostal}"${serie ? ` Serie="${serie}"` : ''} Folio="${folio}">
`;
            } else {
                xml = `<?xml version="1.0" encoding="UTF-8"?>
<cfdi:Comprobante xmlns:cfdi="http://www.sat.gob.mx/cfd/3" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sat.gob.mx/cfd/3 http://www.sat.gob.mx/sitio_internet/cfd/3/cfdv33.xsd" Version="3.3" Fecha="${fecha}" Sello="" FormaPago="${formaPago}" NoCertificado="" Certificado="" SubTotal="${subtotal.toFixed(2)}" Moneda="MXN" Total="${total.toFixed(2)}" TipoDeComprobante="I" MetodoPago="${metodoPago}" LugarExpedicion="${emisorCodigoPostal}"${serie ? ` Serie="${serie}"` : ''} Folio="${folio}">
`;
            }
            
            // Emisor
            xml += `  <cfdi:Emisor Rfc="${emisorRfc}" Nombre="${emisorNombre}" RegimenFiscal="${emisorRegimenFiscal}"/>
`;
            
            // Receptor
            if (version === '4.0') {
                xml += `  <cfdi:Receptor Rfc="${receptorRfc}" Nombre="${receptorNombre}" DomicilioFiscalReceptor="${receptorCodigoPostal}" RegimenFiscalReceptor="${receptorRegimenFiscal}" UsoCFDI="${usoCfdi}"/>
`;
            } else {
                xml += `  <cfdi:Receptor Rfc="${receptorRfc}" Nombre="${receptorNombre}" UsoCFDI="${usoCfdi}"/>
`;
            }
            
            // Conceptos
            xml += `  <cfdi:Conceptos>
`;
            conceptos.forEach(concepto => {
                // ObjetoImp por concepto (CFDI 4.0) - Corregido seg√∫n especificaciones SAT
                const objetoImpAttr = version === '4.0' && concepto.objetoImp ? ` ObjetoImp="${concepto.objetoImp}"` : '';
                xml += `    <cfdi:Concepto ClaveProdServ="${concepto.claveProducto}" Cantidad="${concepto.cantidad}" ClaveUnidad="${concepto.claveUnidad}" Descripcion="${concepto.descripcion}" ValorUnitario="${concepto.valorUnitario.toFixed(2)}" Importe="${concepto.importe.toFixed(2)}"${objetoImpAttr}`;
                
                if (concepto.impuesto) {
                    xml += `>
      <cfdi:Impuestos>
        <cfdi:Traslados>
          <cfdi:Traslado Base="${concepto.importe.toFixed(2)}" Impuesto="${concepto.impuesto.codigo}" TipoFactor="Tasa" TasaOCuota="${concepto.impuesto.tasa.toFixed(6)}" Importe="${concepto.impuesto.importe.toFixed(2)}"/>
        </cfdi:Traslados>
      </cfdi:Impuestos>
    </cfdi:Concepto>
`;
                } else {
                    xml += `/>
`;
                }
            });
            xml += `  </cfdi:Conceptos>
`;
            
            // Impuestos totales
            if (totalImpuestos > 0) {
                xml += `  <cfdi:Impuestos TotalImpuestosTrasladados="${totalImpuestos.toFixed(6)}">
`;
                xml += `    <cfdi:Traslados>
`;
                
                // Agrupar impuestos por tipo
                const impuestosAgrupados = {};
                conceptos.forEach(concepto => {
                    if (concepto.impuesto) {
                        const key = concepto.impuesto.codigo;
                        if (!impuestosAgrupados[key]) {
                            impuestosAgrupados[key] = {
                                codigo: concepto.impuesto.codigo,
                                tasa: concepto.impuesto.tasa,
                                base: 0,
                                importe: 0
                            };
                        }
                        impuestosAgrupados[key].base += concepto.importe;
                        impuestosAgrupados[key].importe += concepto.impuesto.importe;
                    }
                });
                
                Object.values(impuestosAgrupados).forEach(impuesto => {
                    xml += `      <cfdi:Traslado Base="${impuesto.base.toFixed(2)}" Impuesto="${impuesto.codigo}" TipoFactor="Tasa" TasaOCuota="${impuesto.tasa.toFixed(6)}" Importe="${impuesto.importe.toFixed(2)}"/>
`;
                });
                
                xml += `    </cfdi:Traslados>
`;
                xml += `  </cfdi:Impuestos>
`;
            }
            
            xml += `</cfdi:Comprobante>`;
            
            return xml;
        }

        // Funci√≥n para guardar XML en la base de datos
        async function guardarXMLEnBD(xmlContent) {
            if (!currentUser) return;

            try {
                const emisorId = document.getElementById('emisorSelect').value || null;
                const data = {
                    xml_content: xmlContent,
                    version_cfdi: document.getElementById('versionCfdi').value,
                    emisor_rfc: document.getElementById('emisorRfc').value,
                    emisor_nombre: document.getElementById('emisorNombre').value,
                    receptor_rfc: document.getElementById('receptorRfc').value,
                    receptor_nombre: document.getElementById('receptorNombre').value,
                    serie: document.getElementById('serie').value || null,
                    folio: document.getElementById('folio').value,
                    total: document.getElementById('totalValue').textContent.replace('$', ''),
                    emisor_id: emisorId
                };

                const token = localStorage.getItem('cfdi_token');
                const response = await fetch('/.netlify/functions/xmls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('üíæ XML guardado autom√°ticamente en tu cuenta', 'success');
                } else {
                    console.error('Error guardando XML:', await response.text());
                }
            } catch (error) {
                console.error('Error guardando XML:', error);
            }
        }

        // Funci√≥n para descargar XML
        function descargarXML() {
            if (!xmlGenerado) {
                showAlert('‚ö†Ô∏è Primero debe generar el XML', 'error');
                return;
            }

            const version = document.getElementById('versionCfdi').value;
            const emisorRfc = document.getElementById('emisorRfc').value;
            const serie = document.getElementById('serie').value || '';
            const folio = document.getElementById('folio').value;
            
            const filename = `CFDI_${version}_${emisorRfc}_${serie}${serie ? '-' : ''}${folio}.xml`;
            
            const blob = new Blob([xmlGenerado], { type: 'application/xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Funci√≥n para sellar XML con emisor
        async function sellarXMLConEmisor(xmlContent, emisorId, version) {
            try {
                const token = localStorage.getItem('cfdi_token');
                const response = await fetch('/.netlify/functions/sellar-cfdi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        xmlContent: xmlContent,
                        emisorId: emisorId,
                        version: version
                    })
                });

                if (response.ok) {
                    const resultado = await response.json();
                    return {
                        exito: true,
                        xmlSellado: resultado.xmlSellado,
                        selloDigital: resultado.selloDigital,
                        numeroCertificado: resultado.numeroCertificado,
                        emisor: resultado.emisor
                    };
                } else {
                    const error = await response.json();
                    return {
                        exito: false,
                        error: error.error || 'Error desconocido en el sellado'
                    };
                }
            } catch (error) {
                console.error('Error en sellado:', error);
                return {
                    exito: false,
                    error: 'Error de conexi√≥n durante el sellado'
                };
            }
        }

        // Funci√≥n para mostrar informaci√≥n del sellado
        function mostrarInfoSellado(infoSellado) {
            const infoDiv = document.getElementById('selladoInfo') || crearDivInfoSellado();
            
            infoDiv.innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <h4 style="color: #155724; margin-bottom: 10px;">üîê Informaci√≥n del Sellado Digital</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; font-size: 14px;">
                        <div><strong>Emisor:</strong> ${infoSellado.emisor.rfc} - ${infoSellado.emisor.nombre}</div>
                        <div><strong>Certificado:</strong> ${infoSellado.numeroCertificado}</div>
                        <div><strong>Sello:</strong> ${infoSellado.selloDigital.substring(0, 20)}...</div>
                        <div><strong>Estado:</strong> <span style="color: #28a745;">‚úÖ Sellado V√°lido</span></div>
                    </div>
                </div>
            `;
            
            infoDiv.style.display = 'block';
        }

        // Funci√≥n para crear div de informaci√≥n de sellado
        function crearDivInfoSellado() {
            const infoDiv = document.createElement('div');
            infoDiv.id = 'selladoInfo';
            infoDiv.style.display = 'none';
            
            const xmlOutput = document.getElementById('xmlOutput');
            xmlOutput.parentNode.insertBefore(infoDiv, xmlOutput);
            
            return infoDiv;
        }

        // Funci√≥n para limpiar formulario
        function limpiarFormulario() {
            // Limpiar todos los campos del formulario
            document.getElementById('serie').value = '';
            document.getElementById('folio').value = '';
            document.getElementById('emisorSelect').value = '';
            document.getElementById('emisorRfc').value = '';
            document.getElementById('emisorNombre').value = '';
            document.getElementById('emisorCodigoPostal').value = '';
            document.getElementById('emisorRegimenFiscal').value = '';
            document.getElementById('receptorRfc').value = '';
            document.getElementById('receptorNombre').value = '';
            document.getElementById('receptorCodigoPostal').value = '';
            document.getElementById('receptorRegimenFiscal').value = '';
            document.getElementById('usoCfdi').value = '';
            document.getElementById('formaPago').value = '';
            document.getElementById('objetoImp').value = '';
            
            // Limpiar conceptos
            conceptos = [];
            conceptoCounter = 0;
            renderizarConceptos();
            actualizarTotales();
            
            // Limpiar formulario de concepto
            limpiarFormularioConcepto();
            
            // Ocultar XML y bot√≥n de descarga
            document.getElementById('xmlOutput').style.display = 'none';
            document.getElementById('btnDescargar').style.display = 'none';
            xmlGenerado = '';
            
            // Reinicializar fecha
            inicializarFecha();
            
            showAlert('üßπ Formulario limpiado', 'info');
        }
    </script>
</body>
</html>
